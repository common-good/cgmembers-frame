2021-04-20 feature/qr-test
. added a test step to make sure the generated QR in showqr is what it should be
. fixed bugs in cardCode related to admins not having an agent code for accounts they manage

2021-04-17 feature/ach2
. adjusted achify to handle BS&L
. admin deposits form no longer offers option to print new checks or show filename of ACH file
. clarified in verifyid that other options are possible, by moving the link to the SSN line
. wrapped suffixes in a div and made them automatically indent 5px
. changed QR logo to a square one and fixed link bug
. clicking on logo now goes to promo site
. for cAdmins added a button to copy email subject to clipboard ("your Common Good account (WHATEVER)")
. fixed bug in card scan that failed to show scanner name when done

2021-04-17 feature/ach
. generalized admin-achify.inc to handle an arbitrary bank
. modified migrations to handle latest version of phinx (even though we're not updating it yet)
. fixed bug in card.inc that treated disconnect operation as a hack attempt

2021-04-12 feature/signin-to-scan
. changed menu so scan-qr works without sign-in
. minor formatting improvements
. switched order of amount and purpose on card transaction page

2021-04-11 feature/signin-to-scan
. card scan (or card scan disconnect operation) end by showing a scan-again button

2021-04-08 feature/signin-to-scan
. used first() and then() functions to force signin for first web-based card scanning
. reworked card.inc accordingly to handle choice of account (if the person has more than one)
. summary page no longer asks for confirmation of helper (which was annoying)
. made a "...completes..." step function to replace "...confirms..."
. improved the way first/then is handled in tests

2021-04-05 feature/signup-to-pay
. renamed summary feature to dashboard
. w\first() function to signin or signup then do something, and related w\then() function and weFirstThen() step function
. totally rewrote logic of card scan with standard QR reader, to require sign-in (once)
. made buttino function for tiny buttons
. added expedite feature for admins on bank transfer page
. fixed bug that kept admins from updating fields on summary page

2021-03-29 feature/showqr
. don't show qr unless member has completed steps for a Common Good card

2021-03-25 feature/qr
. added Show QR (using endroid QR) and Scan QR (JS-based) to dashboard
. added generalized question-mark help button feature: w\qBtn($topic), typically in a field suffix() with helpModal in footer
. fixed bugs in statements showing fiscal year or quarters
. added checks for ophaned tx entries or hdrs to sanityCheck function
. deleted "deleted" tx_entries_all ids: -314085, 314085, -314088, 314088, -314091, 314091, -314094, 314094, -314096, 314096, -314099, 314099, -314101, 314101, -314103, 314103, -314105, 314105, -314107, 314107, -314109, 314109, -314112, 314112, -314114, 314114, -314117, 314117, -314120, 314120, -314123, 314123, -314125, 314125, -314127, 314127, -314130, 314130 on production server (extraneous food fund donations)

2021-03-20 feature/view-credit
. improved company view of store credit and added a test for that
. limited number of results on admin followup page
. fixed the subject of the account approval email message
. community admin with a company in another CGC can now get to that company
. bug fix: button-maker now properly gives an option for donating to a CG-owned company
. eliminated Sunset Park Solar name from anything displayed to member (at Co-op Power's request)
. bug fix: qid is no longer displayed in helper input field for admin on summary page

2021-03-14 feature/cgpay-expires
. added expires parameter to CGPay interface

2021-03-14 feature/noc4c
. prevent buying store credit with store credit
. bug fix: maximum rebate is now limited to price
. cancelation of a store credit purchase now cancels the rule
. bug fix: disputes failed, clicking X on txs page
. fixed want/got order in some testing functions
. disputed tx#s are now highlighted red
. fixed bug: TX_FLAGS was missing a lot of entries
. fixed bug: X now shows up for seller for disputed txs
. added verbose flags to testing

2021-03-13 feature/prefs
. moved debtOk question out of advanced, disabled if no refill
. improved description of nosearch bit
. added missing jquery-ui CSS images

2021-03-13 feature/fix-tx
. fixed Pay and Charge JS

2021-03-12 feature/fix-cron
. bug fix: biggies didn't call queueNext()
. added optional comment to cc donation
. fixed missing jquery CSS image
. each interface now logs to its own directory
. disabled logging of SQL
. fixed bug in ajax that made account selection fail
. added option to donate by credit card to our food fund donation page (cgpay)
. added option for admins to create a donate-to-CG button on the cgbutton page

2021-03-11 feature/who-tweaks
. restrictions on account choices are now handled consistently and well
. improved which modal format

2021-03-10 feature/find-anyone
. completely revamped the way account lookups work, for beauty, speed, and finding anyone anywhere (using hidden whoId field)
. we are no longer notified of new members (happens too often)
. account field in panel now defaults to current account
. fixed bug: crashed when disputing a tx by clicking X on the txs page
. stateNum() now returns false if not found (instead of the argument)
. added a test for ajax (to make sure it compiles at least)
. partner signup never crashes now (softErr instead)
. admin dashboard focuses on note field
. pay/charge page focuses on who field
. cron biggies report no longer includes canonic accounts

2021-03-03 feature/immediate-credit
. members now get $200 immediate credit if SSN is valid (25 for alternate IDs)
. newly activated account gets funded immediately up to that creditline, if possible
. Helga's now gets an emailCode on demo server
. CGPay form no longer greets "Common Good Member", so not-yet-signed-up people will feel welcome also

2021-03-02 feature/cgpay-bugs
. bug fix: in button creator, changing link text now works
. fixed order of fields in cgpay form
. bug fix: sign up button now shows on cgpay form

2021-03-01 feature/1099-again
. refactored 1099s
. fixed a couple little bugs
. admin gets a daily email with transaction totals over $1,000
. co phone orders now include company name!

2021-02-25 feature/go-dft
. bug fix: changed all go('') to either softErr or go('dashboard')
. bug fix: null object in u\getLocus()
. bug fix: (finally!) root goes to signin

2021-02-25 feature/cred-link
. added a link to credits and discounts on dashboard
. mentioned this in the email to the member who gets a credit

2021-02-25 feature/1099-nec
. added 1099-NEC functionality
. fixed jsonize bugs (from cgpay feature), including u\getLocus bug
. fixed partnerErr reporting
. fixed tellAdmin on cross-site ajax

2021-02-21 feature/accredit
. added an "accredit" page for companies to give a customer a credit
. organized coupons menu page to separate giving from receiving
. fixed a couple bugs that prevented store credit from showing up on discount/credit list for company or customer

2021-02-20 feature/signed
. fixed bug that left signed and signedBy fields unpopulated
. fixed bug in co-list that used old pay-with-cg button instead of new cgpay button

2021-02-18 feature/cgpay
. redesigned and recoded cgpay so it can be a single step after designing on the cgbutton page
. created jsonize and dejsonize to standardize the options (handling UTF8)
. refactored out parsing URL parameters in tests
. changed cryRay to json encode instead of serializing
. decryRay now returns NULL on error instead of crashing (decry throws BadCry)
. added clues to admin about which accounts are active and have a connected bank on recurring page
. modified cgbutton form to create button code and HTML for most common use cases
. fixed bug that sent members to root (signout / signup) after completing a form

2021-02-12 feature/buy-credit-discounted
. added a CGPay button feature to allow companies to sell store credit at a discount
. CGPay transactions are now flagged as "button" purchases (TX_BUTTON flag)

2021-02-07 feature/tweaks
. fixed bugs in signup / notfound / empty URLs

2021-02-07 feature/agree-step
. added country field to signup, investment interest, and contact settings so Canadians can sign up (using a US bank still)
. fixed bug that let a user create a personal account while signed in to a company account -- messing things up
. email is now allowed to a closed account if (and only if) it's to reset a password
. fixed bug that discarded rendered amount field in an item() in buy.inc
. fixed bug that prevented normal cgpay button from working with for=other
. company code can now be lowercase for cgpay button
. added print card button to photo page (for admin)
. relations are now allowed only with active accounts

2021-02-03 feature/cgpay-json
. added immediate json return option to CGPay interface (and updated documentation)
. changed console page name to Dashboard
. bug fix: underage bit now gets updated when dob changes
. bug fix: link on dashboard to allow negative balances now works
. bug fix: going to root redirects to signup page
. added signin option to signup page
. bug fix: credit line is now not mentioned in notices to underage accounts
. fixed some errors in migrations identified by newer MariaDB (mostly null keys)

2021-01-31 feature/copy-email
. added a button for admin to copy account name and email to clipboard

2021-01-30 feature/cgbutton
. changed CGPay to always ask for user's password instead of sending an invoice for confirmation

2021-01-30 feature/message
. added encryption option to Message a Member feature
. fixed a couple bugs in permissions for superAdmin
. all cookies are now deleted when clearing for tests
. fixed bug in SNAP tx reporting
. added a standard time function in utils
. footer is suppressed for card scans
. fields with suffixes now default to short and inline-block
. fixed bug in signup for people who found us through investment club express-interest form
. solarOne errors now act like other partner errors (not fatal)
. added signup option on signin page
. fixed bug in message reporting change in recurring tx
. made a model .feature test file
. made a shorter version of the "member confirms" step function syntax
. boxUser function now updates channel

2021-01-18 feature/proxy-zips
. seedpack nearby proxy choices now show up even if city is misspelled

2021-01-18 feature/api-pw
. companies now use the emailCode as their password for /api
. bug fix: signup page now defaults to current user's data and the link to that signup step is correct
. fixed bug in risk recalculation
. fixed bugs in lastTx and refactored it

2021-01-02 feature/bugs
. new community notices are now set to seldom
. fixed bug introduced in cc feature that screwed up croppic
. fixed CSP nonce in boot.inc
. fixed formatting of notices so there's room for the bullet and the date
. fixed broken gift certificates and reformatted somewhat
. fixed bug that didn't give email click donations option for one-time gift

2020-12-30 feature/disconnect
. when a device is associated with an account, to scan customer cards, a "Disconnect Device" choice appears on menu

2020-12-29 feature/invest-amt
. invest/interest form now asks for intended amount
. email links to donate from inactive account now redirect to cc donation

2020-12-29 feature/cc
. fixed goods and services posts, which were labeled backwards
. nonudge people are now included in newsletter list
. added a cc page for credit card donations
. created a postnGo utility function to redirect and POST at the same time
. fixed bug that set signup step done for investment club interest
. nonmember clicking donate link from email now goes to cc form
. refactored w\captcha to return fields rather than values and added a badCaptcha validation function

2020-12-27 feature/smart-undo
. fixed warnings about missing params in rsmart charge()

2020-12-27 feature/bugs
. fixed some undefined variable warnings
. donation attempts by nonmembers now encourage the person to sign up
. agent form now facilitates conversaion from mistaken personal account
. fixed undefined function bug in recurring donations
. posts can now default to a community by specifying a zip in URL
. fixed bug in posts that showed all posts to everyone
. tip posts are now shown only where they are intended (like offers and needs)
. fixed bug in unjoin that allowed a zero transaction

2020-12-20 feature/survey
. handling one-click investment club survey responses

2020-12-06 feature/old-app
. fixed old-app message in rsmart.inc
. added info to gift alert to admin

2020-12-03 hotfix/recur
. fixed bug that stored wrong value for recursId in recurring transactions

2020-12-03 feature/by-name
. fixed bug that didn't allow pay by name within same community if latitude or longitude was wrong

2020-12-01 feature/pgp-device-id
. encrypt device id with pgp private key in smart.inc, so it is provably from us (demo site must use same key)
. fixed log bug in errors.inc
. moved makeDevice from cg.inc to acct class, as makeBox()
. bumped expected POS version to 230!
. added version to r_boxes, to track latest app version each device is running

2020-11-29 feature/demo
. rewrote makeTestAccounts to create test accounts from scratch instead of counting on copies of production accounts
. vKey() now returns '' (non-fatal error) when superAdmin is not the user (shouldn't happen, but better not to crash there)
. u\bits() now also performs its reverse function
. fixed typo in formMakeCtty()
. we no longer try to show altId to admin (only superAdmin)
. made phinx config files more consistent (online), including renaming user/database new-demo to new_demo for MB migration
. better handling of SwiftMailer errors
. fixed but in encryption: encrypting numeric failed

2020-11-24 feature/cttys
. moved and enlarged community zip regex to r_company table by renaming serviceArea to zips
. similarly enlarged and renamed zip field in r_regions
. moved formMakeCtty to its own file in forms/

2020-11-24 feature/ctty-loc3
. ask for geolocation permission only on mobile

2020-11-23 feature/ctty-loc
. in posts.inc, default to showing current community posts
. in posts.inc, get GPS data when user clicks Where
. pages no longer cached on dev machines
. fixed snap tx reporting bug
. fixed warning in qo.class driven by hack attempts

2020-11-19 feature/txret
. refactored transaction functions to return a txRet object
. fixed bug in error reporting on dev machines (now shows full trace reliably)
. fixed bug in disconnect from bank account that tried to encrypt empty string
. fixed several bugs in the draw feature (especially for joint accounts) and fixed production data
. we now send an alert to admin whenever a snap purchase is made
. Pay page now uses acct::payApproved(), so payments are successful even when they can't go through yet
. fixed a really nasty bug that stored recursId in tx or invoice record with that numeric record ID value
. we now warn admin if crumbs fail

2020-11-10 feature/api-q
. api function now expects "?" instead of "/" (standard GET query)
. fixed bug in handleinvoice.inc that notice'd zero as the invoice amount when withdrawn or denied
. fixed bug in api feature that showed page instead of exiting with message
. reduced number of lines of code
. we can now handle more than one test that gives an exit message, in one run
. fixed formatting of periods on pay and charge pages

2020-11-10 feature/cancel-inv
. invoices are now canceled, not deleted (and fixed bug that prevented it)
. other person gets a notice when a delayed payment is created
. don't mention card in Finish step if they already have it
. simplified how goback button works (

2020-11-04 feature/cgpay-fix
. fixed "missing code" error on simple cgpay button
. fixed formatting on CG Button form
. fixed language on steps on (admin) summary page
. disallow self ZAP with negative balance or approved invoice

2020-10-31 feature/goto-biz2
. fixed bug that kept people from going to their company account
. don't force individuals to type a zero for crumbs
. added a helpful message when vKeyE cookie is not found
. added more restrictions to license - it now requires registration and public description of any changes

2020-10-30 feature/cooppower-ape
. added community solar contracts for ape-ev and ape-ng
. fixed formatting of console page

2020-10-29 feature/reopen
. Reopen link now works
. shortcuts on console always show now when appropriate

2020-10-29 hotfix/verifyid
. Next/Finish button is now shown properly on verifyId report

2020-10-28 feature/short-signup
. individual signup is now pretty short, with optional longer signup to get a card
. don't talk about unconfirmed invitations
. underage bit now gets set with dob is set
. better messages in several places, including for completion of steps
. accounts are activated automatically when possible
. improved formatting of Offers & Needs on narrow mobile screen
. moved agreement to first signup page
. connecting a checking account is now required (unless you ask for an exception)
. donation period now defaults to year
. proxy step now goes right on to next step when done
. simple addition captcha now on signup page, to cut down on robots
. invoice for company phone is now automatically approved
. separated account activation out into separate non-admin file, so it can happen automatically sometimes
. email verification for companies now works even if signed out
. SSN verification is now the default, with other methods hidden unless asked for
. "signup" table is no longer used, since that's almost all we ask for on signup page
. handle '?' in redirected URLs in tests

2020-10-23 feature/http-headers
. changed HTTP page headers to prevent caching on all modern platforms

2020-10-22 feature/partial2
. handle reporting of partial transactions

2020-10-20 feature/partial
. handle partial payments of invoices
. uncache submenus on account selection

2020-10-18 feature/no-bank
. keep "Bank" off the menu
. moved menus out of rweb.module into rcredits.module
. moved most menu code to a separate file and cached most submenus
. changed __DIR__ . '/../ to R_ROOT . '/
. rebuilds menus automatically on boot, if menu_links has been deleted (to force recreation)
. access function moved to cg.inc
. nni() now accepts objects
. fixed warning in u\getLocus()
. fixed warning in admin panel

2020-10-15 feature/tweaks
. suppress in-your-face endorsement ask on console page
. better handling of errors in account change
. minor fixes

2020-10-14 feature/touchup
. set collation so mb4 actually works
. fixed password strength meter to reasonable behavior

2020-10-14 feature/pw3
. minor tweaks to pw feature

2020-10-13 feature/pw
. fixed reset-password page (rewrote without Drupal)

2020-10-12 feature/mb4
. convert database to ut48mb4

2020-10-11 feature/format2
. root now goes to console (again)
. Offers & Needs page is now wide (again)
. fixed bug in amtChoice JS
. emailed lists of offers and needs now include links to post one
. pages now default (again) to labels "above" on mobile
. moved tx option buttons to above Submit

2020-10-09 feature/console-fix
. charge now works right

2020-10-09 feature/relations-fix
. newPerson now works and looks good on mobile

2020-10-09 feature/bugs
. patching up bugs from the console-tx feature:
  - transactions now actually work
  - Handy / Rebuild Menu now clears out all rweb menu items before rebuilding
  - some format improvements
  - company query results now show up

2020-10-09 feature/console-tx
. radically revised our strategy for formatting, based on a few standard page formats (wide, nolabs, mlab-above, etc)
. fixed a number of formatting issues (especially for mobile), including check image on Connect page, label length, lists,...
. reduced LINT warnings
. transactions are now activated from the console by JS (to make the common case very fast)
. fixed bug in ajax.inc that crashed cron (wrong function name)
. removed Pay and Charge and Bank from the menu!
. summary page is now for admins only and has a link to the console page
. number of steps remaining is now never mentioned unless it's 1 or 2
. changed admin SQL field on Data page to a textarea
. changed honored field on Donate page to a textfield (not a textarea)
. fixed search field on Posts page so it cooperates with other selectors, Enter works, and there's a clear-search button
. temporarily removed photo from Summary page (difficult to place well)
. pay and charge pages now return to console (for convenience)

2020-10-06 feature/mobile2
. shrink buttons to fit on console page
. no more zero surtx entries
. cron no longer tries to handle "i" (immediate) notices
. improved format on console, card, and "empty" pages
. suppress error on attempt to hack card page (hitting RC2.ME and RC4.ME)
. added accout ID to console page
. fixed bug that got the "next" date wrong on future-starting recurring payments
. changed most "jQuery"s to "$" in scraps.js, in an attempt to fix browser-specific amtChoice problem
. users created by bots are now deleted after a month

2020-10-04 feature/license
. changed license to reserve all rights except for intended use

2020-10-04 feature/mobile
. created a new mobile-friendly Console page to replace Summary (except for admins)
. moved qr() function from qo class to admin.inc
. fixed Qo::qr2() function so it works (previously unused, now used on Card page)
. added "trust" and "qid" cookies, so user can sign in automatically and stay signed in
. iPhone users (and anyone with a device that scans) can use a standard QR reader app to scan a Common Good card!
. added Type dropdown to posts page, and colored posts green/blue/orange
. fixed formatting of advanced buttons on Tx page
. form Empty now displays a blank title (a silver stripe on mobile)
. fixed errors in CSS (http://csslint.net)
. added COVID, BLM, and O&N links to console page
. eliminated "exchange" language, in favor of "transfer"

2020-09-30 feature/invest-interest2
. changed rdo.inc to allow doInvestInterest~ without code (for nonmembers)
. bypassed weird bug that crashed on admin signin, trying to set additional cookies
. changed all instances of /do/ to use the new syntax /do/<op>~<code>

2020-09-30 feature/cookies
. card page now uses cookies to track default account to charge from, default agent, and "trust this device"
. card page: added JS, so the page actually works!

2020-09-29 feature/sweep
. null amount in a "pay" template now sweeps all but the account's target balance into another account

2020-09-29 feature/never
. "never" is now a frequency option for notices

2020-09-29 feature/invest-interest
. revised Invest page, which now redirects to InvestInterest page if signed out or no club in the area
. introduced iclubq bit to track interest in investment club
. reversed transactions now appear simply as (reverses tx #whatever) -- no description
. \n is now accepted in test data (meaning EOL)
. changed customer statements "Paid" column to "Credits"
. fixed bug in expected donations query that omitted monthly, weekly, and quarterly donations
. fixed bug in w\eLinkAcct() that caused failure of allow='any'
. zapped B_WEEKLY and B_MONTHLY

2020-09-28 feature/ape
. added an admin function (moveTxsToSubco) to more Co-op Power transactions to a subsidiary
. partner logos are now stored as the account photo (temporary, pending using SMT for solar signups)

2020-09-28 feature/card
. scanning a Common Good card with a standard QR reader now shows a page that simulates our app (not done yet)
. new u\joinRays function
. fixed qo::qr2() function

2020-09-24 feature/post-expand
. eliminated opening page of Offers & Needs (now shows posts everywhere by default)
. fixed long-standing ugliness in acct::viable() function
. fixed bugs in MakeCtty form (for admin)
. changed shouters (endorsers) list to include website links even on promo site
. fixed crash in justExit

2020-09-16 feature/buy-status
. revised pay-with-cg interface, including adding a "status" request
. fixed a startup bug that didn't recognize flags as a real database field
. improved admin export of SMT data

2020-09-15 feature/partner-bit2
. improved failure reporting

2020-09-07 feature/partner-bit
. replaced list of signup partners with a partner bit
. revised Coop Power's salesforce field names
. solar project is now identified by "name" field of the partner organization's CG account
. renamed nyccec to ssps
. changing a partner fullName now has no effect on its "name" field
. SMT export generalized to include all projects
. fixed bug that kept notices from being sent for not-yet-active accounts
. activated postnotices in cron, with one-time catchup

2020-09-06 feature/post-notices2
. fixed bugs and formatting in post notices

2020-09-05 feature/bugs
. salesforce wasn't getting email and phone for cooppower projects and cg_account field name changed
. addperson button was failing on relations page
. cron was trying to send notices to closed accounts
. help page was getting warnings
. sometimes cAdmin was allowed to create a company account with no manager

2020-09-04 feature/notices
. users can now set frequency preferences for incoming and outgoing transactions and miscellaneous other
. r\notify and r\message are now consolidated ("we tell" in tests)
. fixed bug in scraps.js post-post: clicking "end now" failed

2020-09-03 feature/post-notices
. users can set preferences for frequency of notices about posts

2020-08-26 feature/solar1-2
. added pid parameter to solar1 signup
. solar1 signup now adds people to Salesforce
. crashes in PHP window on dev now report caller
. fixed bug in tx undo error reporting
. fixed bug in acct::hasVSecure by not encrypting (or decrypting) NULL
. fixed bug that miscalculated permissions of agent (preventing tx reversals for example)

2020-08-20 feature/recurring-next
. fixed bug in recurring that showed wrong "Next" date
. suppress "Done!" message for permission changes on relations page
. changed endorsement quote to be an area field with maxlen 4096
. added some security checks for output with e cho, die, and exit

2020-08-20 feature/relations-ajax
. toggles and permissions on relations page now use ajax
. superAdmin can create transactions dated in the past
. acct::hasBank now looks at acct::bankAccount instead of risks bit and risks bit is set automatically
. invitation example now just suppresses CSP style check, not all of CSP
. fixed bug that delete bank connection upon changing settings

2020-07-31 feature/bizlists
. added a test for authcode
. separated out find-co.css for use on promo site

2020-07-25 feature/misc
. fixed message for when maxlen exceeded
. fixed bug that permitted typing past maxlen on textarea fields
. improved error message for when signed-in user tries to sign in
. setting of altId is always recorded as a change, so we know who approved it (security accountability)
. using header instead of drupal_set_header, to fix bug in cgbutton.inc that failed to show what button would look like
. changed first-at-home rule to apply only if SSN check failed -- then must be close to home and in-person
. added u\isMobile() function
. added full-year statement links (for calendar year -- fiscal year works, but has no link)
. now gives a better message for no-longer-valid invoice link
. avoid unnecessary warning for undefined array index in help.inc
. fixed several bug on invite page (thanks to Peg Hall)
. fixed rare bug on relations page (typo)
. improved selection of shouters for admins
. for DOB field on mobile, a long press not converts the field from date field to text field
. added referrer function so tests can detect what page user actually wanted
. improved formatting in invitations
. signout in tests is now more thorough

2020-07-11 feature/export-makeover
. revised admin export member spreadsheet feature to use new rdo format and fewer fields (switching from chimp to mailerlite)

2020-07-09 feature/rdo-makeover
. reworked doCodes and invoicing for greater consistency, ease, and security
. eliminated use of r_do table!
. endorse plea no longer shown for partial members (active accounts with no photo)
. fixed bug that did delayed payments/charges immediately
. fixed bug that scrambled company category choice list
. fixed a couple warnings about undefined variables
. fixed bug in testing that failed to clear dosay files

2020-07-08 feature/findco-tight
. added "nearby" checkbox to findco page

2020-07-08 feature/redirect-new
. fixed bug that gave error on direct access to new.commongood.earth when signed out

2020-07-08 feature/create-migration
. DOS batch file to create migrations according to a model

2020-07-07 feature/renew-backing
. made encryption of data for use in URLs more consistent (replaced makeDoCode and doCode with u\cryRay and u\decryRay)
. db\insert, db\update, and db\updateOrInsert all now default to key='id'
. members now receive an annual email asking them to renew their backing (it renews automatically if they don't act)
. cleaned up top of cron.inc
. added a couple invite reminders
. added tracking to annual emails and periodic notices

. deleted unused Drupal files:
  - *.install
  - mail.inc
  - user.admin.inc
. deleted unused Drupal functions:
  - user_authenticate
  - user_external_login_register
  - user_user_operations_unblock
  - user_user_operations_block
  - user_multiple_role_edit
  - user_block_user_action
  - user_help
  - user_field_info_alter
  - user_field_extra_fields
  - user_external_load
  - user_login_finalize
  - user_load_by_mail
  - user_load_by_name
  - user_validate_picture
  - user_role_permissions
  - user_login_name_validate
  - user_login_default_validators
  - user_login_final_validate
  - user_mail (and related functions)
  - user_role_load (and related functions)
  - user_filters
  - user_roles
  - user_login (dies)
  - system_mail
  - system_send_email_action
  - system_send_email_action_form

2020-07-06 feature/inv-security
. fixed a bug in invoicing that could have allowed anyone to approve payment of an invoice

2020-07-06 feature/misc3
. changed w\changeWho to report hack when someone tries to change to an account they don't have permission for
. improved appearance of endorse popup on Summary page
. improved functioning of shouters list for admins
. change-account now allows page arguments
. made some array initializations explicit

2020-07-05 feature/misc3
. fixed errors from several previous features
. renamed tellCo to tellCAdmin
. fixed default for function u\padRay
. added a check in ajax.inc for cross-site call
. improvements to shouters lists
. gave admin view of DOB if not active yet
. improved Endorse button appearance in emails
. deleted some unused Drupal functions and files:
  - block_menu
  - _menu_site_is_offline
  - _block_themes_access
  - menu_form_node_form_alter
  - system_admin_config_page
  - system_modules
  - user_file_download
  - hook_query_TAG_alter
  - _system_themes_access
  - system_custom_theme
  - hook_user_cancel_methods_alter
  - hook_user_view
  - user_search_access
  - user_search_execute
  - user_account_form
  - user_block_view
  - template_preprocess_user_picture
  - user_view_access
  - user_edit_access
  - user_cancel_access
  - user_menu_site_status_alter
  - user_role_edit_access
  - user_user_operations
  - user_admin_account
  - user_build_filter_query
  - user_register_form
  - user_save
  - user_delete
  _ user_cancel

  - user.pages.inc :
  - block.test
  - user.test
  - block.admin.inc:
  - modules/user/*.tpl

2020-07-03 feature/push-endorse
. deleted some unused things from .gitignore and rcredits/.gitignore
. fixed a couple undefined index warnings
. fixed bug that kept text button from showing as button on cgbutton page
. added bullets to weekly and monthly email statements
. added ratings to shouters and a way for admin to bump them easily or edit the quote
. added a request for a raw list of shouts to use on promo site
. fixed text on connect page
. clarified endorse page
. fixed expiration bug in rdo
. fixed bug that disallowed amounts over 100 on stepup page (for non-percents)
. added popup endorse button on Summary page
. fixed bug that suppressed DOB on Summary page for non-super admins
. added endorse or invite button to notices
. added highlighting to help developers when CSP catches something

2020-06-30 hotfix/export-firrstname
. added firstname and lastname to mailchimp export

2020-06-30 hotfix/invite-link
. changed invite link from promo site to member site (bug fix)

2020-06-27 feature/move-change-uid
. moved changeUid function to admin and made deleteUid work when account is current
. suppressed submit-on-Enter on Summary page

2020-06-26 feature/sellcg
. ask in company signup whether they want to sell CG
. fixed bug that kept tellAdmin from sending right replyTo address
. fixed bug that kept accounts from being deleted when they had a rule or template

2020-06-25 feature/misc2
. unset account fields now generate a warning
. fixed some undiscovered bugs (from the new warnings)
. fixed formatting on AltId and Tickle
. improved unsubscribe page to give choice boxes
. fixed bug in endorsement (if member submits without saying sign or not sign)
. added alert to CO to deliver a phone
. flipped ownPhone (in signup-co.inc) to needPhone, to avoid invoice denials
. fixed risks test
. automated renaming of photo ID files on change of account uid

2020-06-23 feature/misc
. fixed bug in photo.inc so company photos now resize properly
. fixed bug in photo.inc croppic.js javascript to display error messages properly
. unsubscribe ZAP notes (any anonymous notes) are now labeled as "self"
. SSN verification now uses Curl, to accommodate file_get_contents's inability to handle SSH on our new server
. fixed display of DOB, Alt ID, etc.
. added a flip bit so companies can choose between a Donate button and a Buy Credit button
. fixed several small bugs that generated warnings and display anomalies
. fixed bug in Actual Donations to CG query

2020-06-17 feature/config-models
. created better models for config files and documentation for their values
. created (partially tested) .sh versions of batch files for recreating database and phinx commands
. deleted some unneeded files

2020-06-17 hotfix/typos
. fixed a typo causing partner signup to fail
. reversed a change in rcron handling of acctRisk (that failed)
. fixed error in forms.inc that tried to trim arrays

2020-06-15 feature/tidy
. input is now always trimmed except passwords
. formPhp error handling simplified
. bug fixed in checking for not underage in formAdminPanel
. crumbs removed from prefs (now just in standalone page)
. unused catches removed
. poBox risk check fixed
. account risk tests separated
. bug fixed in company photo sizing
. warnings fixed

2020-06-13 feature/handle-errors
. revamped error handling so:
  - on production all errors generate an email to admin, user sees a friendly apology on fatal error, otherwise nothing
  - on dev all errors die with stack trace, except from PHP window where the error is displayed without a stack trace
  - errors and exceptions are handled in a single function in errors.inc
  - even warnings are errors

2020-06-13 feature/no-at
. replaced most @-sign error suppression with try blocks and nn() and nni()
. exempted formPhp from crashes on error

2020-06-10 feature/verifyid-fix
. require dob no matter how ID is verified (so bug fix of spurious warning is moot)
. warnings now cause fatal error
. fixed bug in verifyid that forgot to ask for legalName

2020-06-09 feature/findco-redo
. revamped find-co to handle state/region selections better
. fixed spacing on shouters.inc
. added "building" to u\getLocus
. fixed bug that returned FALSE instead of empty array in be\getTxs()

2020-06-08 feature/invite-overhaul
. added button on admin panel to send data to SMT
. restricted access to food fund for new recipients to future rules
. added sawVideo bit to shouters
. it asks now why not if a new member won't endorse
. simplified invitation process and improved invitation form, including a working link for "unsubscribe"
. we now ask why when someone clicks unsubscribes, and mark them "ZAP" automatically
. began a page for links to email CG

2020-06-04 hotfix/text-fieldlen
. added a failsafe to db\del to complain about a call like db\del($tnm, 3);
. changed default fieldlen for text fields to 4096

2020-06-01 feature/stepup-dup
. fixed bug that restarted recurring donations on submission of stepup
. made stepup callable without signing in
. fixed transaction row coloring
. moved stepups to community menu

2020-06-01 feature/bugs
. simplified be\getTxs to use txs instead of tx_hdrs and tx_entries
. removed time limit on 50% (instead of 100%) portion for Buy Credit templates
. finally fixed bug that left tx history columns askew when a multiline description was followed by a surtx

2020-05-31 feature/invite-all
. finished preparing invite page for appeal to members, etc.

2020-05-31 feature/little-stuff
. fixed bug that showed step-ups on discounts list
. added asof field to mailchimp export, so we can be sure something goes only to members
. fixed exception handler so no white screen of death
. added usePhoto to public invitation form and changed the quote to "Common Good could have a huge positive impact..."
. added "region" to backing page text
. fixed bug that showed error message in contact form for Co-op Power members
. discounts available to you now shows "you+" when appropriate, instead of "anyone"
. specifying drivers license now completes verifyid step

2020-05-27 feature/exceptions
. added backslash before "Exception" in non-working catches
. unsent notices are no longer marked sent

2020-05-26 feature/fixes
. admin visits no longer change access time of accounts
. TEST_INVITE_KEY is now used when testing
. bank transfer cancelations are now handled more elegantly
. preferences page no longer complains about null crumbs
. recurring transactions no longer replace other recurring transactions

2020-05-25 feature/photo-permission
. we now ask inviter whether to use their photo in a collage

2020-05-25 feature/periods
. pay and charge pages now allow specification of start and end dates and multiple periods
. fixed bug that deleted templates on update of a recurring payment or invoice instead of just marking it end'ed
. fixed bug that treated intFld like numFld
. fixed bug that showed an error meesage for bool fields on prefs page

2020-05-24 feature/crumbs-tweak
. made crumbs a separate settings page
. minor changes to 1099 text
. added "contactable" to work.inc
. users can now cancel any transfer that hasn't gone through yet
. disabled secure file attachment in help.inc and fixed reporting
. fixed bug that gave a warning in tx.inc
. fixed bug that prevented chart help from working
. fixed bug in t\pageForm that died when an empty array is returned by \menu_execute_active_handler (eg from couponsprint.inc)

2020-05-13 feature/step-bugs
. fixed bug in work.inc that omitted "Next"
. fixed bug in stepup.inc that failed to delete dangling invoice when terminating a recurring donation
. added "invite someone" to our response to covid-19

2020-05-12 feature/alt-id
. created field and input methods for drivers license

2020-05-11 feature/please
. fixed stampNote bug and moved it to cg.inc
. created shouters table, invitations, list, and test
. expanded interface to u\ray2row()
. fixed bug that suppressed "Next" button on proxies page so nebies couldn't finish signing up
. stepups page now shows only local organizations and CG and Food Fund

2020-05-07 feature/no-invnum
. invoice numbers are no longer stored in payment transaction description
. fixed bugs in intFld calls (can't format the field with dollar signs and commas)
. fixed bug in routingFld that forbade first digit zero

2020-05-04 feature/txs-hist
. moved transaction description details for recurring and surtx transactions to the be\getTxs()
. fixed formatting of transaction history (especially on mobile)
. added odd and even green lines to transactions
. switched order of balance and amount on mobile so balance appears at top
. fixed bug that left 2 invoices when not-yet-member donates and/or steps up twice

2020-05-04 feature/company-menu
. minor cleanup
. date fields defaults now get formatted in fld()
. fixed tests to accept yyyy-mm-dd format for dates that are actually mm/dd/yyyy (to accommodate quirk in input type="date"
. buy-with-cg form is now full size, not a popup
. created a "buy credit" page
. made a company menu
. changed buttons on home page to "shortcut" links
. moved stepups to community menu
. reordered community menu
. fixed bug that put log file in the wrong place when running cron
. moved cgbutton to company menu
. fixed bug in cron that failed to continue after recurs()

2020-05-01 feature/cleanup2
. fixed risk tests (finally)
. got rid of account-specific transaction ids (tids)
. lack of an account for Common Good no longer kills tests on first run after recreating database
. got rid of relType and relatedId in transactions
. made tests independent of config.json settings
. zapped be\accountName function
. cleaned up startup db

2020-04-30 feature/db-del
. revised db\del() so it handles deletions of txs and r_usd, including all related transactions
. fixed bug in rcron that (mis)handled alread-ended templates
. allow longer SQL queries for admins

2020-04-29 feature/stepup-fixes
. interpreted coTypes in tests
. changed forever to once in "pay" and "charge" templates
. fixed bug in stepups that showed everyone every recurring transaction from anyone to anyone, with all the details
. fixed bug in stepups that didn't record change to recurring donation properly
. added recurring transactions to Charge page
. disabled cron running between 2:40am and 2:44am (swiftMailer crashes at 2:42am)

2020-04-29 feature/input-types2
. reverted a couple minor things
. added comments to tests for MariaDb10.4 changes

2020-04-28 feature/recurs-central
. moved r_recurs records into tx_templates and revised code accordingly

2020-04-27 feature/input-types
. made use of HTML3 specialized input types (number, tel, etc)
. fixed typo bug in acct::needsSsnFor()
. miscellaneous cleanup of calls to field functions

2020-04-23 feature/donation-tweaks
. Added option for recurring donations to stepup page
. For active accounts, completion of a "step" redirects to the same page instead of summary page
. acct::activated0 is no longer used (no automatic deactivation and acct::activated is always the first activation date)
. added si function for assigning into a character array
. added classes parameter to u\ray2row()
. changed to a single "Buy Credit" or "Donate" button on findco page
. invite step can be skipped
. select fields can default now even when rendered with w\rendA()

2020-04-20 feature/store-credit
. skipping stepup step no longer adds it to the end of stepsLeft
. fixed bug that formatted $1.50 as $1.5
. implemented purchases of store credit for oneself and others
. changed a lot of defines to const (especially in defs)
. admin mysql query box is not textFld not areaFld (easier to submit)
. my stepup organizations now appear as text not as text boxes
. fixed bug in formAccountPhoto that kept icons from showing up in business listing on promo site and in findCo
. added Buy Credit, Buy Gift, and Pay/Donate buttons to the Find Company page (and our promo site)

2020-04-17 feature/post-specifics
. revised u\fmtAmt to allow simple percentages
. bracketed geo request in try()
. posts and post messages now include city, state, and miles away
. changed a lot of define()s to consts
. added a standard 3% stepup description for testing and as a model for tx descriptions
. posts now show whether the poster is a member

eachA(function ($a) {
  if ($a->food > 0 and $a->ok) {
    $uid = $a->id;
    if (db\exists('tx_rules r', 'r.from=' . $uid)) {
/**/  debug("RULE $a->fullName: $a->city $a->zip $a->food");
    } else {
      $descCrit = "(description LIKE '%\\%%' OR description LIKE '%early June%')";
      $start = db\min('created', 'txs', "uid1=:uid AND " . str_replace('description', 'for1', $descCrit), compact('uid')) ?: ($a->activated ?: $a->created);
      $purpose = 'donation (' . u\fmtAmt($a->food, '5%s') . ' food step-up)';
      $info = ray('action from to amount portion purpose payerType payer payeeType payee start', 'surtx', $uid, 26742000000672, 0, $a->food, $purpose, 'account', $uid, 'industry', 2, $start);
      $rule = db\insert('tx_rules', $info);
      db\q("UPDATE tx_entries_all e LEFT JOIN txs t ON t.eid = ABS(e.id) SET e.rule=:rule WHERE t.uid1=:uid AND t.uid2=26742000000672 AND $descCrit", compact(ray('rule uid')));
    }
  }
});

2020-04-15 feature/surtransactions
. stepup maxes are now handled right, rather than like food fund max
. start fields default to now
. simple string constants are now automatically quoted in SQL statements
. ACT and REF strings are now represented by constants
. cron tests for generating rules, txs, and invoices from templates
. all references to time() are now now() instead
. newbs can now be invoiced in cron before confirmation
. improved analysis of failed verifyRecord in tests

2020-04-14 feature/surtransactions
. fixed some bugs in gift certificates and discounts
. giftPot now restricts the amount a gift certificate recipient can cash out

2020-04-12 feature/surtransactions
. created stepup, groups, and rules pages
. admin can now see all active posts regardless of distance
. changed field names in tx_rules and tx_templates to agree with design (fromId => from, toId => to)
. rendA'd fields can now default
. bank accounts in deposits are now always the latest and any errors alert admin
. removed an unused parameter from cgForm
. changed from and to in tests to payer and payee (because tx_rules has from and to fields)
. changed u\urlq2ray to handle unicode encoded query lines (happened once -- probably from protonMail JS)
. changed enum fields in tx_rules and tx_templates to strings to simplify code
. renamed some fields in tx_rules and tx_templates
. disabled request to confirm old post or message in posts.inc (unneeded and counterproductive)
. fixed bug in posts that crashed on replying to a post as a new user
. tests now correctly populate forms that have default values
. fixed u\where function so it handles fields with reserved names
. refactored coupons.inc to consolidate duplicate code
. improved distance handling in posts
. fixed bug in email confirmation
. all forms now focus on first field
. added (string) has() function in misc.js
. displayName now defaults in posts
. moved crumbs to separate step
. forms that populate fields with JS can now be repopulated correctly on error, using w\er()
. cleaned up util.in in migrations, so new tx fields get included in txs, etc.
. removed restriction that accounts cannot receive rebates without "sell" permission
. members now cannot transact so much that a 1099 is required (when they haven't supplied an SSN)
. fixed bugs in work.inc

2020-04-09 feature/ontadmin
. added community admin (oadmin) feature to posts

2020-04-06 feature/post-touchups
. added mileage to posts
. bug fix: admin edits no longer unset confirmed
. bug fix: distance restriction now works right in post selection
. fixed bug in post validation

2020-04-05 feature/post-tips
. beginnings of showing selected items in tests
. added tips to offers & needs
. fixed bug that showed closed accounts in adminFollowup
. moved location function to acct class
. added magnifier button to posts search box
. added defaults to post input and edit pages (including for members)
. removed or revised some post categories

2020-04-03 feature/bugfixes
. moved all possible strings to cg-strings.inc
. cleaned up some test messages and w\go() logic
. fixed bug that shows "Finish" command for accounts with no steps
. fixed bug that closed account when user clicks Finish
. fixed bug that did empty geosearches
. fixed bug that exposed our geosearch key on error
. fixed bug that dies on submission of posts form when no JS
. improved posts messaging
. fixed bug that disallowed decimal point in cgbutton form

2020-03-30 feature/post-bugs
. arguments carried from one form to the next are now urlified
. we now handle same email from different device (and by extension, new email from same device)
. admins cannot put a semi-colon in the SQL box (security)
. admins can see unconfirmed posts (but cannot confirm them)
. hits and contacts are tracked

2020-03-29 feature/post-memos
. posts are now shown as postit (memo) notes by default
. category selectors are integrated into tabs
. fixed bug in findco (ancestors view)
. simplified calls to lnk, btn, atag, and atagB when passing just id

2020-03-28 feature/post-moderate
. added optional required-moderation for certain 3-digit zip code areas
. added link to cancel post on editpost page
. format improvements
. added COVID-19 survey questions (self-vetting and for establishing new social norms)
. more consistent use of strhas (and strihas)
. invite step is completed just by visiting the page

2020-03-27 feature/post-search
. searching for words in posts
. fixed bug in rcron geocode
. fixed bug in deposits list, to make sure ALL checks in the deposit get printed
. slightly modified agent step text and default, to make it clearer and easier

2020-03-27 feature/post-crud
. enabled testing of setlocus
. fixed bug in periodic geocoding
. posts can now be edited by user or admin
. hooks added for a search box
. added a pseudo-category for "my posts"
. fixed a couple typos

2020-03-25 feature/post-format
. formatting improvements in posts
. improve reliability of geosearch by titlecasing request
. added hooks for moderation and administration of posts
. error checks for user modification of URLs

2020-03-22 feature/async-geo
. cron now fills in missing lat/lon in people records
. cookies track last offer/need category
. textual improvements

2020-03-21 feature/async-geosearch
. time limit on syncronous geosearch
. disabled async geosearch
. better handling of geosearch failure
. zip required in locus for post viewing

2020-03-21 feature/geo-tweaks
. fixed mysql calculation of distance between two points
. improved formatting of posts list
. fixed handling of radius limits in posts selection
. a couple other little bugs in posts
. message now when there are no posts to show
. improved posts messaging
. select can now be required
. modified geosearch to get a better result
. moved category selector to header of list

2020-03-20 feature/post-geosearch
. fixed a problem with message on company account page
. reworked setlocus
. fixed bug in setCook
. fixed uses of DISTANCE_BETWEEN
. added street number parsing to parseAddr
. changed mutual aid page to ask for location and radius
. added tests for mutual aid (posts)
. added stuff to post_cats

2020-03-17
. fixed bugs in community/posts
. reworked community/posts validate and submit for clarity and soundness, using a form identifier (frm)
. moved uid field from posts to people
. added radius field to posts
. added some tests for posts
. added a finance category and sort field to post_cats

2020-03-16
. bank connection page failed after disconnect (needed extra code in scraps.js)
. offers & needs page
. changed default profile images

2020-03-12 feature/fewer-acct-options (continued)
. no trial companies
. expanded initial company signup page to include federalId, etc.
. completed membership is no longer required for inviting someone
. verifyid separated out from resetpassword
. added w\maxlen function
. selling is now limited to 25 characters
. initial company relation is now automatically -A
. resetpassword and verifying email now leave you signed in, if you are, and sign in you in otherwise
. xid is shown on deposit slip now instead of txid
. account closing and reopening no longer loses original activation date
. changed some date handling in cron and cron tests to make leap day and daylight savings problems go away

2020-03-03 feature/fewer-acct-options
. HAS_REVERSER was unused. Removed.
. trialco now has just two steps and is limited to 14 days and $100.
. just two types of personal account: partner and normal (SSN required)

2020-02-21 feature/restrict-activate
. now only superAdmin can activate an account (but other admins can still deactivate)
. minor fixes to changepassword.inc

2020-02-18 feature/warn-cancel-bank
. when a member cancels a bank transaction we now send a notification about that
. db\del function expanded to allow a criteria assoc as the second of 2 params

2020-02-18 feature/1099k
. changed from issuing 1099b to 1099k
. prepared taxInfo page for 2021
. fixed admin aaOther test by adding "deleted" to the R_DATE_FLDS constant

2020-02-15 hotfix/task-nudge
. whatever task is current, send member to next step
. final tweak to solar1 activation
. enable deployment to new server (port change)
. allow deletion of company account with discount

2020-02-07 hotfix/no-dob
. allow activation without dob if individual came from solar1
. added invite button to summary page

2020-02-02 feature/tax-info
. fixed bug that kept crumbs account from invoicing crumb donors
. send annual notice of 1099-B availability
. fixed some bugs in cg-yearly.inc (1099-B generation)
. fixed bugs in misc.js for invoicing a nonmember

2020-01-14 feature/co-dob
. co2 task, agent step, now asks for founding date
. buying and selling is disallowed during co2 task
. yob field added, so age is available without superAdmin
. unused (and insecure) USPS state lookup deleted
. bug fixed that allowed text in company dob field
. bug fixed that put wrong signer in description of signedBy field when doing co2 task
. bug fixed that recorded wrong signer of CG Agreement

2020-01-12 feature/dob-fix
. dob is not available without superAdmin, so we added an underage bit that superAdmin updates automatically

2020-01-07 feature/bugs
. disable credit line for members under age 21
. admin function to export solar1 data
. added dob to summary page for admins, so we can add it explicity from photo ID
. deactivating an account with a nonzero balance is now disallowed
. file upload bug fixed in verifyId function
. "What's up" question is now only after 60 days (but still every month thereafter)
. Monthly sales query is expanded to include expenses in a separate column
. Tax Info page reactivated

2020-01-01 feature/prose-co
. another adjustment to how permissions are calculated to send to app
. rsmart tests are now for latest version (version 221 tests are in a subfolder and can be run separately)

2019-12-30 feature/prose-co
. changes to rsmart.inc to support changes to the CGPay Android app for trial companies and restricted personal accounts
. CGPay interface updated to replace "rewards" with "creditLine", "person" instead of "name", and other minor adjustments
. bug fix: source field is now shown on first page of personal signup
. time requests from app are no longer logged
. blog hack attempts now generate staff alert rather than log entry
. develop OR master branch can be deployed to new-staging
. bug fix and clarifications to origins query (where did members hear about us)
. cleaned up and tightened up restrictions on buying and selling
. fixed bug in Mailchimp export (related to partial company and personal accounts)

2019-12-20 feature/invest-fixes2
. bug fixes

2019-12-20 feature/invest-fixes
. investment club pages are now subsidiary entries on the Invest menu
. lists of investments actual and proposed have been merged
. invest buttons are now all blue
. some textual improvements to investment pages
. percentage return on investment detail page is no longer 1/100th of what it should be
. median goodness is shown on investment detail page, not must mean
. trim all textfield input
. use real words when a\anonymize()ing
. simplified validate and submit function calls in cg-testing.inc
. cleaned up fmtAmt (opt '0' now means whole dollar amount)
. members cannot join investment club without SELL permission, but they can see the menu item
. tightened up dividends page

2019-12-13 feature/uninvited
. handle messaging to a self-invited new member (don't say they have to be confirmed by System Administrator)

2019-12-12 feature/cgpay-tweak
. leaving item blank is now permitted (letting customer fill it in) and suggestedAmount and/or item is permitted

2019-12-12 feature/signupco-tweak3
. small changes to wording on tithein and discount pages
. improved order on admin followup page

2019-12-06 feature/signupco-tweak2
. improved showing/requiring ad hoc password field on company signup form
. dependent company account now uses manager's legalName and federalId only if manager's account has a federalId

2019-12-05 feature/signupco-tweak
. minor improvements to admin view of Summary page, including more complete step list and no "DEAD" when no federalId
. any account can now be invoiced (even if not yet activated) unless closed
. company signup now asks for signin to personal account if an account ID is given
. partnership signup now marks agree and preferences steps done
. companies with an account manager now are not given a (new) password when they verify their email
. signin form submission cleaned up slightly
. company signup now handles four distinct cases

2019-11-25 feature/fix-coupons
. food fund recipients no longer get unlimited rebates
. coupons with no end date now work
. improved display of startup steps on Summary page (especially when there is no current task)
. we now alert members who miss out on a rebate
. fixed bug that kept buy-only members from using the Pay page

2019-11-23 feature/fix-locus
. fixed Acct::setLocus() so it includes zipcode in search, so it gets more reliable results
. fixed neighbor query so it is always as exact as possible (since speed does not seem to be an issue)
. fixed weekly and monthly cron notices so they don't happen daily

2019-11-22 feature/cgpay-form
. added text button
. changed CSP to allow text button creation (inline styles are allowed only on the cgbutton page)
. fixed the digitsOnly functionality
. sanitizied cgbutton input
. simplified cgbutton form language

2019-11-22 feature/cgpay-form
. new form allows companies to easily create html for a CGPay button
. changed order of co2 task steps, to put photo earlier than company
. chaned $pA->id to $pA->uid in partnersignup.inc because ->id was empty once (but it was probably due to a crash and refresh)
. added cg4.us as an acceptable source for images
. added keypress and digitsOnly functions for form options
. we now (re)create contract dir on the fly, because it gets deleted in temp dir on dev machines

2019-11-19 hotfix/pay-button
. pay-with-cg button with no specific amount works again

2019-11-15 feature/partner-tweak4
. improvements to solar one form

2019-11-14 hotfix/partner-tweak3
. minor bug fixes
. legal name and federalId questions added to agent page (company signup)
. voting requirement changed from member to active account (IS_OK)
. partner solar one signups with duplicate email are accepted

2019-11-13 feature/partner-tweak2
. clarification of some messages
. minor bug fixes for admin summary page

2019-11-11 feature/partner-tweak
. added checking or savings question to partner signup
. fixed bug that kept people from using the partner signup link more than once
. improved admin view of current task and steps
. ajax "which" is no longer logged

2019-11-11 feature/admin-followup
. adjusted admin followup categories to agree with new signup flow
. moved taskSteps and allSteps to outside account object
. prevent admin from deleting current account (resulted otherwise in confusing crashes)
. added popup help to task on Summary page (for admin)

2019-11-09 hotfix/fix-setlocus
. we no longer try to setLocus for accounts without both city and state

2019-11-08 feature/setacct-tweaks
. fixed problem in bootstrap sigining out of anonymous accounts (signout should not destroy session if continuing)
. fixed donations, backing, food forms so an error when choosing a custom amount doesn't hang the form
. fixed reference to federalId in Acct::getCans so it doesn't kill cron
. solar one signup was trying to send contracts (bug fixed)
. some formatting improvements to solar one signup

2019-11-07 feature/setacct
. refactored w\setAcct, Acct::setDefault, and Acct::regen as r\setAcct
. stopped dying on inactive invoiced account
. made behavioral tests for changing accounts

2019-11-06 hotfix/no-redirect
. bugfix: active members were getting redirected if they hadn't completed all steps

2019-11-05 hotfix/easy-signup2
. added cardCode to trialco accounts and a link on Summary page to show a QR
. set default app permissions upon account creation, so trialcos can use app easily
. updated rSmart Identify feature to test current version of app
. fixed broken constants in text on fund step
. changed company verification to be identical to individual
. fixed bug in ssn step that didn't know it was retrying in short signup
. fixed u\ssnLookup by replacing missing .ssnCheck file with a new config.json parameter: R_SSN_REQUEST
. fixed broken link to agreement in invite template

2019-11-04 feature/easy-tweaks (continued)
. shortnames created in contact form get a digit added now, if necessary (rather than generating an error message)
. refactored bank account and routing formatting checks
. refactored tenure validation
. added templates for Solar One signup and tested it
. we actually store bank account information on partner signup now!
. individuals cannot sell without completing the S_SELL steps
. fixed skip button on discount page

2019-11-04 feature/easy-tweaks (continued)
. improved how account regeneration is handled in tests
. imported Co-op Power's contract for automatic signing
. partner signups now have just one CG account setup step
. companies that do partner signup no longer can sell and have just one CG step (handled like individual accounts)
. dates in tests are now just tested for approximate equality
. added first stab at handling solar one signups (still needs validation and handling of extra fields, plus tests)
. backing no longer defaults to $1 invisibly on preferences page (never was in effect)
. empty EIN means no SELL permission
. moved contracts folder to system temp folder and don't send a URL to salesforce

2019-11-01 feature/easy-tweaks (continued)
. integrated functionality of u\exactly() into just() and removed "keep order" parameter
. fixed bug that left everyone but admin signed in for a long time
. improved DOCODE handling in tests
. fixed weekly reports (which were coming out daily whenever there was a transaction)
. fixed formatting of white-labeled partner page on mobile
. changed order of steps in partner signup so contract is first
. simplified steps for company in partner signup
. moved all partner signup steps to a single file (forms/partnersignup.inc)
. added daily check for bank accounts without risk hasBank and vice versa
. added a test for slave transfer
. removed r_contracts table

2019-10-21 feature/easy-tweaks (continued)
. fixed handling of uploaded files
. added CC to partner and white-labeling email ("pseudo" argument to rMail())
. we now use better filenames for attached files emailed to customer and partner
. created r_contracts table to track when customers signed a contract with partner
. contract link can be used to sign in only the same day it is first used (making it easy to go further with Common Good)
. no debt link on summary page unless you choose auto-refills
. fixed signin so it always signs out first and doesn't make you sign in twice

2019-10-20 feature/easy-tweaks
. reworked step management, adding a stepDoneForNow function
. fixed a couple bugs in rMail function (to can be an array, attachments work) and improved reporting for when isDEV
. changed calls to u\DYE to u\FAIL (bug fix)
. fixed eol bug in u\randPass() on windows machines
. branded partner signup and ending pages as the partner (see page.tpl)
. added contact and discount steps to co2 task
. disabled display of voting results at the request of Ann Arbor organizers
. generalized co-op power partnering to other organizations
. changed partner signup to allow choosing NOT to use CG, to generate and email contracts, and combine that with email verification
. partner signup tests no longer work (they need work)
. added tabindex="-1" to links
. changed reset links to go straight to member site (not through promo site)
. fixed bug in startup.sql for creating uid 0 in users table
. did this on production server, to remove test events/questions/ballots/votes and orphaned old data:
  DELETE FROM `r_events` WHERE id IN (8,12);
  DELETE q FROM r_questions q LEFT JOIN r_events e ON e.id=q.event WHERE e.id IS NULL;
  DELETE b FROM r_ballots b LEFT JOIN r_questions q ON q.id=b.question WHERE question>0 AND q.id IS NULL;
  DELETE v FROM r_votes v LEFT JOIN r_ballots b ON b.id=v.ballot WHERE b.id IS NULL; 
  DELETE o FROM r_options o LEFT JOIN r_questions q ON q.id=o.question WHERE q.id is NULL AND o.question>0

2019-10-16 feature/simple-tweaks
. session creation on signup using $sta['uid'] = $uid;
. fixed softErr to enable html
. added final email to co-op power signup

2019-10-15 feature/simple-signup continued
. we now handle UTF-8 characters
. added "task" field in users, to track what multi-step process they're in
. multiple file attachments are now permitted in r\rMail
. staging server can now send email if it doesn't have much (real) data
. added "work" step to S_VOICE and company type to agent form
. added special integrated signup through Coop Power
. fixed session regeneration and signout function
. added 3-digit zipcode lookup so we know what state without asking.
. added company choices to summary page and refactored

2019-10-02 feature/simple-signup
. changed canonical accounts migration to create a zero account
. password now defaults
. changed SSN to be verified by POST instead of AJAX
. eliminated partner welcome email
. moved debtOk to advanced preferences and changed the order of the non-advanced options
. improved language on donate page
. shortened text on coupons (so it fits)
. moved ownership and tenure questions to contact form
. removed problematic javascript dropdowns for state and country
. converted connect form to handle decision about how to fund the account
. when removing a bank account, all related pending bank transfers are deleted
. removed checkboxes and signature from agreement page
. removed signature from backing page
. created a model form in forms/
. added a list of important next steps to Summary page
. added steps for company to complete a trial account
. added a multi-word password generator
. account passwords now default
. added attachment capability to r\rMail function
. added zip field to r_inviites table, to track invitations within a community (for $2 rewards)
. separated individual signup into several phases and many steps
. added steps field to users table, to track signup steps
. after deploying:
  global $newMembers;
  eachA(function ($a) {
    global $newMembers;
    if (!$a->ok) $a->setBit('member', FALSE);
    $a->update('task steps stepsLeft', '', 0, '');

    extract($a->stepsDone ?: []);
    $trial = ($a->federalId == CGF_EIN);
    if ($a->co) {
      if ($trial) $a->update('cardCode', r\cardCode($a->mainQid));
      $co2Done = (@$agree and @$backing and @$company and @$donate and @$photo and @$preferences);
      $task = $a->member 
      ? (($trial or !$co2Done) ? 'co2' : '')
      : 'co';
    } else $task = $a->member ? '' : 'person';
    $a->setTask($task);
    if (@$signup) $a->stepDone('signup');
    if (@$verify) $a->stepDone('verifyemail');
    if ($a->federalId and !$trial) {
      $a->stepDone('signup');
      $a->stepDone('verifyid');
      $a->stepDone('ssn');
      if ($a->co) $a->stepDone('agent');
    }
    if ($a->bankAccount or db\exists('txs', 'uid2=' . $a->id)) $a->stepDone('fund');
    if ($a->signed) $a->stepDone('agree');
    if (db\exists('r_recurs', 'payer=' . $a->id) or ($a->created > strtotime('08/27/2017') and $a->member)) $a->stepDone('donate');
    if (db\exists('r_proxies', 'person=' . $a->id)) $a->stepDone('proxies');

    if ($a->member or $a->ok or @$prefs) $a->stepDone('preferences');
    if ($a->co and db\exists('r_coupons', ['fromId' => $a->id])) $a->stepDone('discount');
    if (@$backing or $a->backing + 0) $a->stepDone('backing');
    if (@$company) $a->stepDone('company');
    if ($a->address and $a->postalAddr) $a->stepDone('contact');
    if ($a->hasPhoto) $a->stepDone('photo');
    if (db\exists('r_invites', 'inviter=:id', ['id' => $a->id])) $a->stepDone('invite');
    if ($a->calling or $a->signupCo) $a->stepDone('work');
    if (@$food) $a->stepDone('food');
    if ($a->co ? (@$prefs or ($a->crumbs + 0)) : $a->member) $a->stepDone('tithein');
    
    $left = join('|', $a->stepsLeft);
    $stepsLeft = join('|', $a->stepsLeft());
    $left .= $stepsLeft == $left ? '' : " LEFT()=$stepsLeft";
    $stepsDone = ''; foreach ($a->stepsDone ?: [] as $k => $v) if ($v) $stepsDone .= ($stepsDone ? '|' : '') . $k;
/**/  if (!$a->ok or $a->co) debug("$a->fullName: DONE0=$stepsDone DONE=" . str_replace(' ', '|', trim(u\bits($a->steps, S_ALL))) . " TASK=$task LEFT=$left");
    if (!$a->co and $a->member and !$a->ok) $newMembers[] = $a->mainQid;
  });
/**/  debug($newMembers);

2019-09-06 feature/banking-fix
. requesting a transfer into CG with a negative balance now transfers exactly the amount requested
. fixed bug that lost photo when changing uid
. fixed overzealous EXPECT that crashed signups
. fixed bug that crashed company trial signups

2019-08-27 feature/ezbiz-tweaks
. fixed bug that listed tables in chron order (rather than backwards) in Admin Panel
. fixed bug that sent admin messages to admin's joint-account partner also
. fixed bug that tried to send SMS to some accounts (and died)
. now when a trialco account visits the Agreement page, it shows the agreement
. source and selling fields added to ezbiz form, and factored them up to rweb-subs.inc, for sharing elsewhere
. improved Food Fund staff alert
. renamed ezbiz signup from "trial" to "signup-co", in preparation for personal trial accounts and both trials being the standard way to sign up
. added defaults to signup-co form when a member is signed in
. renamed signup-co feature "signup-co2" in preparation for using it for biz account completion
. fixed bug that kept daily cron from ever running

2019-08-21 feature/ezbiz
. fixed check numbers to be xid instead of txid
. suppressed 0.00 in customer statements
. invoices now preceded same-date transactions on customer statements
. refactored be\transact() and other functions to return "success" explicitly

2019-08-20 feature/ezbiz
. easy business signup (trial company)
. added new discount step for companies

2019-08-17 feature/stale-nudge
. added a virtual staleNudge field to users data field, allowing a company's stale invoice reminders to go out with a non-standard period (the standard is 7 days) or not at all. There is as of yet no way for the company to set this field.

2019-08-15 hotix/reports-link
. fixed links to company reports

2019-08-10 feature/coupon-fixes
. fixed bug in coupon transaction creation that recorded coupated id instead of coupon id (also corrected past data)
. backing text now compares it to FDIC
. expanded couponslist page to show the customer how much of the coupon/discount they have remaining
. proxy choices now ALWAYS include the placeholders
. fixed bug in development that kept account lookup from working
. changed most numeric fields in users table to NOT NULL, defaulting to 0
. fixed bug in community balance sheets that omitted inter-community trade from Dollar Pool balance
. fixed bug in acct::bank() that gave wrong message for bringing balance up to zero
. improved handling of languishing funded invoices (now they get refunded, if necessary, the next day)
. replaced crop symbol with a checkmark
. many corrections in calculation and display of risk flags including consolidation of txs with bank transfers
. fixed bug that displayed "Drupal" in page title

2019-08-06 feature/whence
. fixed bug in getTxs that set description using tid instead of xid
. changed capistrano submodule configuration file to accommodate MS Windows quirks
. changed test table value from TEXT to BLOB
. fixed bugs that reported tid instead of xid in a notice to member and on screen

2019-08-05 feature/whence
. moved the source field out of the data field, into an actual field
. created a "where do our members come from" query
. changed testing to use a new test table in the database instead of drupal's session variable
. improved test formatting
. fixed bug in acct::newAcct that put everyone in the Western Mass (NEW) region
. started a new queries test feature
. started a new demographics test feature and fixed a couple bugs
. fixed bug in getTxs that set description using tid instead of xid
. changed capistrano submodule configuration file to accommodate MS Windows quirks

2019-08-03 feature/piecemeal-discounts
. discounts with a zero minimum can now be redeemed in dribs and drabs
. fixed bug that kept first repeating transaction from getting marked as such
. fixed bug that kept admin from being able to deactivate an account
. changed checks test so it creates confirmed accounts, making it an easy way to set up standard test accounts
. added a sponsor field to coupons so a third party can pay the rebates (used initially by Food Fund and for Garlic & Arts)
. changed coupon handling to count or add actual coupon rebate transactions, rather then a "uses" field
. tx history, download history, and statements will show old check numbers rather than xids for old bank transfers
. statements now use xids not tids (omitted from previous updates)
. invoices in cron now request enough funds to cover the roundup, if any
. moved internal procedures in db\migrations\recreate-views.inc to ...\util.inc to circumvent a bug in phinx
. changed txs definitions to consolidate rel1, relType1, rel2, and relType2 into just rel and relType (using only rel2 / relType2)

2019-08-01 feature/xids-only
. touch ups to the xids-only feature
. fixed bug that showed the wrong name in joint account email

2019-07-31 feature/xids-only
. did away with tids (now xids are used everywhere, including on checks)
. fixed rweb Download tests, which were not doing anything, and the corresponding functionality

2019-07-30 feature/restricted-coupons
. fixed bug -- forOnly field was not showing up on coupon form
. got rWeb:Community test to run!
. used a cool new feature in gherkin that lets you turn your associative array sideways (using ** instead of *)
. added a stub connect feature test

2019-07-29 feature/restricted-coupons
. discount coupons can now be restricted to certain accounts
. discounts are now called "discounts" rather than coupons
. fixed bugs in acct::bank() that combined too little into previous deposits and reported the new request unclearly
. fixed bug in tellAdmin that omitted all details
. coupons now only show up for nearby accounts
. sanity check now detects transactioins with no entries (happened once when there was a lock error)
. fixed bug in tests that sometimes kept verifyRecord from identifying correctly the record key
. deleted many records in table "variable" and renamed a couple
. fixed bug that stranded some invoices that were marked "funding"

2019-07-24
. php form no longer has to be refreshed on dev after running a test
. <. is a workaround for HTML in PHP box
. added 'args' to NO_LOG (relevant in failed signups)
. Save button on invest form now sets reserve with ajax

. fixed data: added monthly transfers from roundups account to CG:
  $cgA = r\acct(CGID);
  for ($year = 2013; TRUE; $year++) for ($month = ($year == 2013 ? 6 : 1); $month < 13; $month++) {
    $start = strtotime("$month/1/$year");
    $end = u\monthday1($start + 1.5 * MONTH_SECS) - 1;
    $subs = compact(ray('start end'));
    $where = 'created BETWEEN :start AND :end';
    $new = db\sum('IF(:CGID=uid1,-amt,amt)', 'txs', ":CGID IN (uid1,uid2) AND IF(uid1=:CGID,uid2,uid1) NOT IN (256,257) AND $where", $subs);
    $old = db\sum('IF(payer=:CGID, -amount, amount)', 'legacy_r_txs', ":CGID IN (payer,payee) AND $where", $subs);
    $oldRoundups = db\sum('amount', 'legacy_r_txs', "(flags&(1<<:OLD_B_ROUNDUPS)) AND $where", $subs);
    if ($oldRoundups > 0 and !($year == 2019 and $month == 6)) be\transfer('payment', r\acct(CG_ROUNDUPS_UID), $cgA, $oldRoundups, t('roundup donations'), FOR_GOODS, ray('created gift', $end, TRUE));
    if (!$new and !$old) break 2;
  }
. reinstated CG Noho transactions as transactions with the seedpack (both in legacy and current txs):
  INSERT INTO `legacy_r_txs` (`xid`, `serial`, `type`, `flags`, `goods`, `amount`, `payer`, `payee`, `payerAgent`, `payeeAgent`, `payerFor`, `payeeFor`, `payerTid`, `payeeTid`, `data`, `channel`, `created`, `box`, `risk`, `risks`) VALUES
  (86568, 86568, 0, 1024, 2, '562.34', 26742000000002, -26742000000001, 26742000000002, -26742000000001, '50% share of local donations through 30Sep2017', '50% share of local donations through 30Sep2017', 5261, 0, '', 5, 1506830399, 0, 172.138, 262160),
  (90228, 90228, 0, 1024, 2, '285.73', 26742000000002, -26742000000001, 26742000000002, -26742000000001, '50% share of local donations through 30Nov2017', '50% share of local donations through 30Nov2017', 5374, 0, '', 5, 1512104399, 0, 135.077, 263184),
  (92114, 92114, 0, 1024, 2, '186.15', 26742000000002, -26742000000001, 26742000000002, -26742000000001, '50% share of local donations through 31Dec2017', '50% share of local donations through 31Dec2017', 5458, 0, '', 5, 1514782799, 0, 165.561, 8520720),
  (108553, 108553, 0, 1024, 2, '-1034.22', 26742000000002, -26742000000001, 26742000000002, -26742000000001, 'reverse all grants to Noho CG Community', 'reverse all grants to Noho CG Community', 5458, 0, '', 5, 1551848400, 0, 165.561, 8520720);

  $cgA = r\acct(CGID);
  $seed = r\acct(-26742000000001);
  be\transfer('payment', $cgA, $seed, 562.34, '50% share of local donations through 30Sep2017 (originally to Noho CGC)', FOR_GOODS, ray('created', strtotime('9/30/2017')));
  be\transfer('payment', $cgA, $seed, 285.73, '50% share of local donations through 30Nov2017 (originally to Noho CGC)', FOR_GOODS, ray('created', strtotime('11/30/2017')));
  be\transfer('payment', $cgA, $seed, 186.15, '50% share of local donations through 31Dec2017 (originally to Noho CGC)', FOR_GOODS, ray('created', strtotime('12/31/2017')));
  be\transfer('payment', $cgA, $seed, -1034.22, 'reverse all grants to Noho CG Community', FOR_GOODS, ray('created', strtotime('3/6/2019')));
  be\transfer('payment', r\acct(CG_ROUNDUPS_UID), $cgA, 131.64, t('roundup donations'), FOR_GOODS, ray('created gift', $dt61-1, TRUE));

2019-07-19 feature/invest
. added sweep function to cron, to credit CG with roundups and crumbs
. finished investment club software (first pass), with extensive tests
. replaced many calls to print_ r with pr(), to avoid having to ignore those lines when updating
. added some helpful debugging tools, including identification of non-array field in forms.inc
. minor simplifications to menu.inc and path.inc
. bug fix: sometime SSNs were getting emailed to admin and recorded in logs
. expanded db\get functionality to handle multiple calculated fields
. crucial bug fix: bad phone number on first signup page was preventing user from signing up

2019-07-12
. many bug fixes and tests toward solidifying the investment club software
. adapted db\del to handle non-numeric keys
. adapted testing to handle periodic cron calls better
. adapted t\verifyRecord to show specific differences between expected and actual record (yay!)
. adapted u\SUBS to handle users table identifiers with mixed case
. created an SQL query box on community data page, for admins
. investment club admins are now identified by the relationship, not by a flag bit
. fixed display bugs on bank connection page
. fixed bug in demographics report
. cron is now prevented from running a periodic routine twice in an hour (other than the 5-minute one)

2019-07-08 feature/verification-fix
. fixed bug the combined some new bank transfer requests into a verification request
. fixed bug that assigned outgoing bank code to all not-yet-completed incoming transfer requests
. fixed white screen of death on timeout

2019-07-03 feature/remote-invite
. enabled invite button in MailChimp emails
. completed early June food fund donations by hand:
eachA(function ($a) {
  $foodUid = db\get('uid', 'users', "name='foodfund'");
  $foodA = r\acct($foodUid);
  $start = u\monthDay1($end = u\monthDay1() - 1); // mark start and end of preceding month
  $target = round($a->food * db\sum('amt', 'txs', "uid1=$a->id AND :T_FOODY AND created between $start AND $end"), 2);
  $actual = round(db\sum('amt', 'txs_donation', "uid1=$a->id AND uid2=$foodUid AND created between $start AND $end"), 2);
  $dif = $target - $actual;
  if ($dif > 0) {
/**/ debug("$a->fullName: $dif");
    be\transfer('payment', $a, $foodA, $dif, t('food fund donations for early June'), NULL);
  }
}, 'food>0');
. fixed bug that took food donations on straight payments to Food Fund

2019-07-02 feature/cron-once-daily continued
. changed acct::recomputeBalance() to include joint account
. fixed cron crumbs so they don't happen twice
. change acct::bank() back to not round up bank transfers unless the member has auto-refills
. crumbs txs from invoice now get flagged as crumbs
. fixed bug in daily totals (company query)

2019-07-02 feature/cron-once-daily
. fixed cron bug that let everyday run several times at once
. Identified and deleted extraneous invoices since 6/2/2019 (1559448000) with:
SELECT DISTINCT r.id AS recursId,fullName,i.payee,i.nvid AS nvid1,i2.nvid AS nvid2,
  txid,t.xid AS xid1,t2.xid AS xid2,i.amount AS iAmt,d.amount AS dAmt,t.amt AS tAmt 
FROM r_recurs r 
  LEFT JOIN r_invoices i ON (i.recursId=r.id)
  LEFT JOIN users u ON u.uid=r.payer
  LEFT JOIN r_usd d ON (d.payee=r.payer AND deposit=0)
  LEFT JOIN txs t ON (t.recursId=r.id AND t.created>1559448000)
  LEFT JOIN r_invoices i2 ON (i2.recursId=i.recursId AND i2.status<1 AND i2.nvid<>i.nvid)
  LEFT JOIN txs t2 ON (t2.recursId=t.recursId AND t2.created>1559448000 AND t2.xid<>t.xid)
WHERE (i2.nvid IS NOT NULL OR t2.xid IS NOT NULL)
. Identified and deleted invoices not connected to a recur record, that got duplicated on 6/13:
SELECT i.nvid,i2.nvid, fullname,i.amount,i.status,i.purpose,from_unixtime(i.created) AS dt1,from_unixtime(i2.created) AS dt2 from r_invoices i join users u on u.uid=i.payer left join r_invoices i2 ON i2.payer=i.payer AND i2.payee=i.payee AND i2.status<1 and i2.nvid<i.nvid WHERE i2.payee=26742000000002 AND i2.nvid IS NOT NULL AND i2.recursId=0 ORDER BY i.nvid DESC,i2.nvid DESC

$xids = '123299, 123300, 123301, 123302, 123203, 123157, 123158, 123065, 122603, 122604, 122605, 122658, 123272, 123273, 123274, 123275, 122732, 122608, 123085, 123271, 123340, 123338, 123385, 123381, 123383, 123348, 123393, 123350, 123395, 123352, 123397, 123354, 123399, 123360, 123404, 123368, 123279, 123371, 123373, 123377, 123380, 123382, 123384, 123386, 123388, 123390, 123392, 123394, 123396, 123398, 123281, 123164, 123403, 123208, 123405, 123311, 123312';
db\del('tx_entries', '', "xid IN ($xids)");
db\del('tx_hdrs', '', "xid IN ($xids)");

2019-07-01 feature/fix-cron
. fixed donation sharing table on CG's Summary page
. did away with requests function in cron
. fixed bug in cron that prevented logging
. added a failsafe in cron to keep any part of it from getting run twice at once

2019-06-28 feature/simplify-txs
. added several new views for transactions (including their entries), to simplify selection queries and tests
. renumbered transaction entries so the ID of the entry for the payer is negative the payee's entry ID
. gave separate entryTypes to rebates, bank charges, bank transfers, and transaction fees
. changed bank transfers to consolidate incoming transfers when possible and fix some bugs
. miscellaneous bug fixes
. prepared for doing away with Tids, by giving even tentative bank transfers an xid (with a zero amount in the tx record)
. simplified many queries
. moved sanity check to Handy menu
. simplified be\transfer function by standardizing variable names and setting them systematically
. fixed bugs in user cancelation of transfer request AND admin reversal of transfer request
. combined setBit with setBitx in acct class
. created utility and batch files to facilitate migration testing especially on Windows

2019-06-20 feature/fix-usd-cancels
. CG can always transact with people, even if they have not used their card yet.
. fixed bug that failed to create an r_usd record when canceling a pending transaction
. fixed bug that failed to create an r_usd record when admin reverses a bank transfer
. no notices are now sent to canonic accounts
. fixed links to promo site (now that we have a new promo site)
. removed most of the overview at the top of the signup page (to make it easier to dive in)
. corrected calculation of crumbs in rcron.inc
. fixed data related to r_usd bugs, in USD window:
    $q = db\q('SELECT xid,amount,uid2 AS payee,created,created AS completed,:TX_WEB AS channel FROM txs where xid IN (121730,122551,122552,122841)');
    while ($info = $q->fetchAssoc());
      $a = r\acct($info['payee']);
      $info['bankAccount'] = $a->vsecure['bankAccount'];
      db\insert('r_usd', $info, 'txid');
    }

2019-06-19 feature/food-percents
. food fund donations now happen automatically at the time of the transaction
. fixed bug in cashoutW
. added thumbs field to r_photos, followed by this code in PHP window:
  $q = db\q('SELECT uid FROM r_photos');
  while ($row = $q->fetchAssoc()) {
    $a = r\acct($row['uid']);
    $factor = ($a->co ? 2 : 1) * THUMB_FACTOR;
    list ($w, $h) = $a->co ? CO_ASPECT : FACE_ASPECT;
    $img = u\alterImg(imagecreatefromstring($a->photo), $w * $factor, $h * $factor);
    $thumbInfo['thumb'] = u\img2string($img, $a->co ? 100 : 50);
    $a->updatePhoto($thumbInfo, 'thumb');
  }
. added recursId field to x_invoices (bug fix)
. fixed bug in balancesheet
. added a check in rcron.inc for orphaned joint account
. fixed white screen of death bug on signout

2019-06-15 feature/show-incoming-recurs
. fixed (again) u\csv to avoid sending quoted names to MailChimp
. added payments-to-me and purpose to list of recurring transactions
. improved function of amt-choice pages (donations, backing, food fund)
. added help message for why no one-time-donation options
. added image interpretation to testing
. added Skip to photo page

2019-06-14 feature/signup-tracking
. improved format of company list (findco.inc)
. widened honors form and improved format
. fixed format of account-switch form and removed confirmation question
. tracking presignup information (name, email, phone, source)

2019-06-11 feature/fix-recurring
. created new views for txs (including payer and payee fields) and txs_noreverse (txs without reversed transactions)
. moved "print card" to top of admin action
. fixed r\qid() in class qo to handle compound qids
. fixed too-few-arguments bug in invoiceUpload and elsewhere that be\invoice() or be\transfer() is called
. fixed acct::giftsDesc() (wasn't showing recurring gifts)
. added purpose field to r_recurs (to assure proper description of recurring transactions)
. added recursId field to tx_hdrs_all and r_invoices (to assure proper correspondence of recurring transactions with r_recurs record)
. removed parenthetical remarks from all recurring transactions

2019-06-03 tweaks to feature/fix-balance-sheet
. changed TM to &reg; on CG cards
. signup now records source2 sent from promo site as advertisement ID
. community is no longer automatically updated to/from seedpack for ever-activate members
. email now goes through google's SMTP

2019-06-01 feature/fix-balance-sheet
. fixed bug that kept r\deleteAccount from deleting tx_hdrs field
. completed balance sheet

2019-05-29 feature post-split-fixes
. fixed cron bug that paid closed recurring payments
. reinstated instructions in agreement form and cleaned it up
. removed spurious ")" in discount rebate description and corrected coupon tests
. fixed bug in nonmember.html (lowercased "code")
. fixed some (but not all) bugs in transaction risk calculations (in cg-risk.inc)
. created views for payer and payee entries
. temporarily disabled repeating transactions
. fixed txInfo form
. repaired risk calculations
. repaired risk tests somewhat
. fixed bug that prevented cross-community account changes

2019-05-05 feature/misc-todos
. fixed bug that doubled and mislabeled first recurring donation (not to CG)
. changed SNAP question to "Do you qualify for any of the following"
. show banktxid(s) on deposits screen
. deposits screen: filterable by start date (earliest to show) and limit to 42 checks
. fixed bug: box was not recorded for smartphone transactions
. overhauled dates, using new function now() to replace r\rTime(), allowing tests to set hypothetical times
. moved account activation function from acct class to forms\summary.inc (where it is called). no changes made.
. added option to several db functions (in cg-db.inc) to present parameters as an associative array, without a "where" parameter.
. added tables and variable table variables to _clear() in cg-testing.inc
. changed tenure field to ask for years and months instead of just months
. made format on preferences page more consistent
. simplified summary page for communities, now that there is a balance sheet page
. consolidated last cron variable in variables table

2019-05-02 feature/show-autopays
. fixed bug in setLocus that chose first possible match rather than the one with highest confidence
. removed emails from bottom of Member List page
. general account search for admins
. also show autopays on recurring transactions page

2019-04-29 feature/balance-sheet
. stopped logging attempted hacks of wp-admin
. community balance sheet (on Community menu)
. recreate menus automatically on version change
. added variables viewer back into Handy menu

2019-04-20 feature/food-fund-better
. improvements to food fund page
. users record uid=0 is created by testing, if it doesn't exist

2019-04-17 feature/food-fund-and-bug-fixes
. created anonymize for removing personal data from test server
. fixed bug that left user signed in directly to company account (no agent) upon opening the new company account
. fixed mixed-case email bug
. fixed notices months list crash
. fixed duplicate sequential entries in company list
. fixed bug that miscalculated payees and basket, based on tx date >, rather than BETWEEN
. changed calculation of basket and payees to average (median almost never changes)
. fixed bug that calculated stats before start of a community

2019-04-09 feature/stats-tweaks
. mocked up food fund giving page
. fixed bug in payee and basket stats
. changed getstats to optionally recreate only specific data (for quickness)
. refactored charts.js to simplify creation of new charts
. granularity of chart can now be selected with a dropdown, in javascript

2019-03-23
. fixed bug in rcron.inc that kept trying to setLocus even after addrOff risk bit was set

2019-03-22 feature/fix-pay
. payments were failing for admins (in be\identify)

2019-03-22 feature/fix-metrics
. fixed the graphics for the one-metric feature
. changed chart.php so it is just a stub and the main code is all in rweb/

2019-03-21 feature/one-metric
. added calculations of median payees, median basket, donation types, and invitations to stats
. created success metrics graph
. community transactions are now included in stats
. changed graph selection to JS (fast!)
. added an option to download graph data
. fixed wrong param count bug in be\memberRay
. removed references to transaction type
. revised debug function to show even duplicate output
. changed u\nn() function to nn() in bootstrap (no namespace) and added check for !isset
. change in address triggers redo of geolocation
. moved formGraphs from rweb.inc to forms/graphs.inc
. fixed undiscovered bug in calculation of need for credit ban (in rcron.inc)
. fixed bug in calculation of velocity (for graph)
. added hooks for later option to change range and granularity of graphs by javascript

2019-03-11 feature/fix-setlocus
. upgraded to MariaDb10.3.13, so put "@" in front of compact() where it was intended to omit missing variables and changed "continue" to "continue 2" in one place in vendor/tcpdf/tcpdf.php
. fixed bugs in account::setLocus() (never worked), including changing latitude and longitude fields to 11,8 in users table
. added calculation of payees and basket to r\getStats() and adjusted aAccts (active accounts) to include companies

2019-03-10  feature/pay-with-cg-link
. people can now pay buy clicking on a simple link on a website or in an email -- no company code is specified and user must confirm by clickin a link in an email invoice (api and request parameters are stored in the invoice, so calling website can be notified upon payment)
. added latitude and longitude fields
. changed lookup restriction to number of miles
. shortened company agreement
. small changes to agreement text
. fixed bug that suppressed letter choices for cAdmin2
. fixed bug that suppressed formFollowup for admin2
. changed periodic account risk thresholds to be a percentile of activity for that period length over all accounts
. added solar, manages, lastTx, and snap fields in member list download (for marketing)
. removed superfluous quotes in member list export
. removed archaic decryption of doCodes
. removed "invitation or card code" question from signup

2019-02-24 feature/pay-with-cg-link (begun)
. tell admin who the replacement card was printed for
. 1099-MISCs can now be reported also (in a couple years we'll need 1099-INTs also
. now you can pay (lookup) anyone in your state -- but it should just be within some number of miles
. changed bigDay (etc) risks to be based on top 5% volume per employee, rather than an arbitrary amount
. added a distance between 2 points on Earth function
. fixed bugs in demographics page
. separated out the profile page
. cleaned up some risk descriptions

2019-02-14 feature/agreement-food-and-backing-touchup
. bug fix: fatal error when invoice got paid
. agreement wording changes
. bug fix for changing backing amount
. show transaction descriptions on Flags page only for cAdmin2+
. move food fund field to advanced settings
. accept ANY format for SNAP number (until we make sure we're not excluding people)
. fixed submit label on Connect page

2019-02-12 feature/new-agreement-and-backing
. bug fix: rounding errors in admin-achify.inc
. new agreement
. backing page
. demographics report
. GNU license file
. change from "Common Good Credits" to Common Good credit
. food fund donation opt-in and SNAP tracking
. refund permission is now sufficient for messaging a member
. fixed bug whereby the first recurring payment (non-donation) was not recorded as recurring, so it happened again the next day
. eliminated some archaic reward-related code and the payerReward and payeeReward fields in r_txs

2018-12-12 feature/fix-donate-form

2018-12-01 feature/fix-join
. joins now work even if relation pre-existed and member uses the button on the Summary page
. cron no longer tries invoices where a party is inactive
. fixed bug in admin-achify.inc that left-filled account numbers with zeros
. all but roundup donations to CG now get rounded, if member chooses roundups

2018-11-30 hotfix/tweak-repeat
. no "Repeats:" label, defaults to no repeat, doesn't create a r_recurs record when no repeat

2018-11-29
. implemented repeating payments feature (but not for web payments)

2018-11-27
. fixed bugs in web-interface transaction reversals

2018-11-26
. made grading score display more explicit

2018-11-20
. revised grading reports
. fixed Save button on Summary page for admins, so it doesn't screw up tickle field
. added query: Individuals Paid By A Company

2018-11-07
. reordered tx statuses in defs.inc to stay in a logical order (just equal to one less than they are now)
. lowercased cgMembers

2018-11-07
. fixed invoice download bug that showed paid invoices as OPEN
. changed TX_APPROVED to -2 (including data changes to r_invoices table), so tests can use tx#1
. improved customer statements and made tests for them
. disabled roundups of donations to CG

2018-11-02
. redesigned how grading proposals works (created r_criteria table)
. changed "id" field of users records in tests to "uid", to eliminate confusion with actual "id" field in other tables

2018-10-25
. fixed bug in acct::recordChanges() that kept proper agent from getting recorded
. fixed bug in vendor report that linked to customer statements rather than vendor statements
. fixed bug in donate.inc that prevented companies from donating!!

2018-10-24
. added current amount available to short message
. widened web reports

2018-10-20
. changed all &trade; to <sup>&reg;</sup>
. new report for bookkeeper: Reconciled Dollar Pool Transactions
. new miscellaneous reports functionality (see company reports and forms/data.inc)
. clarified some messages

2018-10-09
. fixed v\showProposal() to work when NOT showing grading questions
. donations from already-members are now reported to cAdmin (not just admin)
. separated members expected donations query from companies and improved them both

2018-10-08
. fixed urls on Dev machine to accommodate frame
. added query to show how many members choose which kinds of donations
. fixed a few more warnings new in PHP7

2018-10-03
. fixed PHP7 problems (empty implicit fields that should have been unset)
. fixed tickle problem (buttons weren't working on summary page)

2018-09-29
. fixed bug that kept ssnOff from getting set
. ajax now picks up agent ID, so changeBy field in r_changes gets set properly
. after reconciliation admin has the option to create an offsetting transfer from checking to Dollar Pool

2018-09-27
. separated investment club administration from individual participation

2018-09-21 v3.42g
. fixed bug that let anyone reverse their own payment (now sends invoice)
. improved reconciliation (added manual reconciliation and offset form)
. moved features (and steps and tests) to a features folder above rcredits/

2018-09-18 v3.42f
. fixed bug in photo upload (typo from last release)
. improved reconciliation (feature still incomplete)

2018-09-15 v3.42e
. changed r_usd and r_usd2 bankTxId default to 0 (bug fix)
. made progress on ctty fund reconciliation

2018-09-14 still v3.42d
. changed changes field to changesX and automatically populates new r_changes table
. added r_usd2 table for service charges and inter-account transfers (to help reconcile Community Fund bank account)
. eachA(function ($a) {
		$chs = $a->changesX;
		if (!strlen($chs)) return;
		if (db\exists('r_changes', ray('uid', $a->id))) return;
		$chs = u\decry('S', $chs);
/**/  if (!$chs = unserialize($chs)) {debug("$a->fullName: bad serial or encryption"); return;}
		$rec = []; // track historical field values
		foreach ($chs as $dt => $info) {
			foreach ($info as $k => $v) {
				$newValue = isset($rec[$k]) ? $rec[$k] : (in($k, VSECURE_FLDS) ? $a->vsecure[$k] : $a->$k);
				$rec[$k] = $v;
				$record = ray('uid created field oldValue newValue changedBy', $a->uid, $dt, $k, $v, $newValue, 0);
				db\insert('r_changes', $record); // add a r_changes record for each changed field
			}
		}
	});
		
2018-09-14 v3.42d
. changed mail field to "email"
. refactored some things in acct.class
. changes are now encrypted as S, V, or P, as appropriate

2018-09-13 v3.42c
. now uses a change table (made some changes to JR's code, for consistency etc.)
. partial community fund reconciliation feature

2018-09-06
. fixed bug that left outgoing transfer requests uncompleted
. fixed bug that created more than one bank verification request sometimes
. fixed bug that tried to save null in recovery field of r_proposals
. bug fix: recurring gift of zero now cancels previous recurring gift

2018-09-04
. made all filenames lowercase except README.md

2018-09-04
. fixed bug in annual donation warning timing
. minor changes in coupons

2018-09-03 v3.42b
. fixed formatting error on donate page
. donate page now uses eLinkAcct() so we can include a donate link in emails (for annual donation warning)
. added annual donation warning to cron

2018-08-21 v3.42a
. in CSV file uploads, all lines with errors are now reported

2018-08-16 v3.42
. ALTER TABLE r_usd DROP COLUMN tid;
	ALTER TABLE x_usd DROP COLUMN tid;
. reorder r_usd and x_usd columns to agree with cg-install.inc and REBUILD
. created a bankOk flag bit, set automatically after verifying connected bank account with a zero ACH
. $q = db\q('SELECT DISTINCT uid FROM r_usd t JOIN users u ON u.uid=t.payee WHERE deposit>0 AND u.:HAS_BANK');
	while ($row = $q->fetchAssoc()) {
		$a = r\acct($row['uid']);
		$a->setBit(B_BANKOK);
	}
. $q = db\q('SELECT DISTINCT txid,uid FROM r_usd t JOIN users u ON u.uid=t.payee WHERE deposit=0 AND NOT u.:IS_BANKOK');
	while ($row = $q->fetchAssoc()) {
	  extract($row);
		$a = r\acct($uid);
    $a->verifyBank();
		db\update('r_usd', ray('txid created', $txid, NOW + DAY_SECS), 'txid');
	}
. fixed bug that duplicated recurring gift if invoice was pending
. fixed bug that kept current cashout setting from being shown on Connect page

2018-08-12
. fixed minor mistakes in previous commit
. fixed bug that resulted in getting funds from banks automatically for short accounts even with no refills flag
. fixed bug that resulted in attempts to donate from non members in cron
. fixed order of transactions in transaction history

2018-08-08
. generalized getting of funds as needed (acct::getFunds())
. created r_honors and r_recurs tables, reworking how donations are handled, generalizing to allow recurring gifts to other organizations
. INSERT INTO r_honors (uid,honor,honored,created) SELECT uid,IF(honor='other','honor',honor) AS honor,honored,giftDate AS created FROM r_gifts WHERE honored<>'';
  INSERT INTO r_recurs (payer,payee,amount,period,created,ended) 
	  SELECT g.uid AS payer,26742000000002 AS payee,g.amount,g.often AS period,MIN(g2.giftDate) AS created,
	  IF(MIN(g.completed)=0,0,MAX(g.completed)) AS ended
		FROM r_gifts g LEFT JOIN r_gifts g2 ON g2.uid=g.uid AND g2.often=g.often
		WHERE g.often IN ('Y','Q','M')
		GROUP BY g.uid,g.often
		ORDER BY MIN(g2.giftDate)
. $q = db\q('SELECT g.uid FROM r_gifts g JOIN users u ON u.uid=g.uid WHERE often=1 AND activated=0');
	while ($row = $q->fetchAssoc()) {
		extract($row);
		$a = a($uid);
		$a->stepDone('donate', FALSE); // force re-donate (regular or not at all)
	}
. find r_recurs dups and delete the oldest
  SELECT * FROM r_recurs r WHERE (SELECT COUNT(id) FROM r_recurs r2 WHERE r2.payer=r.payer)>1 ORDER BY id
. find givers in r_gifts w no actual non-roundup non-crumb donation, with hasBank and no refill. Warn them about impending bank withdrawal to fund their chosen donation. Create an invoice for those with no regular donation or abandon them. Subject: IMPORTANT: your Common Good account
  $sql = 'SELECT g.uid,u.fullName,g.amount,g.often,g.honor,g.honored,g.giftDate FROM r_gifts g JOIN users u ON u.uid=g.uid LEFT JOIN r_txs t ON t.payer=u.uid AND t.payee=26742000000002 AND t.:IS_GIFT AND NOT t.:IS_ROUNDUPS AND NOT t.:IS_CRUMBS WHERE t.xid IS NULL AND u.:HAS_BANK AND NOT u.:IS_REFILL AND NOT completed AND u.:IS_OK';
	$q = db\q($sql); $s = '';
	while ($row = $q->fetchAssoc()) {
		extract($row);
		$a = a($uid);
		$created = u\fmtDate($giftDate);
		$gift = u\fmtAmt($amt0 = $amount) . ($often == 'M' ? ' Monthly' : ($often == 'Q' ? ' Quarterly' : ($often == 'Y' ? ' Yearly' : '')));
		if ($honored) $gift .= '[i] in ' . ($honor == 'memory' ? $honor : 'honor') . " of $honored [/i]";
		$s .= "$fullName &lt;$a->email&gt;: [p]Dear $fullName,[/p][p]Due to a glitch in our Common Good donation system, your chosen contribution of $gift was never transferred from your bank account. We have fixed that problem, but I wanted to give you a heads-up before the transfer request takes effect.[/p][p]If for any reason this completion of your intended donation is problematic this week, please just let us know before Friday 8/10.[/p][p]With many thanks again for your support,[br]William[/p][br]\r\n\r\n";
		if ($often == '1') {
			$info = ray('payer,payee,amount,period,created,lastTx,invoiced', $a->id, CGID, $amt0, $often, NOW, 0, 0);
/**/      debug($fullName . ': ' . (r\acceptGift($info) ? 'accepted NOW' : 'later'));
		}
	}
/**/	echo $s;

2018-08-03
. fixed stats bug that undercounted members by omitting slaves in joint accounts (284 vs 275)
. fixed bug that kept non-member representatives from a participating business sign in with their card
. revised RFP (r_proposals and formProposal) to handle multiple communities and variable data

2018-07-18
. `created` and `modified` fields now get updated automatically in cg-db.inc
. changed multiple choice voting ratings to use icons
. added a yes/no question type in voting
. fixed bug that prevented joins (trying to copy bankAccount to other account)
. fixed cron bug that increased joint account credit lines every month. Fixed data with:
	eachA(function ($a) {
		$uid = $a->id;
		$monthly = db\get("GREATEST(SUM(IF(payee=$uid, amount, 0)), SUM(IF(payer=$uid, amount, 0)))/6",  'r_txs');
		$floorX = $a->o_floor;
		$rewards = $a->o_rewards;
		$floor = round(min(-$monthly, max(-.9 * .9 * $rewards, $floorX)), 2);
    $a->update(compact('floor'));
	}, 'jid');


2018-07-07 v3.40y
. added buttons for listing "my coupons" and all discounts
. created a "goto 2 pages" function (used, for example, when generating coupons)
. changed donation descriptions, to track regular, roundups, and crumbs separately
. repaired voting so it works again (after eliminating in-line scripts several months ago)

2018-07-05 v?
. separated changes in member data out to separate table

2018-06-25 v3.40w
. separated company fields out into r_company
  eachA(function ($a) {
    if (db\exists('r_company', 'uid=' . $a->id)) return;
    $data = $a->data;
    $info = just(CO_FLDS, $data);
    $data = justNOT(CO_FLDS, $data);
    $coFlags = $info['coFlags'];
    foreach (ray('1:1,2:2,3:4,4:6,8:5') as $k=>$v) {
      if (u\getBit($coFlags, $k)) {
        u\setBit($coFlags, $k, FALSE);
        $coType = $v;
      }
    }
/**/    if (!isset($coType)) debug("ERROR no type: coType=$coType $a->fullName");
/**/    if ($coFlags & (u\bit(CO_PRIVATE) - 1)) debug("ERROR leftover: coType=$coType $a->fullName");
    $info['coFlags'] = $coFlags;
    if (isset($info['payrollStart'])) {$info['payrollStart'] += 0; $info['payrollEnd'] += 0;}
///    debug(compact('data', 'coType') + $info);
    $a->update(compact('data', 'coType') + $info);
  }, ':IS_CO');
. added the missing "Requests to Cash Out" button/feature on the Invest page (and the corresponding functionality). 
. fixed a couple bugs in the company profile page (showed wrong photo when signed in, doubled descriptions)
. fixed bug in account deletion that ended with a blank screen

2018-06-11 v3.40u
. stopped recording rewards in transactions
. DELETE FROM r_txs WHERE amount=0 (29,960 rows deleted)
. simplified a lot of code dealing with rewards, since they will be handled as regular txs, if ever
. fixed bug in unused PARTNER account deletion that left orphaned relations
. deleted relations for 17238000000080,25026000000170,26742000000521,26742000000242
. to prevent errors when deleting a user with same name as a previously deleted user:
  ALTER TABLE users DROP INDEX name, ADD KEY `name` (name);
  ALTER TABLE x_users DROP INDEX name, ADD KEY `name` (name);
. buy.inc was not redirecting properly to an arbitrary URL, so I created a goFar() function that relays to the URL via a javascript. A stopgap measure, probably.

2018-06-09 v3.40t
. fixed bug in get.inc that interpreted put requests as get requests (yikes)
  UPDATE r_relations SET otherNum=0 WHERE otherNum IS NULL;
  UPDATE x_relations SET otherNum=0 WHERE otherNum IS NULL
. fixed bug in a() that required archaic qid format

2018-05-20 v3.40s
. make autopay an optional default for third-party signups (TRUE for Co-op Power)
. move the DRAWS bit: UPDATE users SET flags=(flags|(1<<7))-(1<<21) WHERE flags&(1<<21)
. combine relations fields into a flags field (first REBUILD DB)
. $q = db\q('SELECT * FROM r_relations');
  while ($row = $q->fetchAssoc()) {
    extract($row);
    $flags = ($draw << B_DRAW) | ($employee << B_EMPLOYEE) | ($isOwner << B_OWNER) | (($isCustomer == 2) << B_AUTOPAY) | (($isCustomer > 0) << B_CUSTOMER);
    db\update('r_relations', compact('flags', 'reid'), 'reid');
  }
  ALTER TABLE r_relations DROP `draw`, DROP `employee`, DROP `isOwner`, DROP `isCustomer`;
  ALTER TABLE x_relations DROP `draw`, DROP `employee`, DROP `isOwner`, DROP `isCustomer`;
. modified form.inc to include form file when called from formProx
. fixed bug in be\updateRelations that deleted all records instead of just one
  INSERT INTO r_relations SELECT reid,main,other,otherNum,permission,code,data,flags,created FROM x_relations WHERE deleted=1527079924; DELETE FROM x_relations WHERE deleted=1527079924
. cleaned some things up and moved developer.txt to gDrive

2018-05-11 v3.40r
. reviewed all calls to w\say and w\doSay, and u\rayTable, a\showQuery, be\addCell to assure sanity
. strip_tags from all $_POST and $_GET parameters
. added a link on summary page to activate credit line
. repaired ajax system flaws
. ban on spending below zero implemented and automatically recommended to organizers when a ctty has negative demand 3 months in a row
. improved descriptions of charts
. set Yearly as default when donation amount is zero
. don't log secret input (!)
. changed historic floors in stats to total rewards and recent floors to match tail of that
  db\q('DELETE FROM r_stats WHERE id BETWEEN 17318 AND 17322 OR id BETWEEN 17296 AND 17310 OR id BETWEEN 11820 AND 12574');

  $q = db\q('SELECT id,created,ctty FROM r_stats WHERE id < 17311 ORDER BY id DESC');
  while ($row = $q->fetchAssoc()) {
    extract($row);
    if ($ctty == 0) $ctty = 'community';
    
    $table = <<< X
        (SELECT 
         SUM(IF(payer=uid, payerReward, payeeReward)) AS reward
         FROM users u LEFT JOIN r_txs t0 ON uid IN (payer, payee)
         WHERE community=$ctty AND t0.created<$created AND uid>:CANONIC_ACCTS) t
X;
    $floors = 0 - db\sum('reward', $table);
///    flog(compact(ray('id ctty created floors')));
    db\update('r_stats', compact(ray('floors id')), 'id');
  }
$max = db\max('id', 'r_stats');
for ($id = 17358; $id <= $max; $id++) {
  $floors = db\get('floors', 'r_stats', "id=$id-7");
  db\update('r_stats', compact(ray('floors id')), 'id');
}
. changed historic conx and conxLocal:
  $q = db\q('SELECT id,created,ctty FROM r_stats ORDER BY id DESC');
  while ($row = $q->fetchAssoc()) {
    extract($row);
    $cttyCrit = $ctty ? "u0.community=$ctty" : '1';

    $recent = $created - 60 * DAY_SECS; // not n months (keep length of time consistent)
    foreach (ray('conx conxLocal', 1, "u2.community=$ctty") as $k => $crit) {
      if (!$ctty) $crit = 1; // avoid local query when doing stats for ALL cttys
      $table = <<< X
        (SELECT me, COUNT(DISTINCT other) AS conx, SUM(isRecentPayer) AS recentPays, u2.community
          FROM (
            SELECT u0.uid AS me, 
              IF(u0.uid=payer AND t0.created>$recent, 1, 0) as isRecentPayer,
              IF(u0.uid=payer, payee, payer) AS other 
            FROM users u0
            JOIN r_txs t0 ON u0.uid in (payer, payee) 
            WHERE t0.created<=$created AND u0.uid>:CANONIC_ACCTS and NOT u0.:IS_CO AND $cttyCrit
          ) t LEFT JOIN users u2 ON u2.uid=other WHERE $crit AND u2.uid>:CANONIC_ACCTS
          GROUP BY t.me
        ) u3
X;
      $$k = db\get('AVG(conx)', $table, 'recentPays>0') + 0;
    }
    db\update('r_stats', compact(ray('conx conxLocal id')), 'id');
/**/     if (rand(0, 100)==20) die('now');
  }
. reactivated B_DEBT on advanced preferences
. update r_stats SET conxLocal=0 where conxLocal is null
. implemented coupons! (gift, discount pct, discount amount, automatic / custom)
. added cashout option to Banking Settings page
. eliminated the need for wrapping common form fields in item()
. changed rCredits namespaces to CG
. implemented most of investment club forms
. changed typeWho to restrict results to user's community (unless admin or co)
. added whoami ajax op, for csp-report.php
. UPDATE menu_router SET access_callback=REPLACE(access_callback, 'rCredits\\', 'CG\\'), page_callback=REPLACE(page_callback, 'rCredits\\', 'CG\\')
. separated most form functions out each into its own file in forms/
. fixed timezone problem in gherkin compiler
. to update: copy all files, DROP TABLE menu_router, and import it from DEV

2018-04-15 version 3.40d
. fixed V-decryption to return the data unaltered, if user does not have permission
. re-encrypted r_request and r_invites email and phone
  $q = db\q("SELECT id,email AS old FROM r_invites WHERE email LIKE '!%'");
  while ($row = $q->fetchAssoc()) {
    extract($row);
    $email = u\decryptN($old);
///    if (strlen($old) > 1 and !ctype_print($email)) debug("$id: $email");
    $email = u\cry('P', $email);
    db\update('r_invites', compact(ray('email id')), 'id');
  }
  $q = db\q("SELECT listid,email,phone FROM r_request");
  while ($row = $q->fetchAssoc()) {
    extract($row);
    if ($email == '!') $email = '';
    if ($phone == '!') $phone = '';    
    $email = @$email[0] == '!'? u\decryptN($email) : $email;
    $phone = @$phone[0] == '!'? u\decryptN($phone) : $phone;
///  if (strlen($row['email']) > 1 and !ctype_print($email)) debug("$id: $email");
///  if (strlen($row['phone ']) > 1 and !ctype_print($phone )) debug("$id: $phone ");
    $email = u\cry('P', $email);
    $phone = u\cry('P', $phone );
    db\update('r_request', compact(ray('email phone listid')), 'listid');
  }
. removed dregs of Drupal's autocomplete (bug fix)
. added Upload Payments option to Pay tab
. renamed Charge tab to Request
. changed back to using floor as credit limit (but easing people off of that)
. redesigned stats db and charts
. changed r\deleteAccount() to handle deleting a community (merging it back into Seedpack)
. fixed bug whereby browser was storing a recently viewed account-photo as the default for new member
. fixed bug that prevented background ssn check (by moving drupal and user scripts to the end
. set everyone's floor to a compromise between what it should be and what rewards give them AND set debt bit if their balance is already negative:
  $today = strtotime('today');
  $timeSince = "(ROUND(($today-@DATE)/:DAY_SECS, 0))"; // $today works better in tests than :REQUEST_TIME or time()
  $elapsed = str_replace('@DATE', 'date0', $timeSince);
  $months = "ROUND($elapsed/:MONTH_DAYS)";
  $start = strtotime('-6 months', $today);

  $sql = <<< X
    SELECT uid, $months AS months, GREATEST(inVol, outVol) AS monthly 
    FROM (
      SELECT uid, u.flags, MIN(t.created) AS date0, 
      SUM(IF(t.created>=:start AND payee=uid, amount, 0))/6 AS inVol,
      SUM(IF(t.created>=:start AND payer=uid, amount, 0))/6 AS outVol
      FROM users u LEFT JOIN r_txs t ON uid IN (payer, payee) GROUP BY uid
    ) t 
    WHERE uid > 1 AND :IS_OK
  X;
  $q = db\q($sql, compact('start'));
  while ($row = $q->fetchAssoc()) {
    extract($row);
    $a = r\acct($uid);
    
    $current = -$a->rewards;
    $floor = round(min(-$monthly, .9*$current, $a->activated < time()-YEAR_SECS ? 0 : -20), 2);
    
    $a->update('floor', $floor);
    $bal = $a->balance;
    if ($bal < 0 and !$a->debt) {
      if ($jid = $a->jid and $a2 = r\acct($jid)) $bal += $a2->balance;
/**/  if ($bal < 0) {$a->setBit(B_DEBT); debug("setting $a->fullName to allow debt. Balance=$a->balance");}
    }
    
/**/   debug("$a->fullName: current=" . number_format($current, 2) . " new=" . number_format($floor, 2));
  }
. changed croppic.js and u\alterImg to rotate, drag, and crop pictures without cutting off head
. DELETE FROM `r_stats` s LEFT JOIN r_stats s2 ON s2.created=s.created AND s2.ctty=s.ctty WHERE s2.id<s.id
. reverted form.inc sanitization of input that was making a few things not work (don't sanitize input! sanitize storage and output!)
. added "\" for line breaks in markdown of company descriptions
. added reply parameter to message(), so customers can reply to invoices
. fixed bug in orphaned incomplete (abandoned) partner account selection (so they can be deleted)

2018-04-02
. repaired url-encoded transaction descriptions
  include_once __DIR__ . '/../x.class';
  eachX(function ($x) {foreach (ray('payerFor payeeFor') as $k) {
    if (!strpos($x->$k, ' ')) if (strpos($x->$k, '%') !== FALSE  or (strpos($x->$k, '+') and !preg_match('/[0-9]/', $x->$k))) {
      $x->update($k, urldecode($x->$k));
    }
  }});
. fixed bug that gave all donations to communities and it now subtracts bounce fees
. gave cAdmins permission to activate accounts, added a "carded" bit to tell SuperAdmin to issue card
. UPDATE users SET flags=flags|8 WHERE activated
. made it work with PHP 7.2 (handled deprecated each() and always-defined DATE_RFC7231 and count(string) not defined (was 1))
. changed each() to foreach in TCPDF also
. rewrote page.tpl.php without embedded code
. changed spinLink function to leave single quotes in javascript attributes unencoded
. added a "recrop" button
. changed some dates to include 4-digit year (changed test compiler too)
. moved rlogs to webroot/cgLogs and photos to webroot/cgPhotoTemp
. moved company photos to database
. fixed bug in just() that trimmed values (breaking encryption)
. did away with html format input fields (hence filter and filter_format tables), using markdown instead
. ALTER TABLE x_users DROP PRIMARY KEY, ADD PRIMARY KEY(uid, deleted);
. deleted unused tables: DROP TABLE authmap,file_managed,history,node,node_revision,users_roles,watchdog,r_auth,r_nonces,filter,filter_format
. separated vsecure from secure (REBUILD db) [r\setCryptCook('vKeyPw', u\b64decode('thekey')); before fixing the encrypted data]
. completely reworked encryption and renamed .databases to cg.cnf
. local debug (u\b64encode(a(1)->vKeyPw)); ---> WS a(1)->update('vKeyPw', u\b64decode('thekey')); after fixing a(1)'s secure
. eachR('r_usd', function ($row) {
    $pw2 = r\cryptCook('pw2');
    extract(just('txid bankAccount', $row));
		if (u\oldcrypted($bankAccount)) $bankAccount = u\decryptM($bankAccount, 0, $pw2);
		if (!u\starts($bankAccount, 'USkk')) return w\say('bad bank account(?) in txid ' . $txid . ": $bankAccount");
		$bankAccount = u\cry('V', $bankAccount);
    db\update('r_usd', compact(ray('txid bankAccount')), 'txid');
  }, 'bankAccount IS NOT NULL');
. eachR('r_photos', function ($row) {
    extract(just('uid photo', $row));
		if (u\oldcrypted($photo)) $photo = u\decryptM($photo);
		if (!$photo) return w\say('bad photo uid ' . $uid);
		$photo = u\cry('H', $photo);
    db\update('r_photos', compact(ray('uid photo')), 'uid');
  }, '1');
. eachR('users', function ($row) {
    extract(just('uid fullName phone mail', $row));
		foreach (ray('mail phone') as $k) {
		  $k0 = $$k;
		  $$k = u\decry('P', $$k);
			if ($k0 and !$$k) return w\say("bad $k for member $uid $fullName: $k0/" . $$k);  
			$$k = u\cry('P', $$k);
	  }
		db\update('users', compact(ray('mail phone uid')), 'uid');
  }, '1');	
. eachR('users', function ($row) { 
    $pw2 = r\cryptCook('pw2');
    extract(just('uid fullName changes', $row));
		if (strlen($changes)) { // do this first
		  if (u\oldcrypted($changes)) $changes = u\decryptM(u\decryptM($changes, 1), 0);
			if (u\crypted('S', $changes)) $changes = u\decry('S', $changes);
			$changes = unserialize($changes) ?: [];
			if (!is_array($changes)) return w\say('bad changes in member ' . $fullName);
			foreach ($changes as $dt => $ch) {
				if (is_array($ch)) foreach ($ch as $k => $v) {
				  if (!strlen($v)) continue;
				  if (in_array($k, ray(R_VSECURE_FLDS))) {
					  if (u\oldcrypted($v)) $v = u\decryptM($v, 0, $pw2);
            if (u\crypted('V', $v)) $v = u\decry('V', $v)						;
					  if (!$v or !ctype_print($v)) {
						  w\say("bad change in member $fullName dt=$dt k=$k v=$v");
							$v = '?';
					  }
						$ch[$k] = u\cry('V', $v);
				  } elseif (in_array($k, ray(R_HIDE_CHANGES))) unset($ch[$k]);
				}
				if (!is_array($ch)) w\say('bad change array in member ' . $fullName . ': ' . $ch);
				if (is_array($ch) and $ch) $changes[$dt] = $ch; else unset($changes[$dt]);
			}
			if ($changes) $changes = u\cry('S', serialize($changes)); else $changes = '';
			db\update('users', compact('changes', 'uid'), 'uid');
		}
  }, '1');
. eachR('users', function ($row) {
    $pw2 = r\cryptCook('pw2');
    extract(just('uid fullName activated secure', $row));
		if (strlen($secure)) {
		  $secure = u\crypted('S', $secure) ? u\decry('S', $secure) : u\decryptM(u\decryptM($secure, 1), 0);
			$vsecure = [];
			if (!$secure = unserialize($s0 = $secure)) return w\say('bad secure serial in member ' . $fullName . ' was ' . $s0);
			if (!is_array($secure)) return w\say('bad secure array in member ' . $fullName . ': ' . $secure);

			$v = $secure['ssnData'];
			if (!is_array($v) and u\oldcrypted($v)) {
			  if (!$v = u\decryptM($v, 0, $pw2)) return w\say('bad ssnData encryption in member ' . $fullName);
			}
			if ($v and !is_array($v)) $v = unserialize($v);
			if ($v) $secure['ssnData'] = $v; else unset($secure['ssnData']);

			foreach (ray(R_VSECURE_FLDS) as $k) {
				if (strlen($v = u\decryptM($secure[$k], 0, $pw2))) {
				  $vsecure[$k] = $activated ? u\cry('V', $v) : $v;
					unset($secure[$k]);
				}
			}
			$secure = u\cry('S', serialize($secure));
			$vsecure = u\cry('S', serialize($vsecure));
			db\update('users', compact(ray('secure vsecure uid')), 'uid');
    }
  }, '1');	
. renamed photos to accommodate recropping
  $s = file_get_contents(DRUPAL_ROOT . '/photos/photos.txt');

  $s = preg_replace('/\.000000000 -0[54]00 / ', ',', $s);
  $s = explode("\n", $s);
  foreach ($s as $i => $one) if ($one) {
    $one = str_replace("\r", '', $one); // on DEV
    list($k, $v) = explode(',', $one);
    if (substr($v, 0, 3) == 'no-' or $v == 'not-valid.png') continue;
    $new[strtotime($k)] = $v;
  }
  ksort($new);
  foreach ($new as $dt => $v) {
    $flnm = $v;
    $v = str_replace('.jpg', '', $v);
    if (in_array(substr($v, -4), ray('-bad -alt'))) $v = substr_replace($v, '', -4);
    if (in_array(substr($v, -2), ray('.X .0 -0 .bad .alt'))) $v = substr_replace($v, '', -2);
    if (in_array(substr($v, -2), ray('.X .0 -0 .bad .alt'))) $v = substr_replace($v, '', -2);

    $uid = substr($v, 0, 14);
    if (is_numeric($uid)) {
/**/  if ($v[14] != '-') die('should be dash:' . $v);
      $after = substr($v, 15);
    } else {
///      if (is_numeric($uid)) debug($v);
      $dashes = substr_count($v, '-');
      $parts = explode('-', $v);
      $after = $parts[$dashes]; unset($parts[$dashes]);
      $nm = urldecode(join('-', $parts));
      $nm = str_replace('_', ' ', $nm);
      $uid = db\get('uid', 'users', 'fullName=:nm', compact('nm'));
    }
    if ($uid and $a = a($uid)) {
///      debug("uid=$uid after=$after flnm=$flnm");
      $photo = file_get_contents(DRUPAL_ROOT . '/photos/' . $flnm);
      if ($a->co) $a->update(compact('photo'));
      if (!$a->carded or $a->activated > time() - 20 * DAY_SECS) { // not certainly activated so keep temp photo
        file_put_contents(DRUPAL_ROOT . "/../cgPhotoTemp/$a->mainQid.jpg", $photo);
      }
/**/} //else debug("uid=$uid after=$after flnm=$flnm");
  }
. fixed bug that doubly serialized vsecure (and maybe secure)
. fixed data:
  define('FORREAL', 0);
  eachA(function ($a) {
    foreach (ray('secure vsecure changes') as $fld) {
      if (!$s = db\get($fld, 'users', 'uid=' . $a->id)) continue;
      if (!u\crypted('S', $s)) {
/**/    debug("account $a->fullName $a->id has $fld not S-encrypted");
/**/    if (u\crypted('V', $s)) die("account $a->fullName $a->id has $fld V-encrypted: " . u\decry('V', $s));
/**/  }
      if (u\crypted('S', $s)) {
        $s = u\decry('S', $s);
        if (u\crypted('S', $s)) {
          db\update('users', ['uid' => $a->id, $fld => $s], 'uid');
/**/      debug("account $a->fullName $a->id $fld is S-crypted within (fixed)"); 
        } elseif (u\crypted('V', $s)) {
/**/      if (u\crypted('V', $s)) die("account $a->fullName $a->id has $fld inner V-encrypted: " . u\decry('V', $s));
          $s = u\decry('V', $s); 
          $s = u\cry('S', $s);
          db\update('users', ['uid' => $a->id, $fld => $s], 'uid');
/**/      debug("account $a->fullName $a->id $fld is V-crypted within (fixed)"); 
/**/    } elseif ($s !== '' and !is_array(@unserialize($s))) {debug("account $a->fullName $a->id bad S-crypt (not a serialized array)"); continue;}
      }
    }
    $secure0 = $secure = $a->secure;
    foreach (ray(R_VSECURE_FLDS) as $k) {
      if ($v = @$secure[$k]) {
/**/    if (!@$a->$k) {
          if (FORREAL) $a->update($k, $v); 
/**/          debug("account $a->fullName $a->id $k wasn't in vsecure!");
        }
        unset($secure[$k]);
      }
    }
    if ($secure != $secure0) {
      if (FORREAL) $a->update(compact('secure'));
/**/    debug("account $a->fullName $a->id removing fields from secure");
    }
  });
. DROP TABLE r_log
. renamed all .tpl.php to .tpl (minimizing exposure to scripts being run on the server)
. implemented CSP both server side and client side!! this includes chart.php on cg4.us since google charts requires unsafe-inline
. removed a large number of unused drupal modules and other files and folders (requires clearing of cache and session)
. DELETE FROM menu_router WHERE path LIKE 'admin/%' OR path LIKE 'node/%' OR path LIKE 'devel/%' OR path LIKE 'comment/%' OR path LIKE 'taxonomy/%' OR path LIKE 'admin/%'
. finally fixed menu.inc to return a default page-not-found page.
. reinstated the glyphicons, which had gotten deleted. (did not update bootstrap beyond 3.3.4, since it stops working)
. upgraded to jquery-3.1.1
. worked around jquery bug by rewriting a croppic image load function without using jquery

2018-01-05
. ALTER TABLE `users` DROP `postalAddr`;
. removed B_JOINED: eachA(function ($a) {$a->setBit(23, FALSE);});
. created real jid field:
  eachA(function ($a) {
    $data = $a->data;
    if ($jid = @$data['jid']) {
      db\update('users', ray('uid jid', $a->id, $jid), 'uid'); 
      unset($data['jid']);
      $a->update(compact('data'));
/**/  debug($a->fullName);
    }
  });
. fixed bug that was causing corruption of bankAccount in both users and r_usd
. changed R_XFEE_CHECK to zero
. list ($k, $key) = ['photos', 'uid'];
    $tnm = 'r_' . $k; $xtnm = 'x_' . $k;
    db\q("CREATE TABLE $xtnm LIKE $tnm; ALTER TABLE $xtnm MODIFY $key BIGINT NOT NULL; ALTER TABLE $xtnm ADD `deleted` INT(11) NOT NULL DEFAULT '0' FIRST; ALTER TABLE $xtnm DROP PRIMARY KEY; ALTER TABLE $xtnm ADD PRIMARY KEY($key, deleted);");
  }

2017-12-12 version 3.29
. foreach (ray('txs:xid,usd:txid,invoices:nvid,relations:reid') as $k=>$key) {
    $tnm = 'r_' . $k; $xtnm = 'x_' . $k;
    db\q("CREATE TABLE $xtnm LIKE $tnm; ALTER TABLE $xtnm MODIFY $key BIGINT NOT NULL; ALTER TABLE $xtnm ADD `deleted` INT(11) NOT NULL DEFAULT '0' FIRST; ALTER TABLE $xtnm DROP PRIMARY KEY; ALTER TABLE $xtnm ADD PRIMARY KEY($key, deleted);");
  }
. added "once" option back in for donations from existing members who already have a repeat donation
. DROP TABLE queue (then rebuild)
. reworked cron without Drupal
. added a "test" op to the rSmart API, for calling the server's behavioral tests from the app's tests
  
2017-11-20 version 3.26
. added input sanitization filter to form.inc and direct $_POST submissions (rather late in the game)
. fixed resend-verification email bug (was sending password-reset email instead of verify email
. created a preJoin form to ask whether joining with an existing member and if so who
. now shows Bank menu item always, but redirects to Bank Info page if no connection yet.
. changed "Show more" link on Transactions page to suggest clicking the right triangle to see next page.
. changed !isPRODUCTION to NOT_PRODUCTION to avoid typo disasters
. fixed bug in test server showing links normally sent by email
. added semi-automatic record of deleted users, relations, and txs records (in x_users, x_relations, etc.)
. CREATE TABLE x_users LIKE users; ALTER TABLE x_users MODIFY uid BIGINT NOT NULL; ALTER TABLE `x_users` ADD `deleted` INT(11) NOT NULL DEFAULT '0' FIRST; ALTER TABLE x_users DROP PRIMARY KEY; ALTER TABLE x_users ADD PRIMARY KEY(uid, deleted);
. changed txs reversal confirmation (web interface) to use JS
. changed txs history to change dates immediately on selection of period
. fixed bug in daterange that kept dates from getting changed
. company reports page, with daily totals report
. made donating zero a little harder
. made an option for communities to turn off negative rewards ("noneg")
. sped up transactions history page by using simpler hover text and ajax confirmation of reversals
. ajax deletion confirmation on invoices page
. turned page caching back on
. in acct::adminables() fixed bug that set community CGC and UP bits off (but there's probably another such bug)
. deleted 7 fields from users table: status, language, theme, signature, signature_format, timezone, init (leaving 44)
  
2017-10-26 version 3.18
. fixed bug in justNOT (it now handles flat arrays properly), which fixed "How Long" not showing up on error
. added an admin2 bit that parallels cAdmin2 (read only except for making notes) but for all communities (for our Work/Study students)
. fixed a bug in acct::giftDesc() that got the last gift date wrong
. suppressed some fields on Summary page for cAdmin2 and admin2
. fixed a bug in the new streamlined joint account opening that created two accounts
. improved admin calls scripts and moved them to Summary page
. cleaned up Summary page
. added a field to sessions to track what account each member is currently managing
. added USE statements to formPhp
. moved just and justNOT to bootstrap
. created a powerful in() function and a between function
. eachA(function($a) {
    if (!$a->emailCode) $a->update('emailCode', r\cardCode($a->mainQid));
  }, 'uid<>0');
. finished formBuy for pay-with-cg buttons on member websites (limited to companies to minimize scam opportunities)

2017-09-22 version 2.98
. separated approval of invoices from payment
. customers can now pre-approve invoices from a company or person (while paying the first)
. first step is now "signup", not "contact"
. partner signups get an account even if they don't complete the signup step (effective retroactively:)
. $q = f('db.q', 'SELECT reid,code AS customer,data FROM r_relations WHERE other=0');
  $noFrame = TRUE;
  while ($row = $q->fetchAssoc()) {
    extract($row);
    $args = unserialize($data);
    if (@$args['postalCode']) {
      $args['zip'] = @$args['postalCode']; unset($args['postalCode']);
      $args['zip2'] = @$args['postalCode2']; unset($args['postalCode2']);
    }
    extract(f('u.just', 'fullName email', $args));
    if (stripos($fullName, 'test') !== FALSE) continue;
    $other = f('w.newCustomer', $reid, $args);
    f('db.update', 'r_relations', compact(ray('reid other')), 'reid');
    f('r.rMail', 'partner-signup', $email, compact(ray('fullName reid customer noFrame'))); // so customer can continue
  }
. you can now invoice a not-yet member
. cashout bit lets accounts cashout all but a week's worth of gross automatically (weekly)
. admin call details are now specific to each account
. unpaid invoices get sent a reminder (to both parties)
. members can now open a joint account -- and make it joint -- at the same time

2017-09-14 version 2.97
. monthly notifications to admin to send paper statements
. links in Welcome and Annual notices to suggested language and volunteer options
. include partial month roundups in displayed and functional balance
. use last second of previous month as roundup donation date
. automate distribution of 50% donations monthly to official CGCs (maybe set Greenfield's percentage to 10%)
. UPDATE r_txs SET flags=flags|(1<<10) WHERE payer=26742000000002 and payee<0
. delay Welcome to 6 weeks if no donation or in Seedpack:
  UPDATE users u SET tickle=activated+6*7*24*60*60 WHERE tickle=activated+2*7*24*60*60 AND (community=-26742000000001 OR (flags&(1<<8)=0 AND IFNULL(crumbs, 0)=0 AND (SELECT SUM(amount) FROM r_gifts g WHERE g.uid=u.uid) = 0))
. invoice upload now only allows account ID
. improved social return language and included total donations to date
. improved Customer list, showing "NOT BEGUN" and "in process", as well as account ID
. did away with PIN
. did away with B_BONA
. UPDATE users SET floor=0
. Find and fix erroneous roundups using
    for ($m = 1; $m < 8; $m++) {
      $start = strtotime("$m/1/2017");
      $end = strtotime(($m+1) . '/1/2017')-1;
      $sql = "SELECT uid, fullName, SUM(1-MOD(amount, 1)) AS shouldDonate FROM r_txs t JOIN users u ON u.uid=t.payer WHERE t.:IS_ROUNDUP AND amount>0 AND MOD(amount, 1)>0 AND t.created BETWEEN $start AND $end GROUP BY payer";
      $q = f('db.q', $sql);
      while ($row = $q->fetchAssoc()) {
        extract($row);
        $line[] = "$m: $uid $fullName -- $$shouldDonate";
      }
    }
/**/    debug(join("\n", $line));
    DELETE FROM r_txs WHERE amount=0 AND payerReward=0 AND payeeReward=0
    SELECT MONTH(FROM_UNIXTIME(created)) AS m,t.* FROM r_txs t WHERE flags&(1<<7) ORDER BY MONTH(FROM_UNIXTIME(created)), payer
    (two transactions were missing:)
    INSERT INTO `r_txs` (`xid`, `serial`, `type`, `flags`, `goods`, `amount`, `payer`, `payee`, `payerAgent`, `payeeAgent`, `payerFor`, `payeeFor`, `payerReward`, `payeeReward`, `payerTid`, `payeeTid`, `data`, `channel`, `created`, `box`, `risk`, `risks`) VALUES
    (75043, 75043, 0, 1152, 0, '0.00', 17238000000003, 26742000000002, 17238000000003, 26742000000002, 'contribution of rounded-up payment change', 'donation: of rounded-up payment change', '0.00', '0.00', 82, 4950, '', 5, 1491023539, 0, NULL, 0),
    (83822, 83822, 0, 1152, 0, '0.94', 17238000000036, 26742000000002, 17238000000036, 26742000000002, 'donation: of rounded-up payment change', 'donation: of rounded-up payment change', '0.09', '0.01', 11, 5172, '', 5, 1501564094, 0, -0.0630677, 2048);
    after fixing transaction amounts and dates (last second of previous month), fix cache with $a = a($uid); $a->cacheOk();
. Added a "Ask me in a few weeks" button to donations page

2017-08-26 version 2.91
. removed restrictions on signing up (anyone can sign up)
. added a continuation email to partner signup people in case they don't complete the first page
. created admin followup call page
. created New Note field on Summary page (for cAdmins instead of editing notes field directly)
. created tickle feature for admin calls
. eachA(function($a) { // add 'ssn' step to not-yet-member accounts and attempt to verify SSN
  if ($a->member or $a->co) return;
  $stepsDoneX = $a->stepsDone;
  if (isset($stepsDoneX['ssn'])) return;
  $stepsDone = f('r.stepsDone0'); foreach (ray('company relations') as $k) unset($stepsDone[$k]);
  foreach ($stepsDone as $k => $v) $stepsDone[$k] = (bool) @$stepsDoneX[$k];
  $a->update(compact('stepsDone'));
  $a->ssnCheck();
});
. eachA(function($a) { // set tickle for every active account
  if (!$a->activated or !$a->ok) return;
  if (time() - $a->activated < 30 * DAY_SECS) {
    $tickle = $a->activated + TICKLE_WELCOME * DAY_SECS;
  } else {
    $tickle = time() - 1;
    for ($i = 1; $tickle < time(); $i++) $tickle = strtotime("+$i years", $a->activated);
  }
  $a->update(compact('tickle'));
});
. UPDATE users u LEFT JOIN r_relations r ON r.other=u.uid SET flags=flags|(1<<21) WHERE draw
. fixed bug that kept source field from showing
. split Summary page into two columns for admins and rearranged fields

2017-08-15
. fixed bug that resulted in "1020" instead of "MA" in postalAddr
. limited proxy choices to same city/state or placeholders for new seedpack members
. limited proxy choices to active accounts (or placeholders)
. $keys = ray('uid community name fullName email');
  foreach (ray(t('2:PlaceHolder One,3:PlaceHolder Two')) as $k => $v) {
    $name = str_replace(' ', '', strtolower($v));
    $values = array($k, 0, $name, $v, 'z@o.t');
    $info = array_combine($keys, $values);
    new CG\Acct($info);
  }
. added a copy-ach-filename-to-clipboard button
. changed Mailchimp export to tabs, because they stopped accepting it with commas
. repaired risks data (dobOff, poBox, fishy) -- for n=16 to 18 (losing some minimal dobOff and fishy data)
  UPDATE users SET risks=risks-(1<<n) where risks&(1<<n)
. fixed bug which prevented calling setPostalAddr on signup form submission
. stopped marking (some) r_request records as "member" in exports
. changed area of CG Greenfield to ^013([012346789]|5[012346789]) because ^013(?!(55|66|31|68)) fails
. changed area of CG Noho to ^010(0[2347]|11|12|26|27|3[23589]|40|5[0349]|6[01236]|7[0235]|8[248]|9[368]) but 01040 (Holyoke) might go south later and Amherst will surely split off
. corrected individual communities accordingly (about 30):
eachA(function($a) {
$FIN = a('!NEWAAC')->id;
$BENE = a('!NEVAAB')->id;
if ($a->id > 1 and $a->community and $a->community != $FIN and $a->community != $BENE) {
  $ctty2 = f('r.communityUid', $a->zip);
  if ($ctty2 and $ctty2 != $a->community) {
    $old = $a->cttyA->fullName;
    $new = a($ctty2)->fullName;
///    debug("$a->zip &nbsp; $a->fullName: $old >>> $new");
    $a->update('community', $ctty2);
  }
}
});
. fixed bug in member export that failed for non-chimp exports by cAdmins

2017-08-01 version 2.83
. extensive rephrasing of agreement and its hyperlinks to accommodate Co-op Power volunteers
. new SSN step to verify SSN or Birthdate if it can't be done automatically
. added dobOff risk flag
. added a Skip button to each step

2017-07-14 version 2.81
. fixed invoice link bug that crashed if wrong person was current
. event reporting (without comments)
. "Customers" query for partners
. renamed postalCode field "zip" (in users, r_regions, and code) for conciseness (but it still applies to other countries' postal codes):
    ALTER TABLE `users` CHANGE `postalCode` `zip` VARCHAR(255) CHARACTER SET utf8 COLLATE utf8_unicode_ci NULL DEFAULT NULL;
    ALTER TABLE `r_regions` CHANGE `postalCode` `zip` VARCHAR(255) CHARACTER SET utf8 COLLATE utf8_unicode_ci NOT NULL;
. reworked address input to be clearer
. fixed bug that discarded radio buttons on error
. put photo step last
. fixed bug that failed to set tx flags
. added comments to vote reports
. added temporary backup of photos on upload (in case we need to recrop)
. fixed bug in redirect to formEmpty when signed out, that discarded any messages
. repaired recent tx flags:
  use CG\Util as u;
  eachX(function($x) {
    foreach (ray('type flags') as $k) $$k = $x->$k;
    if ($type != TX_TRANSFER) return;

    if ($data = $x->data) {
      extract($data);
      foreach (ray(TX_FLAGS) as $k) if (@$$k) {
        u\setBit($flags, u\consta('b', $k));
        unset($data[$k]);
      }
    }
    if (@$undoneBy) u\setBit($flags, B_UNDONE);
    if (@$force == 1) u\setBit($flags, B_OFFLINE);
    if (@$force != -1) unset($data['force']);

///    if ($flags > 1024 and $x->flags < 1024) {print_r($x); print_r(compact(ray('flags data'))); die();}
    $x->update(compact(ray('flags data')));
  });

2017-06-27 version 2.74
. implemented signups with partial data directly from (and reporting to) partner site
. fixed bug that allowed companies to vote by direct link
. worked around PHP anomaly (crash) on use of null object return from a function (specifically @r\acct()->field)
. added mailChimp question to admin member list export
. gave cAdmin permission to change tx dates (within a month)
. fixed bug that drew too much from bank when old committed field was non-zero
. added running balance to transaction history

2017-06-16 version 2.71
. created r_events table and revised democracy page (renamed Democracy Events)
. ALTER TABLE `r_questions` DROP `ctty`, DROP `repeats`, DROP `repeatedBy`, DROP `endIdeas`, DROP `endProposals`, DROP `endVoting`, DROP `endGrading`, DROP `linkIdeas`, DROP `linkProposals`, DROP `modified`;
. UPDATE `r_questions` SET event=1
. UPDATE `r_proposals` SET event=3

2017-06-16
. update includes/menu.inc
. invoice uploads
. co-branding partner collaborative signups
. removed B_CLOSED (now $a->closed means: activated and !ok) and deleted never-activated closed accounts:
  $list = f('db.col', 'uid', 'users', 'activated=0 AND flags&(1<<26)'); foreach ($list as $uid) f('r.deleteAccount', $uid);
  UPDATE users SET activated=GREATEST(created,signed) WHERE (flags&(1<<2)) AND !activated
  UPDATE users SET flags = flags-(1<<26) WHERE (flags&(1<<26))
. switched domain name from new.rcredits.org to new.CommonGood.earth (finally)
. UPDATE r_usd SET amount=-amount (reversed sign on usd exchange table)
. ALTER TABLE `r_usd` CHANGE `payer` `payee` BIGINT(20) NULL DEFAULT NULL COMMENT 'CG account ID';
. added CgBiz form to handle CG Business certification

2017-05-11 version 2.66
. INSERT INTO `new_rcredits`.`r_banks` (`route`, `branch`, `fedRoute`, `type`, `modified`, `newRoute`, `name`, `address`, `city`, `state`, `zip`, `phone`, `status`, `view`) VALUES ('062201601', NULL, '062201601', '0', '090215', NULL, 'BBVA Compass', '701 South 32nd Street', 'Birmingham', 'AL', '352330000', '8002667277', NULL, NULL);
. added descriptions to flags on Summary page (but popovers are clunky)
. rewrote rebuildDb utility on Handy menu
. communities can set required invites -- default is OFF
. communities can set explicit incentive rewards -- default is OFF
. changed popovers to click rather than hover, on Summary page
. created r_ips to track IP addresses used by CG members (for whitelisting on our server)
. minimum donation is now zero
. invitations are no longer required
. update Drupal files: includes/install, cache, common, menu, module, session modules/system block node
. remake tables
. f('db.q', 'DROP TABLE IF EXISTS actions,authmap,batch,blocked_ips,block_custom,block_node_type,block_role,cache_block,cache_field,cache_filter,cache_page,cache_path,cache_update,date_formats,date_format_locale,date_format_type,field_config,field_config_instance,file_managed,file_usage,history,node,node_access,node_revision,node_type,offsite,role,role_permission,sequences,sms_carriers,url_alias,users_roles,watchdog');
. eachA(function($a) {
    if (!$a->co and ($photo = $a->photoX)) f('db.insert', 'r_photos', ray('uid photo', $a->id, $photo));
  });
. ALTER TABLE users DROP column photo
. added gift bits to transaction flags field
. updated tcpdf to version 6.2.13
. rewrote payroll upload validation to not use file_managed
. run "special" code to restructure transaction rewards:
function special() {
  if (!db\exists('r_txs', 'type<0')) return;
  db\q('DELETE FROM r_txs WHERE type<0'); // zap rebates and bonuses
  
  eachX(function($x) {
    foreach (ray('type goods flags taking amount') as $k) $$k = $x->$k;
    if ($goods == FOR_SHARE) {
      list ($payerReward, $payeeReward, $amount) = [-$amount, $amount, 0];
    } elseif ($type == TX_TRANSFER) {
      $data = $data0 = $x->data ?: [];
      if ($data) extract($data);
      if (@$rebate or @$bonus) list ($payerReward, $payeeReward) = [@$rebate, @$bonus];
      unset($data['rebate']); unset($data['bonus']);
      foreach (ray(TX_FLAGS) as $k) if (@$$k) {
        u\setBit($flags, u\consta('b', $k));
        unset($data[$k]);
      }
      if (@$undoneBy) u\setBit($flags, B_UNDONE);
      if (@$force == 1) u\setBit($flags, B_OFFLINE);
      if (@$force != -1) unset($data['force']);
    } elseif ($type > 0 and $type <= TX_FINE and $amount+0) { // reward 
      $payeeReward = $amount;
      $amount = 0;
    } else return; // no change needed

    $x->update(compact(ray('flags amount payerReward payeeReward data')));
  });
}

function special2() {
  eachA(function($a) {
    list ($balance, $rewards) = [$a->r-$a->rewards, $a->rewards]; // remember old values
/**/    if (!$a->cacheOk(FALSE, FALSE) and (abs($a->balance - $balance) > .005 or abs($a->rewards - $rewards > 20))) debug("$a->id $a->fullName new: $a->balance+$a->rewards old: $balance+$rewards jid=$a->jid");
  });
}

2017-03-07 version 2.65
. in commongood.earth/whm: whmapi1 suspend_outgoing_email user=example in WHM's API Shell interface (Home >> Server Configuration >> Tweak Settings, activate API Shell, Home >> Development >> API Shell) users: cogobank, s2be, rc4, game, stage
. name ambiguity resolution (for Pay and Charge) wasn't working since using hidden opid field for op() function
. a('aaa')->update('special', ''); was not updating the field because special was listed as part of the data field
. now using SwiftMailer and DKIM authentication
. Crumbs feature (members can donate a percentage of each incoming transaction)
. superAdmin versus admin feature
. new CG Card design and improved conversion automation
. (re)prepared code for team development
. put third-party software (apart from Drupal and Drupal modules) in /vendors
. moved /sites/all/themes/rcredits to /rcredits and renamed it "theme"
 . moved /sites/all/modules/rcredits to root (rcredits is no longer entirely a module, for example reinstall does not work)
 - UPDATE `system` SET `filename` = 'rcredits/theme/theme.info' WHERE `filename` = 'sites/all/themes/rcredits/rcredits.info';
 - UPDATE system set info='a:14:{s:4:"name";s:8:"rCredits";s:11:"description";s:80:"A variation on Responsive Bartik (pre-release 2012-08), for the rCredits System.";s:7:"version";s:3:"1.0";s:4:"core";s:3:"7.x";s:11:"stylesheets";a:2:{s:3:"all";a:3:{s:14:"css/layout.css";s:29:"rcredits/theme/css/layout.css";s:13:"css/style.css";s:28:"rcredits/theme/css/style.css";s:14:"css/colors.css";s:29:"rcredits/theme/css/colors.css";}s:5:"print";a:1:{s:13:"css/print.css";s:28:"rcredits/theme/css/print.css";}}s:7:"regions";a:18:{s:6:"header";s:6:"Header";s:4:"help";s:4:"Help";s:8:"page_top";s:8:"Page top";s:11:"page_bottom";s:11:"Page bottom";s:11:"highlighted";s:11:"Highlighted";s:8:"accounts";s:16:"Account selector";s:8:"featured";s:8:"Featured";s:7:"content";s:7:"Content";s:13:"sidebar_first";s:13:"Sidebar first";s:14:"sidebar_second";s:14:"Sidebar second";s:14:"triptych_first";s:14:"Triptych first";s:15:"triptych_middle";s:15:"Triptych middle";s:13:"triptych_last";s:13:"Triptych last";s:18:"footer_firstcolumn";s:19:"Footer first column";s:19:"footer_secondcolumn";s:20:"Footer second column";s:18:"footer_thirdcolumn";s:19:"Footer third column";s:19:"footer_fourthcolumn";s:20:"Footer fourth column";s:6:"footer";s:6:"Footer";}s:8:"settings";a:1:{s:20:"shortcut_module_link";s:1:"0";}s:6:"engine";s:11:"phptemplate";s:8:"features";a:9:{i:0;s:4:"logo";i:1;s:7:"favicon";i:2;s:4:"name";i:3;s:6:"slogan";i:4;s:17:"node_user_picture";i:5;s:20:"comment_user_picture";i:6;s:25:"comment_user_verification";i:7;s:9:"main_menu";i:8;s:14:"secondary_menu";}s:10:"screenshot";s:40:"sites/all/themes/rcredits/screenshot.png";s:3:"php";s:5:"5.2.4";s:7:"scripts";a:0:{}s:5:"mtime";i:1354818426;s:14:"regions_hidden";a:2:{i:0;s:8:"page_top";i:1;s:11:"page_bottom";}}' WHERE name='rcredits' AND type='theme'
  - UPDATE `registry_file` SET filename=REPLACE(filename, 'sites/all/modules/rcredits', 'rcredits') WHERE filename LIKE 'sites/all/modules/rcredits%';
  - UPDATE `system` SET filename=REPLACE(filename, 'sites/all/modules/rcredits', 'rcredits') WHERE filename LIKE 'sites/all/modules/rcredits%';
  - UPDATE `registry` SET filename=REPLACE(filename, 'sites/all/modules/rcredits', 'rcredits') WHERE filename LIKE 'sites/all/modules/rcredits%';
  - UPDATE `menu_router` SET include_file=REPLACE(include_file, 'sites/all/modules/rcredits', 'rcredits') WHERE include_file LIKE 'sites/all/modules/rcredits%';
  - TRUNCATE cache
  - list_themes(TRUE);

2017-01-29 version 2.60
. Changed in the agreement: "I understand I may receive some rCredits" rather than "...will receive..." AND removed "Once my geographic area becomes a Common Good Community"
. Changed in agreement: "before my rCredits community has declared itself ready to allow cashing out Incentive Rewards"
. removed sharing feature
. made rewards feature contingent on TRUE/FALSE setting of $mya->cttyRewardy (in preparation for community option to offer rewards). Default is FALSE (effectively removing the incentive rewards feature at this time, but rewards are still tracked as separate transactions, pending additional code to calculate balances differently depending on the setting)
. when not rewarding, Pay and Charge forms show no "goods" field
. when not rewarding, rewards are no longer shown in transaction history or statements (but still shown in downloads)

2017-01-18 version 2.59
. implemented roundup feature (donation of fractional dollars on all payments)
. "sharing" donations are now only in advanced settings (not asked about during signup)
. created flags field in r_txs (rather elegantly) and moved the taking field there (along with a roundup flag)
. ALTER TABLE r_txs	CHANGE taking flags bigint(20) unsigned NOT NULL DEFAULT '0' COMMENT 'boolean permissions and state flags'
. ALTER TABLE r_log DROP COLUMN special
. removed the give-back-rewards feature
. changed 1099B function to NOT include rewards
. fixed bug in tellCO that omitted identity
. fixed bug in log file display for rCOs
. moved a couple functions into x class, to simplify code
. changed PHP form to not use drupal
. ditched Postmark emailing service (now managing bounces directly)
. combined t() and tt(), perhaps eliminating any outstanding opportunities for malicious cross-site scripting
. abstracted the project name and related constants, to make it easy to rename rCredits to Common Good (or whatever)
. fixed bug that kept anyone from completing the first page of signup
. turned off the "step completed" message (perhaps to be replaced later by "only n steps to go")
. reorganized boot.inc and defs.inc (and a little of rcredits-settings.inc) so more defs are available earlier (for tests)
. reworked setGlobals() as setAcct(), now used consistently for account changes
. moved constantSubs,atag,rayy, and ray to bootstrap.inc

2016-12-20 version 2.52
. implemented grading of proposals

2016-12-15 version 2.51
. radically revised transactions history page to work fast and cool on mobile
. open company account now sets proper steps done
. separated tellCO from tellAdmin
. memberlist links to accounts now actually change the account
. cAdmin now sees a message on Summary page saying where the member would be sent, to complete the signup.

2016-11-07 version 2.49
. sharing donations now come out of rewards (and into CGF's rewards)
. f('db.q', "UPDATE r_txs SET goods=:FOR_SHARE WHERE payerFor=':R_SHARING_MSG' ");
. transaction rewards now decrease by 1% for every $500 of rewards received, down to 1%
. each signup step now leads to the next
. f('y.do1099bs', FALSE, [a('adn')->id => 'Howland Tools', a('ahh')->id => 'New England Dental Wellness', a('afd')->id => '(?)'], [a('afx')->id => ''], 2015);
. updated signup steps for every account: eachA(function($a) {
  $stepsDone0 = $a->stepsDone;
  $stepsDone = f('r.stepsDone0');
  foreach (ray($a->co ? 'proxies connect' : 'company relations') as $k) unset($stepsDone[$k]);
  foreach ($stepsDone0 as $k => $v) if (isset($stepsDone[$k])) $stepsDone[$k] = $v;
  $stepsDone['verify'] = $a->member ?: ($a->co ? FALSE : (array_sum($stepsDone0) > 1));
  $a->update(compact('stepsDone'));
/**/  if ($stepsDone != $stepsDone0) debug(['name'=>$a->fullName] + $stepsDone + ['was' => $stepsDone0]);
});
. finally fixed a problem in recaching that showed up mostly with joint accounts
. monthly cron still runs on the 1st/31st/16th sometimes
. show sum of starting balance on statements
. change statements to forward date order
. put link to back of invites on invitation page and tell admin when somebody prints icards
. UPDATE r_txs SET created=1477976400 WHERE created BETWEEN 1477886400 AND 1477972799 AND (type=3 OR goods=3) (moving 10/31 inflation and sharing transactions to 11/1)

2016-10-14
. requests optionally included in users export
. minor adjustments for new version (2.18) of old app

2016-10-08 verion 2.48
. now sends bad card info to app
. app can now be used by individual accounts
. smart interface notifies device owner of failed offline transactions
. change of cardCode allows recent offline transactions to complete

2016-09-15 version 2.47
. changed Drupal cache to version cache in rc-html.tpl page template (to assure js refresh on version change)
. added "do" parameter to time function in app
. added boxesFld function
. fixed bug: photoId was not getting updated since app version 2.16
. change photoId field to a flag bit (and not a secure field or any field at all)
. eachA(function($a) {
    $a->setBit(B_REFILL, $a->hasBank and $a->minimum+0!=0);
    if ($a->savingsAdd) $a->update('savingsAdd', 0);
    if ($bank = $a->bankAccount) $a->update('last4bank', substr($bank, -4, 4));
  });
. changed "Savings Reserve" to "Credit Reserve" and related changes
. moved refill settings to Bank Info page
. expanded acct::update to handle flag bits and hasBank
. added last4bank field
. changed saveWeekly to apply to minimum, not savingsAdd (savingsAdd is temporarily not used); only one member was actively using saveWeekly, so we increased zir target bal by zir savingsAdd before zeroing savingsAdd
. fixed recordChanges
. added correction capability to forms1099b()

2016-08-17 version 2.45
. fixed op() bug by setting an opid parameter in every form

2016-08-17
. handling hashed tx proof, hashed cardCode, and other improvements to app interface

2016-08-04 version 2.44
. minor bug fixes

2016-07-06 version 2.43
. adjusted acct.class, smart.inc, and qo.class to handle new QRs from old app (release 2.16)

2016-07-02
. Bank page shows wrong amount spendable (see Ivan's email)
. REINSTALL
. f('db.q', 'DROP TABLE r_vetoes');
. upload r_questions and r_options
. copy js\rvote, css\rvote, and images\rvote
. created prox form (and eLinkAcct() function) for no-signin links from emails
. added "special" field to users table (for arbitrary exports)
. radically revised Gherkin compiler, which required reworking steps files, testing functions, and some features.
. debugged voting process and added "range" and "essay" type votes
. added some administrative tools for voting
. f('v.showResults', a('aaa')->community);
. eachA(function($a) {$a->update('special', f('v.showVotes', $a->community, $a->id, 'proxy'));});
. changed invitation cards to say "+ rewards whenever you buy or sell with rCredits." (no "10% at member bizs")
. unfroze companies, so they can spend their rewards as needed
. revised preferences page to show (and modify) savingsAdd rather than savings total

2016-06-09
. don't activate the signup button on rCredits.org until something is typed in the account field (make it a required field!)
. refactored QID handling as a qo (QID object) class
. no explicit weekly savings is required, for negative minimum
. replaced references to "stable and permanent" with just "stable"
. added an "otherNum" field to relations table, so relations identifiers can include main account identifier and still be pretty short
. created a new rCard format: no punctuation in printed account code, QR format is X.RC4.ME/WYZV, where X is the region, W is a format character, Y is the account code without region, Z is the company agent number (otherNum) if any, and V is the card security code. W, Y, and Z are coded with radix 36 (digits first, then capital letters). This higher density code is also used on the magnetic stripe. X will remain coded (for now) as radix 26, because it is visible in the URL. The smart API and qo class recognize both old and new formats. Code for generating rCards in the new format is temporarily deactivated until the new ionic app is used by all current rCredits companies.
. fixed bug that kept A2 cAdmin from receiving invitation requests
. refactored transaction handling as a new class MyX that looks at a transaction from one party's viewpoint
. print QIDs with no spaces! (a 6-character company name will eventually cause ambiguity -- include QID results in choice list!)
. extensive improvements to community democracy, including range-type voting

2016-04-22
. fixed bug that crashed on tx edit (because goods was '0' instead of 0)
. trade deficit is now subtracted from a community's USD
. added external trade activity to banking chart

2016-04-01
. fixed bug that crashed editTx (always): needed htmlspecialchars of hidden field
. for companies, say "Connect to Mainstream Economy (or choose not to)"
. revised POS interface (including use of transaction proof based on public/private key pair)

2016-03-11
. typahead any company in any region. no typeahead for nonlocal individuals, but allow paying by name
. DROP TABLE r_votes and create tables for CG Democracy
. added saveWeekly field (for getting slowly out of debt or building up savings)
. added invitation stats to Summary page
. rewrote makeTables() in rcredits-install.inc, to bypass a Drupal bug
. unset bit B_u4
. put a limit on savings amount
. fixed bug in statements that left page too long to print
. multiple choice voting demo works

2016-02-16
. version 2.33
. added bootstrap typeahead (replacing Drupal's autocomplete) to Message and Tx forms
. changed savings to runny and recreated all stats
  f('db.q', 'TRUNCATE r_stats'); f('cr.cttyStats');
. keep stats on total rewards in manual accounts (that don't refill automatically) that haven't promised to keep a positive primary balance. Also top max(5/5%) total.
. made a clear path for admin to set up and activate a new community: create with New Ctty form, change community of everyone in that community (don't change payer in their rewards transactions unless updating statistics) 
. reworked community bits
. added organizer grant form
. made a way to give rewards back to the community (TX_GIVEBACK = 2). when user pays community or any nonprofit, ask if it's a gift. Record in tx's data field. For donations to the community, redo payer/payee etc so it is a negative reward tx from donor to ctty.
. sessions now time out, with option to keep alive
. do not require separate email address for companies! (they can't sign in anyway)
. tell admin who is eligible for a grant
. disallow +whatever except for gmail (and other services where we know it works)
. outgoing deposit slip list legalName
. photo on Summary page is wrong when coming from Member List
. moved all remaining settings to boot.inc and made setting.php a mere forwarder

2016-01-27
. version 2.30
. fixed bug that kept payinvoice from working (needed urlencode)
. fixed bug that sent "rCredits 1" as the subject for invoices
. set "apple-mobile-web-app-capable" to no (for now) to prevent 404 errors
. rewrote Add Community form
. add 'Or tell your friends "To sign up for rCredits, go to rCredits.org and sign in with this invitation code: WHATEVER2ABC"' to the invitation page.
. delete all but digits in community EIN
. hide rTrader bit from cAdmin
. created community dropdown on Summary page for admin
. radically revised the way regions and communities are handled (see developer.txt) and changed data on server
. restricted Whois choices to same community
. new Send Message page for member-to-member communication
. implemented ajax confirmation and choices forms for Send Message page
. replace r_regions
. delete all region accounts in users except NEW: DELETE FROM users where uid<0 AND name<>'NEW.'
. create greenfield CGC, sevt, goshen, and a2 CGCs:
  - rCredits Goshen: 615 College Ave, Goshen, IN 46526  574-202-6977  475318822  ^46|^47 goshen@in.rcredits.org (goshen@rcredits.org)
  - Better Economics for Neighbors Everywhere: 16 N River Rd, Walpole NH 03608  6172330545  47-4965856 ^05(1|3) bene@vt.rcredits.org (vermont@)
  - Greenfield Area rCredits / Greenfield Massachusetts rCredits: c/o Common Good Finance, PO Box 21, Ashfield, MA 013300021 413-628-1723  ^013|^010 811209155 (westernmass@)
  - rCredits Washtenaw County: c/o A. Konner, 1005 Packard St., Ann Arbor, MI 48104  734-726-4264  465193894 ^492|^48 (later ^48(103|104|105|107|108|109|113|115|130|158|175|176|190|191|197|198) washtenaw@mi.rcredits.org (washtenaw@)
. change accounts: NEW community to greenfield, MIW to a2, INA to goshen, NEV to sevt, and all others to seedpack
  (in users, r_txs, and r_stats)
  $cttys = '-26742000000001,-25026000000001,-17238000000001,-26739000000001';
  $ctty0 = -26742000000001;
  $map = 'r_stats:ctty,users:community,r_txs:payer,r_txs :payee,r_txs  :payerAgent,r_txs   :payeeAgent,r_boxes:uid,r_log:myid,r_log :agent,r_notices:uid,r_request:ctty';
  foreach (ray($map) as $table=>$fld) {
    q("UPDATE $table SET $fld=IF($fld IN ($cttys), $fld-1, $ctty0) WHERE $fld<0");
  }
. see who is in the "wrong" community and fix them by hand:
  eachA(function($a) {
    $shouldbe = f('r.communityUid', $a->zip);
    if ($shouldbe == $a->community) return;
    if ($a->ok) {
      debug ("$a->fullName: ctty=$a->community should be $shouldbe (zip $a->zip)");
    } else $a->update('community', $shouldbe);
  });
  
2016-01-16
. add extra optional column to payroll upload: description (and use it if specified)
. rename field savings to savingsAdd
. split everyone's balance into primary and savings reserve, emailed warning message, set minimum to zero if their current balance became negative:
    eachA(function($a) {
      $topic = 'balance now split (important notice)';
      $a->update('savings', max($a->rewards, $a->savingsAdd)); $a->setBit(B_u8, FALSE);
      $args = f('r.noticeArgs', $a->id);
      $balMsg = f('u.tt', '<p>Your new balance is @balance.</p>', f('u.just', 'balance', $args));
      $msg = '';
      if ($a->minimum > 0 and $a->j_rewards > $a->j_r) {
        $msg = f('r.suggestMin', $a, $a->minimum, "new savings balance|$balMsg|minimum zeroed", TRUE);
        $a->update('minimum', 0);
      } elseif ($a->j_rewards > 0) $msg = "new savings balance|$balMsg";
/**/  if ($msg) debug("Sent " . (strpos($msg, 'zero') ? 'zeroed' : 'normal') . " msg to $a->fullName ($a->mainQid) : $balMsg");
      if ($msg) f('r.message', $a->id, $msg, [], $topic);
    });
. photo is oval and squeezed horizontally on the iPad (might have fixed this)
. don't count cron transactions as activity (don't update "access" field)
. added a timeout to croppic.js to handle attempts to upload a non-image file
. handle transactons summary when member changes savings amount: Add a line for Rewards and do it like the statements, but vertically.
. fixed rounding error on bank page.
. changed username and password field html to flout browser autofill.
. added file size check to croppic, to keep php from crashing on out-of-memory creating image
. fixed bug that kept company "ATM" bit from working
. cron now considers an automatic transfer for a joined account whether or not it has a low balance (no way to tell whether it's time with SQL alone)
. set B_JOINED on joining
. changes field is now encrypted if it contains any secure field (former) values (changed field type to longblob)
. fees are now included in calculation of r on ctty funds page
. updated the general help page
. added a don't list option for companies (CO_PRIVATE)
. added an anonymous export option for data analysis
. added total balance to balance line on Summary page
. centered messages, with "puff" transition

2015-12-11
. bug fix: sort field was causing crash on bad data in transaction history
. bug fix: opening company failed (form.inc updated on production site)
. instant submenus on hover
. give some businesses exemption from the cash-out restriction if they choose "reserved" and provide rCredits purchase service. (especially Upinngil and GFM and Foster's)
. delete reference to "red" in 1099B page and add column for 990s. Then make it a "Tax Info" page and separate out the 1099B details to a separate page.
. italicize phrase in agreement about until the community has sufficient revenue AND make "suffient revenue" a hyperlink
. fix balance/rewards reporting on notices (for savings reserve)
. BONA bit now gets set upon account activation
. fixed bug (finally!) that kept country and state from sticking on signup form error
. fixed checkbox problem on signup form
. "which" form gave errors on ambiguous reference
. eliminated required() from most radio groups, because it made ladda buttons stop spinning
. change bit 31 to 26: UPDATE users SET flags = (flags | (1<<26)) - (1<<31) WHERE (flags & (1<<31))
. fix payroll upload page formatting and accept vanilla CSV spreadsheet upload (just names and amounts), asking for dates separately, defaulting to next after previous upload
. clean up footer and misc.js and combine them in misc.js on every page (not called from showForm)
. set emailCode for every non-company account: eachA(function ($a) {if (!$a->co) $a->update('emailCode', f('r.cardCode', $a->mainQid));});

2015-11-30
. now using Bootstrap 3 more fully
. added breadcrumbs
. jQuery photo upload
. (no password quality metrics, so this is a stepping-stone unusable update)
. separated out theme file guts into rcredits folder, so they get tracked
. notices now report savings reserve properly
. fixed bug: invitation confirmation by doing first transaction with inviter now works
. changed default sharing percentage to 25%
. bootstrap modal "which" form
. delete second signup bonus for everyone and set BONA flag properly upon activation. Identified with this duplicates DUP-finder query: SELECT payee, fullName, COUNT(*) c, MAX(t.created) AS dt, MAX(xid) AS xid FROM r_txs t LEFT JOIN users u ON u.uid=t.payee WHERE type=1 GROUP BY payee HAVING c>1 (also type=4 for helper bonus)
. special admin function for printing invitation cards for old members

2015-11-09
. gave cAdmins access to secure messages from people in their area
. fixed bug: invoice payment was complaining of duplicate transaction
. fixed bug: uploading photo for companies gets error "tried to shrink company photo" and no check mark
. fix javascript on relations page, so clicking yes or no shows the other setting
. changed not-authorized patch in common.inc to redirect to signin if appropriate
. added code for invitation cards, including scrambling of code, printing cards, accepting invitation # as a getting started signin/signup identifier, and permitting use of invitation card as a temporary rCard.
. add federalId field to summary page for admin (entry only -- show "on file" if we have one)
. ignoring "the" and first initial at start of account name, when selecting from click on account photo
. elimination of submenus
. add inviteMask to .databases

2015-09-06
. changed invoices to go out immediately
. link for emailing invitations with later confirmation
. removed photo upload size restriction
. fixed invoice confirmation
. set B_CONFIRMED for all accounts except Caitlin: UPDATE users SET flags=(flags|2)
. "Click here to increase your minimum balance" needs base_url and should be different when not signed in (confirming invoice)

2015-08-28
. tweaks to make it easier to collaborate with another programmer

2015-08-17
. version 2.2 (new style)
. bug fix: "disputed" shown whenever a tx had been changed
. when we go to promo site from mem site, set a cookie to show "Members Site" instead of Sign In.
. don't show "processing..." when clicking photo (add "nospin" class)
. change second AND FINAL email to invitee to 8 days later
. let companies invite (but warn on page and in code about corporate personhood)
. give Fuzzy (and other ctty admins) inviter rewards
. removed u\tt from help at top of rweb-subs.inc (made reinstall fail)
. removed NULLs from rcredits-install.inc (made reinstall fail)
. remove Toolbar module
. REINSTALL
. UPDATE r_txs SET goods=IF(goods=2,0,goods+1)
. update theme, css, js, images, fonts
. copy vendors\ and composer.*
. disable secondary menu in rcredits theme
. change !NEW email to westernmass@rCredits.org
. a('miw.adg')->update('dob',strtotime('10-May-1982'));
. search for tx data starting with "s" and unserialize it (none)

2015-08-09
. when a second bank transfer request, fix the cached r
. when user chooses "don't connect yet", set minimum to zero (and tell them)
. alert inviter when invitee is 8 days slow accepting or progressing
. bug fix: invoice notices were missing the link
. add all known US regions to users table and use the region name on rcards
. make a way to export members for import into mailchimp (modified standard admin export)
. add message on Bank tab for admin: "(no limit for admin)"
. fixed bug: editing tx description changes the type to disputed (and corrected doubly-serialized tx data fields)
. alert staff if anyone ever chooses paper statements 
. admin signin now triggers update of unencrypted bankAccount (including in r_usd). This may eventually require an "encrypt" flag bit.
. don't require mediaconx unless OK
. add calling to summary page
. add photo to Summary, for cAdmin
. don't update access date for cAdmin access to the account
. add a "nonmembers" (where do i shop) button on Admin page
. don't calculate or show stats for inactive communities
. when complaining about cashing out, suggest choosing goods and services
. add nosearch field to options tab
. changed !NEW email to westernmass@rCredits.org
. fixed: reimbursement/loan/etc. was getting mis-recorded as for-USD
. channel is now recorded in r_usd, so we can tell which transfers are automatic
. change "exchange of US Dollars or other currency" to "exchange for US Dollars (or other currency)" without being too long on mobile (and fix tests)
. created r\regionField() to replace several constants
. forbid joining until both accounts are activated
. stop consolidating incoming transfer checks for completed transfers
. lack of photoID verification now just alerts admin (tx always goes through)
. tasks
	DROP TABLE r_regions and re-import
	f('a.setupBasicAccounts');
	test change password
	test photo upload and re-upload
	test (in WS) displaying foreign rCard (eg NY or VT)
	test (in WS) admin signin auto-encryption of bank accounts
. fixed: clicking on 1st or 4th graph gives warning: "Warning: hex2bin(): Hexadecimal input string must have an even length in CG\Util\deurlify() (line 354 of .../rcredits-util.inc)."  
. on promo site: signup include "organizer" bit: "I want to help bring rCredits to my community. I will tell some friends and local business people about it and will meet locally with other interested people to plan. (You will receive an email every time someone else in your 3-digit zipcode area checks this box &mdash; until your community has selected a contact person.)
. integrated boostrap theme from promo site

2015-04-21
. version 2.1
. made data, secure, and vsecure more efficient
. no usd in admin users list
. add taking to admin tx list
. don't show vsecure, askappdata, seeappdata for cAdmin
. move addr and postalAddr to secure
. encrypt phone (searchable)
. encrypt email in invites and email & phone in requests (then bin2hex)
. when showing old check images, use the original deposit date
. notices now say to contact us at community's email address (not necessarily new@rcredits.org)
. fixed: account dropdown in DEV fails (omits "devcore")
. upload new .databases
. disable pw2 check in formSignin_validate
. having generated a max 512-char u\randomString for pw2, a(1)->update('pw2', f('r.passHash', hex2bin('pw2'))); 
. reinstall
. ALTER TABLE `users` DROP `usdAccount` , DROP `offsite` , DROP `usd`;
. copy filter.module
. run Special to re-encrypt and move fields around
. ALTER TABLE `users` DROP `address` , DROP `postalAddr` , DROP `faxetc`;

2015-04-20
. added a Delete button for admin to remove photo
. fixed bug: empty new password crashes
. forgot to set deposit date once, so did UPDATE r_usd SET deposit=1427428800 WHERE txid BETWEEN 6124063 AND 6124086
. added list of people waiting for invites, to Invite page
. fixed bug: users were unable to edit company description
. combine any undeposited transfer requests into a single request with the current date and original txid
. if running f('cr.something') from PHP window, call just that one function, not all subsequent daily functions as well.
. refuse first tx if no photoid yet
. make a way for members to cancel a bank transfer request
. make account selection give first letters and submenus, for admin (as well as full qid and/or choose ctty first)
. add share pct to preference page
. explain tax options on 1099-B page
. change from ECB to CBC encryption mode
. double encrypt secure (two different methods)
. Use extra encryption for social security numbers, with the second key stored offsite and used only once a year for tax reporting. I don't know if anyone else does that, but it would make it pretty close to impossible to steal those numbers. Less easy than spinning a barn full of straw into gold overnight, for example. Only admin can see "very secure" fields, and signing in as admin requires a long second password, stored on a thumb drive. That password also serves as the key for encrypting the "very secure" fields.
. set init NULL, encrypt mail (searchable), encrypt photo.
. store encrypted bankAccount in r_usd (for a permanent record of checks actually used)
. ALTER TABLE `users` DROP `usdAccount` , DROP `offsite` , DROP `usd` ;
. a(1)->update('pw2', r\passHash('<pw2>'));

2015-03-11
. fix <small> sizes on notice footer
. handle company agent photoID in rsmart
. handle company agent photo properly in rsmart
. handle offline transactions with inadequate permissions by messaging everyone involved
. check rCard security code on rsmart charge requests
. warn user they have to open a personal account first
. make a way to ask the app to delete a record: !delete:txs,15
. deposit total fails if there are commas in any amounts

2015-02-23
. accept first-time customers offline only if the company accepts any risk of fraud (suggest they ask for ID)
. disabled no-connection alert in /misc/autocomplete.js
. secure message form on Help page, including attachments
. show expired invitations on invitation status page
. show admin each member's invitation status page (but not their invite page)
. fixed averageBalance bug (bad union query in function); effective APR was wrong in notices
. fixed bug in bank info form: opting for no connection nonetheless was setting hasBank=TRUE
. fixed bug in bank info form that kept radio buttons from working right if user toggled back and forth
. made link to invitation status more obvious
. did away with secret fields (use secure field instead)
. when no SSN data is available, just show it in the error message
. changed format of Micr font check info at bottom of checks to "C000{$txid}C A{$routing}A {$account}C"
. set helper field for companies
. moved oneTimePass to secure
. fixed bug in click to pay invoice: goods field was omitted
. added bank address to deposit slip for outgoing checks
. inflation adjustment ($0) and other incentives should not appear as a separate category in Statement summary (happens for joint accounts)
. list current businesses at the bottom of every notice digest and remind others to open a company account.
. *** add totals of all, labor, dividend, and other on 1099-B page.
. make invitee descriptions more explicit ("member", "accepted another invite", "has not yet responded", "account incomplete",...)
. provide a "Cancel/Reverse" button for the Bank tab, to reverse just the most recent request.
. alphabet index for members, for ctty admins
. don't say activate account when it's closed
. change extension of remaining .php include files to .inc
. remake menus
. change boot.php to boot.inc in settings.php

2015-01-11
. version 2.0
. make ss# a password-type field
. no cadmin email to NEW (since I get them anyway as admin)
. chose a more secure admin pw
. move fields around according to privacy/security policy
. put our security/privacy policies in a footer link ("privacy")
. remove the following fields from secure: usdType usdPhone usdEmail usdPass usdPin auth
. inflation only for master of joint account, based on sum
. make account field persist with last account number on Admin Panel
. fixed bug: leaving goods blank on pay or charge form crashed
. refactored handling of data/secure/secret fields
. in notices and Summary, report "credit line" not "floor"
. admin signin redirect to sadmin page
. upgraded to Drupal 7.34 (post Drupalgeddon)
. make sure pie chart doesn't try to show negatives
. bona rewards (including rewards to inviter) now happen in cron
. added B_COUNTED bit to mark employees as having triggered a reward to their company's manager's inviter

2014-12-09
. sometimes ssncheck returns an array of birthdates (see c line 237 in admin.inc -- try Maja H)
. make a way to easily uncomplete bounced checks: On History page created offsetting record with reversed amount, txid, and tid; same everything else
. removed payee field from r_usd
. removed photo icon in upper right (temporarily?)
. delete garbage from r_do daily
. let anyone exchange unlimited cash with any other member. Just don't allow cashing out rewards via bank transfer. 
. on Deposits page: no checks link for today unless they have been printed
. joint accounts: implemented as a higher-level view of two personal accounts (larger groups need their own EIN)
. default flags period to 7 days
. made it easier to choose proxies
. we now handle photo id numbers (id proof) from smartphone on first transaction
. rsmart getTime() function now returns '!update' rather than a message, when appropriate
. fixed bug: payment to region says region doesn't have permission to make sales
. consolidated confirm and report messages
. DELETE FROM r_do WHERE completed IS NULL OR completed<0
. UPDATE r_txs SET goods=2 WHERE goods=1
. UPDATE r_invoices SET goods=2 WHERE goods=1
. fixed bug whereby app reversing a transaction with insufficient funds would retry over and over
. on Pay tab and Charge tab, if cash/loan/etc is selected, ask if it is for USD (at Adam's urging)

2014-11-14
. UPDATE r_usd SET completed=1414728000 WHERE completed=2014 (10/31/2014, fixing the oops of 11/01)
. banks: UPDATE r_banks SET name=REPLACE(name,'Fcu','FCU'), address=REPLACE(REPLACE(REPLACE(REPLACE(address,'Bx','Box'),'bx','Box'),'P.O.Box','PO Box'),'P O Box','PO Box');
  UPDATE r_banks SET address=REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(address,'Box1','Box 1'),'Box2','Box 2'),'Box3','Box 3'),'Box4','Box 4'),'Box5','Box 5'),'Box6','Box 6'),'Box7','Box 7'),'Box8','Box 8'),'Box9','Box 9');
. omit lastTx from changes
. UPDATE users set changes=NULL where changes like '%lastTx%'
. put bullets back in notices when there are no dates (everyday notices)
. statements don't work (spurious output in addition to PDF)
. in user stats field, round amounts to cents
. created test function stubs for non-testing environment
. in statements categorization, separate other (goods & services) from other (cash/loan/etc.)
. in statements, add "..." to abbreviated categories
. print escrow deposit slip automatically, with list of checks, count, and total
. admin deposit page for printing checks in and out, with summary and detail of past deposits/checks
. generalized check.class as pdf.class
. did away with T_REFUND (and the Dwolla fees they refunded)
. UPDATE users SET activated=0;
  UPDATE users u LEFT JOIN (SELECT payer, MIN(created) AS dt1 FROM r_usd WHERE payee=0 GROUP BY payer) t ON t.payer=u.uid SET activated=dt1 WHERE dt1>0;
  UPDATE users u LEFT JOIN (SELECT payer AS id, MIN(created) AS dt1 FROM r_txs GROUP BY payer) t ON t.id=u.uid SET activated=dt1 WHERE dt1>0 AND (activated=0 OR activated>dt1);
  UPDATE users u LEFT JOIN (SELECT payee AS id, MIN(created) AS dt1 FROM r_txs GROUP BY payee) t ON t.id=u.uid SET activated=dt1 WHERE dt1>0 AND (activated=0 OR activated>dt1);
  UPDATE users SET activated=signed WHERE activated=0 AND (flags&(1<<2)) AND signed>0;
. DELETE FROM r_txs WHERE type=-3;
  DELETE FROM r_usd WHERE payee=-1;
  UPDATE r_usd SET deposit=1 WHERE payee=0 AND deposit<1 AND txid <=6117399;
  UPDATE r_banks SET name=REPLACE(name, 'Rbs Citizens', 'RBS Citizens');
. bank info for admin on Summary page
. base member counts on activated date and redo stats
. in stats, calculate usd right for each community and track payments out (to another community) and payments in. Redo 
. inflation did not seem to appear on statements summary. clarified.
. DELETE FROM `r_usd` WHERE payee<>0
. found out why Artisan gift failed (somehow it was OK but not MEMBER)
. balance was getting adjusted every day! (fix and delete most such notices)
. reflect rCredits escrow amount due each community on graphs (requires fixing data)
. in stats, company count was off
. fix formatting of dates in notices table for weekly/monthly
. an extra community button that lists communitys and amounts: r TOTAL,usd,trade,signup,etc. (including trade balance right after usd)
. pay attention to the number-of-days selector on flags page (show only that many days)
. flags shown are for the current community unless admin or not signed in
. always show all red flags
. describe selected flag at top of Flags help page
. on Flags page, change labor... to labor, and automatic transfer... to automatic transfer else suppress non-rcard
. made a() and r\acct() work with community quids (!NEW, !NEW.AAB, etc)
. add proxies, invited by, invited, and trust score to summary
. update users set minimum = 0 WHERE minimum IS NOT NULL AND name NOT IN ('carolgletson', 'marilynandrews')

2014-11-01
. SMS text messaging is discontinued
. continued eliminating hooks for Dwolla
. no longer trying to shrink company photos
. tests are now independent of rcredits (but not Drupal)
. set flag bits if contribution to score is 1/20 or more (make it a defined constant)
. show Go button on memberInfo form
. after saving summary, if any risk bits changed, rerun the risk calculation for that account
. added a permissions bit for regulators (and bank partners) that is read-only
. people still think they're done after the 0th step. Made it more obvious ("WAIT!" big)
. changed TX_SMART to TX_APP (we expect to have another app or a more general app, that lets the payer initiate)
. changed "I don't have a bank" to "no bank" on paper signup
. show quarterly/monthly etc. for gift on summary!
. zapped r_ach table. (replacement is being created by transforming r_usd)
. added share % to summary even when not activating
. added "no connected bank account for now" to Bank Info page
. now shows a picture of where to find routing and acct numbers. Sort of like http://www.nationwide.com/routing-and-account-numbers.jsp does. Or draw a mockup of a check and put those two fields in the right places.
. hide advanced features on Transactions page (show either advanced or simple period selector, but not both)
. duplicate phones no longer forbidden
. bank account removal
. user can see notices online
. Summary show helper name.
. assume any "share" less than 1% is already hundredths
. individual notice page should be under history (history/notice)
. not-yet-member companies should not appear on Find Co list
. when a member draws from another for part of a purchase, leave a zero balance, if not debt okay
. on flags page do not give links (just titles) for unprivileged users
. allow user to select time range for Flags
. add minimum and other settings to Summary screen (for admin)
. When a member is short, include in the message some mention of debtok and floor, if not debtok.
. wrote plusMonths to handle month arithmetic (strtotime does it weird)
. on history, show bank tid as txid, not b-something
. first admin test (for printing checks)
. tell member the txid when banking (say or notice)
. after creating company, sign user back in with company account selected and status page displayed
. fixed bug: creating company account fails (creates acct but goes to sign in with no message and fails to create relation)
. add a users changes field and TEST
. give message to app on "time" request, when an update is needed: "You need to download the latest version of this app from the Play Store.
. on NSF for cash/loan/etc., explain that rewards cannot be cashed out
. in cron, set completed date for outstanding bank transfers deposited 2 business days ago. And write tests.
. expired invites no longer count as dups
. limit Fibonacci to 8 (just keep repeating every 8 days thereafter)
. data tasks:
	0. Backup NEW db and copy it to WS
	1. Do all of the below on WS
	. DROP TABLE r_banks
	. upload r_banks and r_transit
	. upload software
	. reinstall: /devel/reinstall?destination=sadmin/handy
	. ALTER TABLE users DROP column question, DROP column maximum;
	  ALTER TABLE r_txs DROP column usdXid, DROP column r, DROP column completed;
	  DROP TABLE r_ach;
	  UPDATE users SET share=50 WHERE share>50;
	. copy new fonts to TCPDF folder
	. include_once __DIR__ . '/../rcredits/admin/admin.inc';
	  f('a.eachAcct', function($a) {$a->setRisk('hasBank', (bool) $a->bankAccount); $a->setBit(1, FALSE); $a->setBit(4, FALSE); $a->setBit(8, FALSE);});
	  a(-26742000000001)->setBit(1, FALSE);
	  a(-25026000000001)->setBit(1, FALSE);
	. make sure Dan's account can request a bank transfer
	. make sure Admin users list shows no unused bits 
	. make note of who has how much USD (11 rows):
	  Sheila 20, scottR 40z, matthewG 10 (write this one off), CGF 8.52z, GFM 7.91z, heatherG 10z, leighR 60z, snows 6.75z, pint 6.40z, upinngil 9.85z, rWM 40,894.78
	. make note of who has pending bank transfers, for how much (and keep track of them as they come in over the next few days) (11 rows): betsy 70xz, fred 120xz, jeffC 30xz / nancyHaz 40xz, tamaraMcK 10xz, ellenK 70xz, andyG 50xz, johnWaite 100xz / peter 190xz, mona 110xz, realpick 601.12xz
	. a('abr')->update('bankAccount', ''); a('abr')->setRisk('hasBank', FALSE); // zap Stephen Cobb's locked account
	. UPDATE users SET r=r+usd WHERE usd IS NOT NULL (11 rows)
	. DELETE FROM r_usd WHERE amount<0 and NOT completed AND txid<6030837 (5 rows)
	. UPDATE r_usd SET completed=NOW() WHERE amount<0 AND payee=0 AND completed=0 (11 rows)(oops NOW() becomes 2014)
	. UPDATE r_usd SET deposit=1 WHERE amount<0 AND payee=0 AND completed>0 (686 rows)
	2. Backup NEW rcredits module (in case we need to undo the update)
	3. connect CGF's rCredits escrow account (in Dwolla)
	4. Do #1 on NEW (except Dwolla stuff)
		a. alert people who need to reconnect their bank account
		b. alert people who were unable to have a connected bank account that they can now, if they want: Emi, Helen, Carol Letson, Marilyn Andrews, Ed Smith
		c. alert people who are OK and hasBank but not old bank bit(not verified) that funds can be transferred to and from their account (and will be if they are below their minimum): Keegan Rodgers, Just Abundance, Inc., Delta Carney, Preston M. Browning, Jr., Kristie Faufaw, Christopher B Rawlings, Amylia Jackson, Henrietta M. Startup, Peter Garbus, Jennifer Ladd, Will Savitri, Just Soap, Richard G. Kelly, Daphne Bye, Clare Higgins, Artisan Beverage Cooperative
		d. on WS:  include_once __DIR__ . '/../rcredits/admin/admin.inc'; f('a.makeTestCards');
	
2014-10-21 (rWeb tests do not pass -- not usable yet)
. hidable advanced settings for Txs
. cron now calculates the right values for trust (was giving some negative values).
. when making a new rcard in admin, rename photo with new cardCode
. created new r_transit table from Wikipedia's transit code page
. UPDATE r_transit t INNER JOIN  `r_states` s ON t.location = s.name SET t.location = s.abbreviation
. UPDATE r_banks SET name=REPLACE(REPLACE(REPLACE(name,'N.a','N.A'),'Td Bank Na','TD Bank NA'),'U.s','U.S'), address=REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(address,'P.o','P.O'),'Po B','PO B'),'U.s','U.S'),'N.e','N.E'),'N.w','N.W'),'S.e','S.E'),'S.w','S.W')
. UPDATE r_banks SET name=REPLACE(CONCAT(name,'|'), ' Na|',' NA') WHERE RIGHT(name,3)=' Na'
. notices are now available online
. notices are in table format instead of <ul>
. changed bank info form to use RCC or ACH (independent of Dwolla)
. make users type their account number backwards too ($35 value)
. *** add a "changes" field to users (use only after rTrader bit is set, ignore date and cache fields, ignore floor when set automatically, ignore password/risk/risks/trust/, handle data&secure only as individual virtual fields)
. complete usd transfers (set completed field) automatically: immediately for members with enough credit (floor), 2 days after deposit for others.
. cron send a message at about 8am if it has not completed successfully for a day or more

2014-10-04
. fixed bug in deleteUid that might have deleted some things that shouldn't be
. calculation and display of ach risks
. display of single transaction details
. added risk-related fields to admin's Summary form
. added seeData to Admin panel
. refactored transactions as new x class
. handle failed transaction save (txSave return FALSE)
. share percentage limited to 50%
. improved account not opened yet message
. DELETE photos/small directory
. REINSTALL
. f('a.eachAcct',function($a) {$a->update('tenure', 12);});
. fixed bugs in recording helper
. on flags page: say what the transaction volumes are (for bigyear, etc) in description.
. on company page, ask for annual gross and number of employees (both required)
. risks: different BIG thresholds for companies, based on number of employees
. set moreIn and moreOut in cron txRisk1 (flag unusually large receipts or expenses of an account)
. on flags page: key to what the weights are and how each risk is calculated (linked to by risk name) And point out that green is a "good" risk.
. removed u10, u15, and u19 on production server

2014-09-13
. fixed bug: admin Summary form was trying to shrink photo always
. fixed bug: helper was trying to be recorded as qid rather than uid
. bug fix to adapt to accidental API change by Dwolla: added "/" to end of fundingsources URL in dwolla.php
. refactored integer bit array bit-setting/getting code
. added (rough) calculation and display of account, transaction, and (not yet) ach risks (following revisions to Policy to Prevent Fraud, Money-Laundering, and Financial Crime)

2014-08-26
. in invite email, warn the potential member about the required donation "of any size -- a penny or more" and "you supply the same info as for opening a bank account"
. relabel member and rTrader bits for ctty on Summary page
. fixed bug: setting member bit on community gets message ~ "you must specify helper"
. small photo is now saved in users table (account record), to accommodate replication
. revised relations table (and related code), to eliminate reverse record (and employeeOk and amount fields)
. moved helper field out of users:data f('a.moveFieldFrom', 'helper', 'data');
. moved question field into users:secure f('a.moveFieldTo', 'question', 'secure');
. queries:
  ALTER TABLE r_relations CHANGE reid reid BIGINT(20) AUTO_INCREMENT;
  ALTER TABLE r_relations CHANGE employerOk employee TINYINT(4);
  ALTER TABLE r_relations DROP employeeOk;
  ALTER TABLE r_relations DROP amount;
  ALTER TABLE users DROP maximum;
  f('a.fixRelations'); // to relocate relations record IDs to the appropriate number space for their region
. RENAME photos/small directory (then DELETE)
. ALTER TABLE users DROP question;

2014-08-07 (corresponds to Android App v202)
. support for exchange transaction fees (3% for credit card, $3 for a check)
. monthly statements now include a summary by description category (most punctuation separates category from detail)
. bug fix: transaction edits are handled properly (finally)
. History now shows USD in as being from the company to the customer (instead of vice versa and negative)
. creditInfo likewise reports USD in as debits to the company, credits to the customer
. added a suggestion to customer to not be secretive, when s/he tries to overspend

2014-08-04
. fixed bug: homogenize crashes on "null dw number" trying to tradeR to/from 26742000000080. Require B_BANK, not just B_DW.
. community admin can now skip the agreement step when inputting a paper signup
. modified and added code to handle offline rPOS transactions
. fixed bug that recorded signup helper's account rather than their qid
. changed automatic nighttime draws to be always allowed, regardless of rewards level
. fixed bug: don't allow pw reset for companies
. fixed bug that allowed admin to set "ok" bit without "member" bit
. fixed bug that ignored null state on signup
. added email address to summary page
. alert staff on insufficient funds and other tx failures
. created smaller picture (in photos/small) for passing to POS: 50% (300x400 -- about 12k) ideally at 35%
. fixed bug: "reverses #" was giving wrong tid for cust/co 
. fixed bug: rcron now handles negative balances right, when bringing accounts up to minimum.
. make note of all company bits and restore them after the update
. create small pictures in photos/small ( use f('a.eachAcct', 'photoFromFile'); )
. set helper for each ok account (use   f('a.eachAcct'); )

2014-06-25
. fixed bug: u\monthDay1 failed for other years
. moved Txs utility functions to their own namespace (Txs aka x)
. created a pdf class extending TCPDF
. created function to show (calendar) monthly account statements
. fixed bug in edit transaction description (was changing the wrong purpose field)
. we now allow rewards and donations in not-yet-active communities
. users are now given a revised credit line (floor) every month after their first payment transaction
. changed TCPDF cache permissions to 777 (required for monthly statements)
. added a "New Account" tab to admin section
. gave region an email address (new@rCredits.org) and shortened its postal address to fit on the monthly statements

2014-06-11
. added member list export option for cAdmin2
. cAdmin2 people now have an Admin section with just memberlist and export
. added lists of Invoices TO You and Invoices FROM You
. email links to pay/deny invoice
. no-sign-in form is now standard rather than template-based (to allow multi-step processing)
. moved photos to /photos and changed naming convention from uid-created to uid-cardCode.jpg
. MDIR /photos
. moved proofs to /
. added helper reward (TX_HELPER) to stats and charts
. user stats are now rounded to the cent
. combined MemberInfo form into Summary form
. fixed bugs in rdo() that kept change-minimum links from working
. gave admin its own namespace, abbreviated "a"
. we now use an auxiliary file for testing link results (dosay-status.txt)
. implemented NACHA format ACH origination file creation

2014-05-15
. UPDATE r_invites SET invitee=0 WHERE invitee IS NULL
. fixed bug: summary balance omitted usd
. revamped "we send email" tests
. comprehensive tests for signin and password reset
. eliminated Contact step by including it in initial signup form, using Google's zipcode lookup api
. anyone with refund permission now gets a "request card" link on Relations page
. we now explain the 5% APR inflation adjustment as what were using until we have a realistic number.
. we now figure savings as total of 30 day minimum balance
. stats are now calculated in such a way that we can redo them all retroactively, using admin fixStats()
. stats for all communities
. improved help for charts
. UPDATE users set r=0 WHERE uid<1
. re-install
. UPDATE r_txs t LEFT JOIN users u ON u.uid=t.payee
  SET t.payer=u.community 
  WHERE t.payer<0 AND t.payer<>u.community
. include __DIR__ . '/../rcredits/admin/admin.inc';
  CG\fixStats();
  CG\fixStats(809); // where the previous run ran out of time
. fixed bug: stepDone(dw) was looping
  
2014-05-02
. asks for full name first, then legal name (if different), to discourage people from giving a nickname
. fixed EditTx test so it handles variable link ("?")
. added cron tickler for invitations
. if state lookup fails in signup, state defaults to MA
. when signed out, footer links now include community, agreement (no boxes) and help (for signing in or up)
. don't update the access field in the users table when admin or cadmin or cadmin2 accesses the account (similar for login)
. we now let user choose minimum size for automatic bank/draw transfers -- stored in "data" in the users table.
. fixed signup page to clarify that full name and legal name are for the business (when they are)
. stopped making user type one-time passwords (we now use a clickable link instead)
. created a way to sign in from rCredits.org: formSignin
. we now ask for PIN on signup form
. password reset form is now separate from login form, but sends user on to summary page with no signin required
. implemented effective minimum for unbanked accounts that can draw on one or more others
. update user.module and user.js

2014-04-17
. added charts to help pages
. created a page to edit transactions (lets seller adjust amount down and buyer adjust the amount up.)
. added a tickler cron function which give people nudges for taking next steps
. modified rCredits Agreement by adding these two clauses:
  - Once my geographic area becomes a Common Good Community, in the event of a cash crunch I will back rCredits up to my average balance over the past six months.
  - that I can spend but cannot cash out.
. created B_REFUND permission
. changed permission=5 to 6: UPDATE r_relations SET permission=6 WHERE permission=5
. changed the way undo is handled (now creates a negative charge instead of an offsetting payment)

2014-04-04
. added date/initial stamp to notes on Summary page and Member Info page
. revised changeUid function to accommodate account deletion
. fixed bug: member bit not getting set in r\Acct::stepDone()
. don't alert staff when admin invites someone
. community admin gets an email when community's new members achieve milestones in their account opening
. fixed $/acct for p2p on Community page
. separated invoices from r_txs (somewhat major change)
. changed Community page to charts
. made Community page public (show all cttys if signed out)
. added a payroll upload page
. drop table r_invoices
. duplicate r_stats for ctty=0, then:
  UPDATE `r_stats` SET id=id-600 WHERE id >999 AND id<10000;
  UPDATE `r_stats` SET id=id-9600 WHERE id >9999;
. added newb field to stats
. ran fixStats to update and correct r, usd, and newb data in stats
. added relevant dates to MemberList form
  
2014-03-13
. hide federalId and dob in $_POST in log
. membership status page now shows Verify bank account as a not-yet-done step.
. added tellStaff to remaining signup steps.
. created new system for no-signin links, including one-time links, addresses, and invoices
. removed B_PERSON bit
. added stepsDone assoc in users table data field, to track account-opening step completion
. removed Connect to Bank step for companies
. moved tellStaff to stepDone function
. changed "Owner" to "Owns 10%+" on Relations page
. now links to memberlist on admin page
. added notes to CGF member list
. now allows cadmins to shut down system just for their community: made the START/STOP button work for Community Admin (for that community/region), so members there can open account, move money to and from bank, but not transact until community is activated (and Community Admin can shut it down in an emergency). It tells members to contact the ctty admin (give telephone # and email)
. stopped showing "processing" when user clicks on a help link
. lets cadmin invite list of emails
. fixed bug in Dwolla registration that neglected to record the Dwolla account number. Called usd::me() for each account, to catch up on any missing account numbers.
. moved all admin stuff to a separate folder
. introduced cAdmin2 (community sub admin) permission, to allow assistant to see member list and modify account notes
. changed "recurs Monthly" to "4th monthly" etc.
. db changes:
	new.rcredits.org/devel/menu/reset
	ctty('aaa')->setBit(B_MEMBER);
	ctty('aaa')->setBit(B_OK);
	ctty('miw.aaa')->setBit(B_OK);

2014-02-25
. eliminated preemptive "dupOk" field in signup.
. removed verifyBy from Contact page
. changed automatic state in postal address to abbreviation
. allowed entry of bank account info before there is a Dwolla account
. added Admin tool to send bank account info to Dwolla
. staff is no longer notified when admin sends an invitation
. fixed account approval message (was sending welcome email)
. created Invitee List link on Invite page
. changed "From Bank" to "From Bank to Here" and "To Bank" to "From Here to Bank"
. in notice digests, finishes with current balance, incentive rewards to date, effective return on your rCredits balance APR (averaged over the past month)
. created admin tool to make a new region or community
. limited community admin choices and results on Admin page
. created new region: ^48(103|104|105|107|108|109|113|115|130|158|175|176|190|191|197|198) rCredits Washtenaw County, MI (MIW) on production server
. fixed bug that kept Grants page from working
. fixed bug that made community's summary page crash
. added "recurs" note to recurring transactions
. fixed bug: dollar sign in input caused problems on Bank page
. now logs just i/o, not db ops
. when administering region, Txs page no longer shows bank transfers nor everyone's transactions, distinguishing it from call on community page.
. brought half the SMS tests up to date
. changed region and community numbering to mirror account numbering (region is just -XXX.AAA; each community is within its region: -XXX.AAB, etc.)
. bug fixed that created a relations record with NULL other upon signup
. allow cadmin to print-id
. cadmin should not have access to SeeSecure (or print-id) for out-of-region accounts
. tells cgf how often a donation happens
. invite email message defaults to last used (store in data)
. changed community field in users table to BIGINT
. queries:
  UPDATE users set postalAddr=REPLACE(postalAddr, ', Massachusetts', ', MA');
  UPDATE users set postalAddr=REPLACE(postalAddr, ', Ma.', ', MA') WHERE name LIKE 'gop%';
  UPDATE users set postalAddr=REPLACE(postalAddr, ', Michigan', ', MI');
  UPDATE users set postalAddr=REPLACE(postalAddr, ', New Hampshire', ', NH');
  UPDATE users set postalAddr=REPLACE(postalAddr, ', Vermont', ', VT');
  DELETE FROM r_relations WHERE other IS NULL;
. code:
  CG\changeUid(-8915, -26742000000001, FALSE);
  CG\changeUid(-8321, -25026000000001, FALSE);
  for ($i = 1; $i <= 10; $i++) CG\changeUid(24960000000000 + $i, 25026000000000 + $i, FALSE);
  \setV('r_totals', []);

2014-02-12
. fix data (already done on production server):
	DELETE FROM r_txs WHERE xid IN (76,77,78);
	
	UPDATE r_txs t0 LEFT JOIN r_txs t1 ON t1.xid=t0.serial
	  SET t0.payerTid=t1.payerTid, t0.type=1, t0.serial=t0.xid,
	  t0.payerFor='payment exchange rebate', t0.payeeFor='payment exchange rebate'
	  WHERE t0.type=-1 AND t1.payerFor='payment exchange' AND t1.amount=0;
	  
	UPDATE r_txs t0 LEFT JOIN r_txs t1 ON t1.xid=t0.serial
	  SET t0.payeeTid=t1.payeeTid, t0.type=1, t0.serial=t0.xid,
	  t0.payerFor='payment exchange bonus', t0.payeeFor='payment exchange bonus' 
	  WHERE t0.type=-2 AND t1.payeeFor='payment exchange' AND t1.amount=0;
	  
    DELETE FROM r_txs WHERE amount=0
. fixed bug in cacheTotals that did not recognize when an account was BONA
. fixed new bug in transaction logic that treated unconfirmed web/SMS transactions as confirmed (resulting in a duplicate transaction)
. made adjustments in formMembership (see $dw0) to work around Dwolla's broken Reg API
. fixed bug in 1099 reporting that deleted a couple characters in each person's name, when reporting to the IRS
. adjusted 1099 reports to omit non-positive transactions, as required by the IRS
. added "this is a donation, not a deposit" to Donation page.
. changed default phone format separator to spaces not periods
. fixed bug in cron notices that gave the same date for every item

2014-02-04
. clarified that when user opens another account, they will manage it (with no separate login)
. when someone is denied for NSF, sends a notice to them suggesting a higher minimum
. requires agent's LEGAL name, signing agreement
. when creating postal addr, use state abbrev (only for MA so far)
. invites people to email their photo instead of uploading it
. non-daily digests include date of notice

2014-01-31
. made invite a primary link
. made sign out a primary link
. shortened transfer time from bank: when there are insuffient funds, now updates cached usd amount and retries.
 fixed bug: "I didnt give a security answer, but it says on file"
. we now check hourly for deposits into the Dwolla/%PROJECT Account
. member is now alerted immediately when funds arrive in their account for the first time (bona)
. created 1099B reports for members and for electronic filing with IRS and state

2014-01-27
. fixed bugs in usd::rollback, injected during separation of USD transactions from r_txs
. fixed many cosmetic problems and minor bugs discovered by Mike
. fixed state not updating problem on Contact page
. fixed verifyBy=SMS default not showing on Contact page
. refactored data field to include company fields and act (virtually) like any user table field
. added legalName field
. accepts "none" or "n/a" in lieu of blank, for some fields (eg company and companyPhon)
. fixed bug: now ignores spaces in bank account number and routing number
. data changes:
  - move companies data to data field in users table
  - move signupCo fields (company companyPhone isOwner contractor EmployeeOk) to signupCo in data field in users table
  - move these data fields to data['stats']: giftsEver, giftsPastMo, beneEver, benePastMo, extraEver, extraPastMo, bankedEver, bankedPastMo, avgBalPastMo, avgBalEver 
  - set legalName equal to fullName in each account
. delete r_companies
. improved password strength descriptions

2014-01-23
. exchanges of r for usd are no longer in r_txs -- they are in r_usd only. All transactions between members are rCredits only. This made the "r" and usdXid fields in r_txs moot so they are gone. (Can't put this on server until data changes are ready)
. fixed bug that kept set-password from working for admin (patched)
. fixed bug in formGet (Bank tab) that got USD for the community instead of the member (made new test for it)
. fixed bug in cron that reversed sign of transfers to bank
. fixed bug in creditInfo that bumped in and out by rIn and rOut, respectively
. fixed bug: verify bank deposits was mishandling ".01"
. members can now open an account without a dwolla connection, if they have only one phone or if approved by admin (when Dwolla refuses to open an account for them)
. mark transfers to bank complete immediately (as Dwolla does)
. cache is now updated properly upon completion of transfers into the %PROJECT Account
. account is suspended if cron discovers any cache error
. cache is checked before manual transfers to bank
. data changes on production server:
  - UPDATE r_txs SET amount=r WHERE `payerFor` LIKE  '%fee%' AND amount=0 AND r=0.25;
  - DELETE FROM r_txs WHERE amount=0 AND data = 'a:0:{}' AND usdXid IS NOT NULL;
  - UPDATE r_txs SET type=-3 WHERE type=2;
  - UPDATE r_usd SET tid = NULL;
  - UPDATE  `r_usd` SET  `completed` =  '1389923856' WHERE  `r_usd`.`txid` =  '4418303';
  - UPDATE  `users` SET  `usd` =  '50.00' WHERE  `users`.`uid` =26742000000040;
  - remove r and usdXid fields from r_txs
  - eachr\acct(); : renumbered bank transfers (tid field)
  - eachr\acct() : $a->setBit(B_DW);
. added visible URL to invite email, so text-only recipients can see it.
. we can now give invitees simple verbal instructions to accept their invite without a link.
. changed invite time to 30 days
. removed "print sign-in card" from Relations page
. added "processing" spinner
. added "go back" button to help text for signup and community pages
. added r_invoices table

2014-01-08
. devices are now handled consistently and elegantly on Devices page
. firstUnusedId is used only for new users and works in all cases (r\Acct::nextId() works fine)
. removed the "Create Agent Account" feature. 
. released held emails 
. invites are now allowed
. disabled Charge tab (until invoices are implemented properly)
. added serial id field to r_invites
. cleaned up r_boxes (added new int fields boxnum and channel before trying to reinstall)
. deleted all cashier accounts and fixed transactions that had those agents
. worked around Google Chrome bug that populates Company Phone field with user's phone, on signup
. invites now always come from agent
. multiple invite feature for admin only (uses William's info)
. fixed bug that showed negative returns on Summary page when average balance was negative (now shows infinite APR)
. admin and CGF company agents can see who is a member by clicking on a link on the Community page
. committed amount will never be displayed negative on Summary page
. temporarily disabled "charge" on SMS
. fixed bug in averageBalance function -- it was failing to include deposits/withdrawals (patched)

2013-12-31
. rPOS now handles default cashier (defaults to the company pro se)
. company permission to share rPOS with other companies is now implicit in CO_REQUIRE_CASHIER
. revamped gap finder as firstUnusedId function, but it has problems still (need tests)

2013-12-24
. new non-member cashiers got uid ZZZ.AAA etc (should be NEW.whatever). fixed.
. usd total is now cached for communities and regions (fixes a bug in pool in rcron)
. fixed two homogenize bugs (it was transferring USD to the least needy first, then continuing until exhausted and beyond)
. provided a link on relations page for member companies to print their own rPOS sign-in cards (no photo)
. fixed relations page formatting
. can now open another %PROJECT Account before confirming bank deposits
. for admin, we no longer try to register an account with Dwolla when visiting the summary page (you must go to the status page instead)
. now we are notified by email whenever there are deposits or withdrawals
. new payment notices now show both physical and postalAddr and sometimes phone number, so member can ship or thank.
. administrator can now sign agreement for people and companies
. made averageBalance() more efficient and accurate by looping after a single query
. selecting "none of the above" on Open Another Account form now gives error message.
. fixed bug that kept setBank() from working
. fixed bug that allowed member "ready" status with no photo
. now accepts photos in several formats (PNG etc)
. verifyBy no longer defaults and is required
. fixed bug: PIN "0000" didn't work
. began changing rPOS interface to handle default cashiers

2013-12-05
. moved dwolla.php to rcredits folder
. changed how accounts form works so changing account and logging out always work right
. Membership tests now mostly work!
. fixed bug that kept dobs from getting recorded right
. change personal account opening process so last step is not required before person is a member
. began rsmart Exchange feature tests
. tweaked cron's homogenize1() so it trades USD for r only when inappropriate
. changed card code len to 14 (to avoid occasional complex QRs)
. fixed bug whereby Community page mistakenly showed rCredits as issued, that the community exchanged for USD
. non-code changes:
	- fixed dobs if not numeric (run eachAcct)
	- fixed data[verifyBy] to be if ('') SMS or (if 1 or not set) Voice (run eachAcct)
	- changed all @rcredits-org.com email addresses to @rc4.me (see util in admin.inc)
	- changed William's cardCode2 and printed him a new Company Agent card

2013-11-25
. restored addPhone(), accidentally deleted during separation of rweb-subs.inc from rweb.inc
. moved several functions back to rweb.inc from rweb-subs.inc that are called directly from URL
. implemented businessStructure parameter in Dwolla registration of companies
. eliminated "personal & commercial" account type (initial account is always personal)
. reworked homogenizing and pooling

2013-11-22
. all relevant tests pass
. added a notice that reward-sharing has been initiated (to precede the notice about it going through)
. got cron tests to pass again (given that nearly all transactions are in rCredits
. simplified formI and ScanCard tests to just go to rcredits.org or member page (for company cards)
. made the company cards say "Company Agent"
. non-code changes:
  - rename structure field "coFlags" in r_companies
  - create table r_boxes like r_boxnames; insert r_boxes select * from r_boxnames;
  - (no need to change fieldnames)
  - reinstall
  - delete r_smarts, r_boxnames after reinstall
  - add r_sms records to r_boxes (query?)
  - change all rebate pcts to 10
  - update dwolla.php

2013-11-19
. added Spendable: to the customer balance for rSmart
. expanded selling field to multiple lines
. expanded structure field to include miscellaneous company flags (renamed it coFlags)
. wrote all automated tests for rSmart (for the new rPOS) and they all pass!
. rWeb and rCron tests probably no longer work (address that next)

2013-10-28
. updated rsmart module to feed new POS app
. miscellaneous refactoring

2013-10-11
. created an admin tool and retrofited old accounts on prod server, recording dwollapin, dwollaphone, etc.
. changed r\quid to accept negative uids (quid is a single call to u\n2a() -- no dot)
. doubleclick (instead of single) on messages to make them vanish
. removed amount field from relations page
. admin can remove last manager from a company account or add one to a company with none
. clicking on photo no longer signs you out (patched on prod server)
. catch "you changed your password" and "you changed your email" emails from Dwolla (and disable the rC account with a misbehavior note in the data field)
. do transactions entirely in rCredits (even if the r balance goes negative). Distribute the USD evenly throughout the system (but with half in ctty account), for multiple cash-outs in one day.
. separated database function into rcredits-db.inc, namespace CG\DB (db)
. separated web subs into rweb-subs.inc
. added personal statistics to Summary page
. disabled soldOut function in cron (patched on production server)

2013-10-01
. don't list self as possible proxy
. tests expect tx rewards on entire amount, not just on the rCredits amount (r)
. no r% column
. no r/USD columns in download
. hover help on statistics page
. changed Bank setting to Bank Info
. added "skip" and "resume" to Gherkin
. added accountInfo step to dwolla and usd classes
. badDate function
. homogenize and pool functions in cron
. amount to withdraw in one day is limited to $10 from each other member
. gave bank transactions a tid (b#)
. transactions are now sorted (descending) by date, by tid before displaying

2013-09-22
. initialized stats on server: for ($dt = strtotime('5/23/2013'); $dt < time(); $dt += DAY_SECS) CG\getStats(-8915, $dt);
. made tests check for presence of labels on weShow, with, and without.
. allowed vertical arrays in tests
. disabled payment exchanges (virtual payments) in cron
. hid r% column and option to show/hide exchanges on Transactions page
. changed usd::source() to handle Dwolla's new practice of returning Dwolla balance as a source

2013-09-05
. changed physical field to postalAddr (and fixed data on production server)
. completed automation of dwolla account setup for companies
. fixed problems with show/hide javascripts
. created an "Agent Account" form
. fixed problems with Open Another Account
. PIN field now appears on Contact form ONLY if email changes
. on mobile, made messages absolute position. Any platform, click the message to dismiss it
. tell members they missed out on keeping their r (weekly) and give a clickable link to change their minimum to the suggested amount, without requiring signin
. fixed bug which made SCAN-only cashiers unable to sell (patched on production server)
. added an Undo tab (hidden except for mobile)
. settings gear omitted if no permission to manage account
. improved reports page drastically and renamed it "Statistics"
. started a separate rCredits-theme project (see) to accommodate Undo menu item on mobile interface

2013-09-02
. simplification of options when scanning a card; for example, never any "change acct" button on formI
. created form settings/ssn
. created form settings/kba
. "Not yet a member? <a>Check it out</a>!" on login
. members can scan their own card to sign in (just add pword)
. revised tests and usd class to use Dwolla sandbox effectively for testing
. added verification of AuthorizedRepresentative (for that Dwolla registration step of that name)
. passes all tests except Membership (tests need revision)

2013-08-30
. moved email (and email change) to contact form
. require pin instead of password, to change email
. moved password, pin, and photo change to their own pages, with links from security page
. fixed bug in misc.js that undid all check box clicks (patched on production server)
. added signout to account dropdown
. re-ordered settings categories
. changed w\go() to accept ordinary messages, not just errors
. renamed "Get r/USD" to "Bank"
. implemented bank addition and verification form
. bank form shows only last four digits of bank account number
. added committed amount to summary (on rewards line) "reserved for donations to CGF"
. fixed bug that hid charge tab for almost everyone
. implemented automatic phone, address, and ssn verification (for Dwolla account)
. fixed hiding of stuff on reg page as appropriate
. changed QR code format to allow longer cardcodes (expanded feature tests accordingly, to make sure old cards continue working)
- in formAccount did away with Drupal basis
- moved variable stuff from settings.php to boot.php
- improved forward.php to parse drupal messages and send html-formatted emails

2013-08-25
. fixed creditInfo() so it handles fee amounts properly (and displays right on Transactions page)
. fixed coverFee() so it creates a record in r_usd (and added missing reimbursements to production site)
. assured that summary page, transactions page, and downloads all show the same amounts
. fixed nextRBuyer bug (another bug) which mistakenly considered minimum balance (patched on production server)
. added an admin feature to cobble up a new account while waiting for the new dwolla reg api to be done
. system errors now email staff
. now gives error message if repeating the amount and other person as the previous transaction from same machine.
. fixed registration form javascript to show/hide fields depending on account type
. fixed coverFee bug (if Dwolla was unavailable, it queued the wrong function name) (patched on production server)
. fixed edit transaction purpose crash bug (patched on production server)
. adjusted settings.php, dwolla.php, and usd class to handle Dwolla sandbox self-signing certificate
. fixed tiny profile picture bug so user's photo now shows (patched on production server)
. eliminated tabs on login screen / separated registration and password change from dwolla builtin functions
. created new signup procedure, using Dwolla's new registration API (just the first step so far)
. changed calculator buttons to <button> and adjusted format to work on iPhones

2013-08-11
. fixed nextRBuyer bug, which chose the same member every time (patched on production server)
. fixed bankFollowup bug, which failed to mark transfers FROM bank completed (patched on production server and ran for each user, to fix data)
. shortened numeric keypad so it fits better on mobile screen (patched on production server)
. fixed bug that ran daily cron twice a day (patched on production server)
. fixed download bug (kept downloads from working at all)
. eliminated usdTid column in downloads
. everything uploaded to production server

2013-08-06
. changed "virtual payments" to "payment exchanges
. Changed maximum bank delay to 10 days.  Patched on production server. Fixes double bank withdrawal bug. 
. City and state zip code without using USPS API 
. Icons on settings page 

2013-07-29
- Option to use internal Dwolla sandbox (including changes to settings.php and dwolla.php)
- calculator for mobile amount entry
- simplified mobile header, menus, global links, and help
- fixed mobile formatting on Preferences page
- added addBank() and verifyBank() to usd class

2013-07-11
- scan permission
- popup help throughout Transaction History page
- handle lost USD deposits/withdrawals/fees
- monthly inflation adjustment (and tests)
- sharing rewards with CGF (and tests)

2013-07-05
- added optional box column to Transaction History
- changed companies field "id" to "uid" (for consistency)
- new password not required after "Request New Password" if user logs in with valid old

2013-07-04
- changed values of tx types (needs to be updated in production database)
- added "From Bank" and "Fees" to Transaction History
- all Dwolla fees will now be reimbursed by the community (unless reimbursed by Dwolla). This also fixes problems with accurate USD balance caching
- fixed bug in r\nextRBuyer() that prevented members from buying rCredits if they had transactions but had never traded USD for rCredits (patched on production server)